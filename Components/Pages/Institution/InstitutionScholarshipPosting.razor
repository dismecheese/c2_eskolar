@page "/dashboard/institution/scholarships/post"
@attribute [Authorize(Roles = "Institution,SuperAdmin")]
@layout Layout.InstitutionDashLayout

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using c2_eskolar.Data
@using c2_eskolar.Models
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Post Scholarship</PageTitle>


<style>
    .eskolar-bg {
        background: #f7f9fb;
        min-height: 100vh;
        padding-top: 40px;
        padding-bottom: 40px;
    }
    .eskolar-card {
        border-radius: 18px;
        box-shadow: 0 4px 24px 0 rgba(30, 34, 90, 0.10), 0 1.5px 6px 0 rgba(30, 34, 90, 0.06);
        border: none;
    }
    .eskolar-banner {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 4px 24px 0 rgba(30, 34, 90, 0.10), 0 1.5px 6px 0 rgba(30, 34, 90, 0.06);
        padding: 2.2rem 2rem 1.2rem 2rem;
        margin-bottom: 2.2rem;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }
    .eskolar-banner-title {
        display: flex;
        align-items: center;
        font-size: 2rem;
        font-weight: 700;
        color: #2563eb;
        margin-bottom: 0.3rem;
        gap: 0.7rem;
    }
    .eskolar-banner-icon {
        font-size: 2.2rem;
        color: #2563eb;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .eskolar-banner-desc {
        color: #64748b;
        font-size: 1.08rem;
        font-weight: 500;
        margin-bottom: 0.2rem;
        margin-left: 2.7rem;
    }
    .eskolar-section-title {
        font-size: 1.15rem;
        font-weight: 600;
        color: #fff;
        padding: 0.6rem 1.2rem;
        border-radius: 12px 12px 0 0;
    }
    .eskolar-badge {
        display: inline-block;
        padding: 0.25em 0.7em;
        font-size: 0.95em;
        font-weight: 600;
        border-radius: 8px;
        margin-right: 0.5em;
        margin-bottom: 0.2em;
    }
    .eskolar-badge-active { background: #2563eb; color: #fff; }
    .eskolar-badge-internal { background: #059669; color: #fff; }
    .eskolar-badge-warning { background: #f59e42; color: #fff; }
    .eskolar-btn {
        background: #2563eb;
        color: #fff;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1.1rem;
        padding: 0.7em 2.2em;
        border: none;
        box-shadow: 0 2px 8px 0 rgba(30, 34, 90, 0.08);
        transition: background 0.15s;
    }
    .eskolar-btn:hover, .eskolar-btn:focus {
        background: #1746a2;
        color: #fff;
    }

    .eskolar-card-container {
        width: 100%;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
        padding-left: 32px;
        padding-right: 32px;
        display: flex;
        flex-direction: column;
        align-items: stretch;
    }
    .eskolar-back-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: #fff;
        color: #2563eb;
        border: 1.5px solid #2563eb;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1.08rem;
        padding: 0.5em 1.3em;
        margin-bottom: 1.2rem;
        box-shadow: 0 1px 4px 0 rgba(30,34,90,0.04);
        transition: background 0.13s, color 0.13s, border 0.13s;
        cursor: pointer;
    }
    .eskolar-back-btn:hover, .eskolar-back-btn:focus {
        background: #2563eb;
        color: #fff;
        border-color: #1746a2;
        text-decoration: none;
    }
</style>

<div class="eskolar-bg d-flex justify-content-center align-items-start">
    <div class="eskolar-card-container">
        <button class="eskolar-back-btn" @onclick="GoBack">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path d="M9.707 15.707a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 111.414 1.414L6.414 9H17a1 1 0 110 2H6.414l3.293 3.293a1 1 0 010 1.414z"/></svg>
            Back
        </button>
        <div class="eskolar-card p-0" style="overflow:hidden;">
            <!-- Banner Title Card (now part of the main card) -->
            <div class="eskolar-banner" style="box-shadow:none; border-radius:18px 18px 0 0; margin-bottom:0; padding-bottom:1.2rem;">
                <div class="eskolar-banner-title">
                    <span class="eskolar-banner-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2c-.55 0-1 .45-1 1v2.07c-3.39.49-6 3.39-6 6.93 0 2.21 1.2 4.15 3 5.19V21c0 .55.45 1 1 1s1-.45 1-1v-2h2v2c0 .55.45 1 1 1s1-.45 1-1v-3.81c1.8-1.04 3-2.98 3-5.19 0-3.54-2.61-6.44-6-6.93V3c0-.55-.45-1-1-1zm0 6c2.21 0 4 1.79 4 4 0 1.3-.84 2.4-2 2.82V17h-4v-4.18C8.84 14.4 8 13.3 8 12c0-2.21 1.79-4 4-4z"/></svg>
                    </span>
                    Post a New Scholarship
                </div>
                <div class="eskolar-banner-desc">
                    Create and publish a new internal scholarship for your institution. Fill out the details below and post to make it available to your students.
                </div>
            </div>

            <div class="p-4 pt-0">
                @if (isSubmitted)
                {
                    <div class="alert alert-success mb-4" role="alert" aria-live="polite">
                        <span aria-hidden="true">✅</span> Scholarship posted successfully! Redirecting...
                    </div>
                }

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger mb-4" role="alert" aria-live="assertive">
                        <span aria-hidden="true">❌</span> <span class="visually-hidden">Error:</span> @errorMessage
                    </div>
                }

                <EditForm Model="@scholarship" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />

                    <!-- Section: Basic Info -->
                    <div class="mb-4">
                        <div class="eskolar-section-title" style="background:#2563eb; border-radius:12px 12px 0 0;">Basic Information</div>
                        <div class="card-body p-4 pb-2">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="title" class="form-label fw-semibold" style="font-size:1.1rem;">Title</label>
                                    <InputText id="title" class="form-control" @bind-Value="scholarship.Title" aria-required="true" required aria-label="Scholarship Title" placeholder="e.g. Academic Excellence Scholarship" />
                                    <ValidationMessage For="@(() => scholarship.Title)" class="text-danger small ms-1" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="benefits" class="form-label fw-semibold">Benefits</label>
                                    <InputText id="benefits" class="form-control" @bind-Value="scholarship.Benefits" aria-required="true" required aria-label="Benefits" placeholder="e.g. Full tuition, stipend, books" />
                                    <ValidationMessage For="@(() => scholarship.Benefits)" class="text-danger small ms-1" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="deadline" class="form-label fw-semibold">Application Deadline</label>
                                    <InputDate id="deadline" class="form-control" @bind-Value="scholarship.ApplicationDeadline" aria-required="true" required aria-label="Application Deadline" placeholder="Select deadline" />
                                    <ValidationMessage For="@(() => scholarship.ApplicationDeadline)" class="text-danger small ms-1" />
                                </div>
                                <div class="col-12">
                                    <label for="description" class="form-label fw-semibold">Description</label>
                                    <InputTextArea id="description" class="form-control" rows="3" @bind-Value="scholarship.Description" aria-required="true" required aria-label="Description" placeholder="Describe the scholarship, its purpose, and any special notes..." />
                                    <ValidationMessage For="@(() => scholarship.Description)" class="text-danger small ms-1" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Requirements -->
                    <div class="mb-4">
                        <div class="eskolar-section-title" style="background:#059669; border-radius:12px 12px 0 0;">Requirements</div>
                        <div class="card-body p-4 pb-2">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="requirements" class="form-label fw-semibold">Requirements</label>
                                    <InputTextArea id="requirements" class="form-control" rows="2" @bind-Value="scholarship.Requirements" aria-required="true" required aria-label="Requirements" placeholder="e.g. Must be a full-time student, leadership experience, etc." />
                                    <ValidationMessage For="@(() => scholarship.Requirements)" class="text-danger small ms-1" />
                                </div>
                                <div class="col-12 col-md-4">
                                    <label for="slots" class="form-label fw-semibold">Slots Available</label>
                                    <InputNumber id="slots" class="form-control" @bind-Value="scholarship.SlotsAvailable" aria-required="true" required aria-label="Slots Available" placeholder="e.g. 10" />
                                    <ValidationMessage For="@(() => scholarship.SlotsAvailable)" class="text-danger small ms-1" />
                                </div>
                                <div class="col-12 col-md-4">
                                    <label for="gpa" class="form-label fw-semibold">Minimum GPA</label>
                                    <InputNumber id="gpa" class="form-control" @bind-Value="scholarship.MinimumGPA" step="0.01" aria-required="true" required aria-label="Minimum GPA" placeholder="e.g. 3.50" />
                                    <ValidationMessage For="@(() => scholarship.MinimumGPA)" class="text-danger small ms-1" />
                                </div>
                                <div class="col-12 col-md-4">
                                    <label for="yearlevel" class="form-label fw-semibold">Required Year Level</label>
                                    <InputNumber id="yearlevel" class="form-control" @bind-Value="scholarship.RequiredYearLevel" aria-required="true" required aria-label="Required Year Level" placeholder="e.g. 2 (for 2nd year)" />
                                    <ValidationMessage For="@(() => scholarship.RequiredYearLevel)" class="text-danger small ms-1" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Eligibility -->
                    <div class="mb-4">
                        <div class="eskolar-section-title" style="background:#0ea5e9; border-radius:12px 12px 0 0;">Eligibility</div>
                        <div class="card-body p-4 pb-2">
                            <div class="row g-3">
                                <div class="col-12 col-md-6">
                                    <label for="course" class="form-label fw-semibold">Required Course</label>
                                    <InputText id="course" class="form-control" @bind-Value="scholarship.RequiredCourse" aria-required="true" required aria-label="Required Course" placeholder="e.g. BS Computer Science" />
                                    <ValidationMessage For="@(() => scholarship.RequiredCourse)" class="text-danger small ms-1" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="university" class="form-label fw-semibold">Required University</label>
                                    <InputText id="university" class="form-control" @bind-Value="scholarship.RequiredUniversity" aria-required="true" required aria-label="Required University" placeholder="e.g. University of the Philippines" />
                                    <ValidationMessage For="@(() => scholarship.RequiredUniversity)" class="text-danger small ms-1" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Settings -->
                    <div class="mb-4">
                        <div class="eskolar-section-title" style="background:#f59e42;color:#fff; border-radius:12px 12px 0 0;">Settings</div>
                        <div class="card-body p-4 pb-2">
                            <div class="row g-3 align-items-center">
                                <div class="col-12">
                                    <label for="externalurl" class="form-label fw-semibold">External Application URL <span class="text-muted">(optional)</span></label>
                                    <InputText id="externalurl" class="form-control" @bind-Value="scholarship.ExternalApplicationUrl" aria-label="External Application URL" placeholder="e.g. https://apply.example.com" />
                                    <ValidationMessage For="@(() => scholarship.ExternalApplicationUrl)" class="text-danger small ms-1" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Badges (Preview) -->
                    <div class="mb-4">
                        <span class="eskolar-badge eskolar-badge-active">Active</span>
                        <span class="eskolar-badge eskolar-badge-internal">Internal</span>
                    </div>

                    <button type="submit" class="eskolar-btn mt-2">
                        <i class="bi bi-plus-circle me-2"></i> Post Scholarship
                    </button>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private Scholarship scholarship = new()
    {
        Title = "",
        Benefits = "",
        ApplicationDeadline = DateTime.Today.AddMonths(1),
        IsActive = true,
        IsInternal = true
    };
    private bool isSubmitted = false;
    private string? errorMessage;


    private async Task HandleSubmit()
    {
        try
        {
            // ✅ Get the user's ID from Claims (NameIdentifier)
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var userId = user?.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(userId))
            {
                errorMessage = "Unable to identify logged-in user.";
                return;
            }

            // ✅ Look up the InstitutionProfile of the current user
            var institution = await DbContext.InstitutionProfiles
                .FirstOrDefaultAsync(p => p.UserId == userId);

            if (institution is null)
            {
                errorMessage = "No institution profile found for this user.";
                return;
            }


            // ✅ Assign foreign key and timestamps
            scholarship.InstitutionProfileId = institution.InstitutionProfileId;
            scholarship.CreatedAt = DateTime.Now;
            // ✅ Always mark as internal for Institution users
            scholarship.IsInternal = true;

            // ✅ Save to database
            DbContext.Scholarships.Add(scholarship);
            await DbContext.SaveChangesAsync();

            isSubmitted = true;

            await Task.Delay(1500);
            Navigation.NavigateTo("/dashboard/institution/scholarships");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            errorMessage = "An error occurred while posting the scholarship.";
        }
    }

    [Inject] private IJSRuntime? JS { get; set; }
    private async Task GoBack()
    {
        if (JS != null)
        {
            await JS.InvokeVoidAsync("window.history.back");
        }
    }
}
