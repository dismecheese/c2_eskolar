@page "/signup"
@rendermode InteractiveServer
@using c2_eskolar.Models.ViewModels
@using c2_eskolar.Models.Enums
@using c2_eskolar.Services
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Signup</PageTitle>

<!-- SIGNUP CONTAINER -->
<div class="signup-container">
    <div class="signup-card">

        <!-- LEFT SIDE: ROLE SELECTION -->
        <div class="signup-left">
            <h2>Welcome to eSkolar!</h2>
            <p class="role-label">Please select your role:</p>

            <div class="role-options-wrapper">
                <div class="role-options">
                    <!-- Student role -->
                    <label class="role-option">
                        <input type="radio" name="role" value="@UserRole.Student" 
                               @onchange="@(() => OnRoleChanged(UserRole.Student))" 
                               checked="@(registerModel.UserRole == UserRole.Student)" />
                        <span>Student</span>
                    </label>

                    <!-- Institution role -->
                    <label class="role-option">
                        <input type="radio" name="role" value="@UserRole.Institution" 
                               @onchange="@(() => OnRoleChanged(UserRole.Institution))"
                               checked="@(registerModel.UserRole == UserRole.Institution)" />
                        <span>Institution</span>
                    </label>

                    <!-- Benefactor role -->
                    <label class="role-option">
                        <input type="radio" name="role" value="@UserRole.Benefactor" 
                               @onchange="@(() => OnRoleChanged(UserRole.Benefactor))"
                               checked="@(registerModel.UserRole == UserRole.Benefactor)" />
                        <span>Benefactor</span>
                    </label>
                </div>

                @if (registerModel.UserRole == UserRole.Institution || registerModel.UserRole == UserRole.Benefactor)
                {
                    <div class="institution-note">
                        <span class="info-icon" aria-label="Info">
                            <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 5px;"><circle cx="10" cy="10" r="9" stroke="#fff" stroke-width="2" fill="none"/><rect x="9" y="8" width="2" height="6" rx="1" fill="#fff"/><rect x="9" y="5" width="2" height="2" rx="1" fill="#fff"/></svg>
                        </span>
                        <span>Only official organizational email addresses are eligible for registration.</span>
                    </div>
                }
            </div>
        </div>

         <!-- RIGHT SIDE: SIGNUP FORM -->
        <div class="signup-right">
            <h3>Create an Account</h3>
            
            <!-- Error message -->
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="signup-error">
                    @errorMessage
                </div>
            }

             <!-- Success message -->
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="signup-success">
                    @successMessage
                </div>
            }

             <!-- SIGNUP FORM -->
            <EditForm EditContext="@editContext" OnValidSubmit="@HandleRegistration" FormName="SignupForm">
                <DataAnnotationsValidator />
                <AntiforgeryToken />
                <!-- First name -->
                <div class="form-group">
                    <input class="signup-input" type="text" placeholder="First Name" 
                        @bind="registerModel.FirstName" />
                    <ValidationMessage For="@(() => registerModel.FirstName)" />
                </div>
                <!-- Last name -->
                <div class="form-group">
                    <input class="signup-input" type="text" placeholder="Last Name" 
                        @bind="registerModel.LastName" />
                    <ValidationMessage For="@(() => registerModel.LastName)" />
                </div>
                <!-- Email -->
                <div class="form-group">
                    <input class="signup-input" type="email" placeholder="Email Address" 
                        @bind="registerModel.Email" />
                    <ValidationMessage For="@(() => registerModel.Email)" />
                </div>
                <!-- Password with toggle -->
                <div class="form-group">
                    <div class="password-wrapper">
                        <input class="signup-input @(IsPasswordAllValid ? "pw-valid" : (registerModel.Password?.Length > 0 ? "pw-invalid" : ""))"
                            type="@(showPassword ? "text" : "password")"
                            placeholder="Password" 
                            @bind="registerModel.Password"
                            @oninput="OnPasswordInput" />
                        <button type="button" class="password-toggle" @onclick="TogglePassword">
                            <img src="@(showPassword ? "/images/eye.svg" : "/images/eyeX.svg")" 
                                alt="@(showPassword ? "Hide password" : "Show password")" />
                        </button>
                    </div>
                    <div class="password-hint">
                        Password must be at least 6 characters, contain at least one digit and one uppercase letter.
                    </div>
                    <ValidationMessage For="@(() => registerModel.Password)" />
                </div>
                <!-- Terms and conditions -->
                <label class="terms-label">
                    <input type="checkbox" @bind="registerModel.AgreeToTerms" />
                    <span>
                        I agree to the
                        <a href="/terms-and-conditions" target="_blank" rel="noopener noreferrer">Terms &amp; Conditions</a>
                    </span>
                </label>
                <!-- Submit button -->
                <button type="submit" class="btn btn-primary signup-btn" disabled="@(!registerModel.AgreeToTerms || isLoading)">
                    @if (isLoading)
                    {
                        <span>Creating Account...</span>
                    }
                    else
                    {
                        <span>Sign up</span>
                    }
                </button>
            </EditForm>
                
            <!-- Link to login -->
            <div class="signup-link">
                <p>Already have an account? <a href="/login" class="signup-link-a">Sign in</a></p>
            </div>
        </div>
    </div>
</div>

@code {
    // Registration model bound to the form
    private RegisterViewModel registerModel = new();
    private EditContext editContext;
    
    // Toggle password visibility
    private bool showPassword = false;
    // Track loading state
    private bool isLoading = false;
    // Store error messages
    private string errorMessage = string.Empty;
    // Store success messages
    private string successMessage = string.Empty;

    // Live password requirement flags
    private bool IsPasswordLengthValid => registerModel.Password?.Length >= 6;
    private bool IsPasswordDigitValid => !string.IsNullOrEmpty(registerModel.Password) && registerModel.Password.Any(char.IsDigit);
    private bool IsPasswordUpperValid => !string.IsNullOrEmpty(registerModel.Password) && registerModel.Password.Any(char.IsUpper);
    private bool IsPasswordAllValid => IsPasswordLengthValid && IsPasswordDigitValid && IsPasswordUpperValid;

    protected override void OnInitialized()
    {
        // Default role is Student
        registerModel.UserRole = UserRole.Student;
        editContext = new EditContext(registerModel);
    }

    // Called on every password input
    private void OnPasswordInput(ChangeEventArgs e)
    {
        registerModel.Password = e.Value?.ToString() ?? string.Empty;
        // Trigger UI update for live feedback
        StateHasChanged();
    }

    // Method to clear all input fields except UserRole
    private void ClearRegisterModelFields()
    {
        registerModel.FirstName = string.Empty;
        registerModel.LastName = string.Empty;
        registerModel.Email = string.Empty;
        registerModel.Password = string.Empty;
        registerModel.AgreeToTerms = false;
        // Add any other fields that should be cleared here
    }

    // Called when the user changes role
    private void OnRoleChanged(UserRole newRole)
    {
        if (registerModel.UserRole != newRole)
        {
            ClearRegisterModelFields();
            registerModel.UserRole = newRole;
            errorMessage = string.Empty;
            successMessage = string.Empty;
            // Reset validation state so built-in validation messages are cleared
            editContext = new EditContext(registerModel);
            StateHasChanged();
        }
    }

    // Toggle password visibility
    private void TogglePassword()
    {
        showPassword = !showPassword;
    }

    // Handle form submission
    private async Task HandleRegistration()
    {
        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            successMessage = string.Empty;

            // Call authentication service to register user
            var result = await AuthService.RegisterAsync(registerModel);

            if (result.Succeeded)
            {
                successMessage = "Account created successfully! Redirecting to login...";

                // Redirect to login page after 2 seconds
                await Task.Delay(2000);
                Navigation.NavigateTo("/login");
            }
            else
            {
                // Show errors from registration attempt
                errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            // Catch unexpected errors
            errorMessage = $"An error occurred during registration: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}