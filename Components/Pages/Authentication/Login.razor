@page "/login"
@rendermode InteractiveServer
@using c2_eskolar.Models.ViewModels

<PageTitle>Login</PageTitle>

<div class="login-container">
    <div class="login-card">
        <!-- Left panel: welcome text and logo -->
        <div class="login-left">
            <h2>Welcome Back!</h2>
            <img src="/images/eSkolarLight.svg" alt="eSkolar Logo" class="login-logo" />
        </div>

        <!-- Right panel: login form -->
        <div class="login-right">
            <h3>Sign In to Your Account</h3>

        <!-- Error message display -->    
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="login-error">
                @errorMessage
            </div>
        }

        <!-- Success message display -->    
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="login-success">
                @successMessage
            </div>
        }

            <!-- Login form -->
            <form method="post" action="/api/auth/login">
                <!-- Email input -->
                <input class="login-input" type="email" name="email" placeholder="Email Address" 
                       value="@loginModel.Email" required />
                
                <!-- Password input with toggle -->
                <div class="password-wrapper">
                    <input class="login-input"
                           type="@(showPassword ? "text" : "password")"
                           name="password"
                           placeholder="Password" 
                           value="@loginModel.Password" required />
                    <!-- Show/Hide password button -->
                    <button type="button" class="password-toggle" @onclick="TogglePassword">
                        <img src="@(showPassword ? "/images/eye.svg" : "/images/eyeX.svg")" 
                             alt="@(showPassword ? "Hide password" : "Show password")" />
                    </button>
                </div>
                
                <!-- Forgot password link -->
                <div class="forgot-password">
                    <a href="/forgot-password" class="forgot-link">Forgot Password?</a>
                </div>
                
                <!-- Remember me checkbox -->
                <label class="login-checkbox-label">
                    <input type="checkbox" name="remember" value="true" @bind="loginModel.RememberMe" />
                    <span>Remember me</span>
                </label>
                
                <!-- Submit button -->
                <button type="submit" class="btn btn-primary login-btn" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span>Signing In...</span>
                    }
                    else
                    {
                        <span>Sign In</span>
                    }
                </button>
                
            </form>
            
            <!-- Signup redirect -->
            <div class="signup-link">
                <p>Don't have an account? <a href="/signup">Sign up</a></p>
            </div>
        </div>
    </div>
</div>

@code {
    // Gets error message from query string
    [SupplyParameterFromQuery] public string Error { get; set; } = string.Empty;
    
    // Form model for login
    private LoginViewModel loginModel { get; set; } = new();
    
    // State variables
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = false;
    private bool showPassword = false;

    // Runs when the page loads
    protected override void OnInitialized()
    {
        // Handle error messages from query string
        if (!string.IsNullOrEmpty(Error))
        {
            errorMessage = Error switch
            {
                "invalid" => "Invalid login attempt.",
                "failed" => "Login failed. Please try again.",
                "exception" => "An error occurred during login.",
                _ => Error // Use the actual error message from the controller
            };
        }
    }

    // Toggle password visibility
    private void TogglePassword()
    {
        showPassword = !showPassword;
    }
}