@page "/dashboard/benefactor/announcements"
@attribute [Authorize(Roles = "Benefactor,SuperAdmin")]
@layout Layout.BenefactorDashLayout
@rendermode InteractiveServer
@using c2_eskolar.Models
@using c2_eskolar.Models.Enums
@using c2_eskolar.Services
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@inject AnnouncementService AnnouncementService
@inject UserManager<IdentityUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject BlobStorageService BlobStorageService
@inject IJSRuntime JS

<PageTitle>Announcements</PageTitle>

<div class="container-fluid" style="min-height: 100vh;">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">

            <!-- SEARCH BAR + CREATE BUTTON -->
            <div class="search-header-section d-flex flex-column flex-md-row align-items-md-center mb-4 gap-3 mt-5">
                <div class="flex-grow-1">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search announcements..." 
                               @bind="searchTerm" @oninput="OnSearchChanged" />
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                    </div>
                </div>

                <!-- Create new announcement -->
                <button class="btn btn-custom-primary d-flex align-items-center gap-2" @onclick="ShowCreateForm">
                    <i class="bi bi-plus-circle"></i>
                    <span>Create Announcement</span>
                </button>
            </div>

            <!-- CATEGORY TABS + FILTER DROPDOWN -->
            <div class="modern-tabs d-flex align-items-center mb-4 gap-3">
                <div class="tab-pills">
                    <button class="tab-pill @(activeTab == "all" ? "active" : "")" @onclick='() => SetActiveTab("all")'>
                        <i class="bi bi-collection"></i> <span>All</span>
                    </button>
                    <button class="tab-pill @(activeTab == "institution" ? "active" : "")" @onclick='() => SetActiveTab("institution")'>
                        <i class="bi bi-building"></i> <span>Institution</span>
                    </button>
                    <button class="tab-pill @(activeTab == "benefactor" ? "active" : "")" @onclick='() => SetActiveTab("benefactor")'>
                        <i class="bi bi-award"></i> <span>Benefactor</span>
                    </button>
                    <button class="tab-pill @(activeTab == "mine" ? "active" : "")" @onclick='() => SetActiveTab("mine")'>
                        <i class="bi bi-person-circle"></i> <span>My Posts</span>
                    </button>
                </div>

                <!-- Category filter -->
                <div class="ms-auto">
                    <select class="form-select form-select-sm" @bind="selectedCategory">
                        <option value="">All Categories</option>
                        <option value="Requirements">Requirements</option>
                        <option value="Results">Results</option>
                        <option value="Events">Events</option>
                        <option value="General">General</option>
                    </select>
                </div>
            </div>
            
            <div class="row">
                <!-- ANNOUNCEMENTS LIST -->
                <div class="col-lg-9">
                    @if (isLoading)
                    {
                        <!-- Loading state -->
                        <div class="d-flex justify-content-center py-5">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (filteredAnnouncements?.Any() == true)
                    {
                        <!-- Tab description -->
                        <div class="mb-3">
                            <p class="text-muted mb-0" style="font-size: 0.9rem;">@GetTabDescription()</p>
                        </div>
                        <!-- List of announcement cards -->
                        <div class="d-flex flex-column gap-3">
                            @foreach (var announcement in filteredAnnouncements.OrderByDescending(a => a.IsPinned).ThenByDescending(a => a.CreatedAt))
                            {
                                <div class="card shadow-sm border-0 @(announcement.IsPinned ? "border-warning border-2" : "")">
                                    <div class="card-body">
                                        <!-- Header with badges and date -->
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="d-flex gap-2 flex-wrap">
                                                @if (announcement.IsPinned)
                                                {
                                                    <span class="badge badge-pinned">
                                                        <i class="bi bi-pin-fill"></i> Pinned
                                                    </span>
                                                }
                                                <span class="badge @(announcement.AuthorType == UserRole.Institution ? "badge-institution" : announcement.AuthorType == UserRole.Benefactor ? "badge-benefactor" : "badge-normal")">
                                                    @announcement.AuthorType
                                                </span>
                                                @if (!string.IsNullOrEmpty(announcement.Category))
                                                {
                                                    <span class="badge @GetCategoryBadgeClass(announcement.Category)">@announcement.Category</span>
                                                }
                                                <span class="badge @GetPriorityBadgeClass(announcement.Priority)">
                                                    @announcement.Priority
                                                </span>
                                                @if (announcement.Photos?.Any() == true)
                                                {
                                                    <span class="badge bg-light text-dark">
                                                        <i class="bi bi-image"></i> @announcement.Photos.Count
                                                    </span>
                                                }
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                <small class="text-muted">@announcement.CreatedAt.ToString("MMM dd, yyyy")</small>
                                                <!-- Expand/Collapse toggle -->
                                                <button class="modern-expand-btn @(IsAnnouncementExpanded(announcement.AnnouncementId) ? "expanded" : "")" 
                                                        @onclick="() => ToggleAnnouncementExpansion(announcement.AnnouncementId)"
                                                        @onclick:stopPropagation="true"
                                                        title="@(IsAnnouncementExpanded(announcement.AnnouncementId) ? "Show less" : "Show more")">
                                                    <i class="bi bi-chevron-down"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Content section -->
                                        <div class="d-flex align-items-start gap-3">
                                            <div class="flex-grow-1">
                                                <!-- Title clickable -->
                                                <div class="announcement-title cursor-pointer" @onclick="() => IncrementView(announcement.AnnouncementId)">
                                                    @announcement.Title.ToUpper()
                                                </div>
                                                
                                                <!-- Preview text (always visible) -->
                                                <div class="text-secondary mb-2">
                                                    @(announcement.Summary ?? 
                                                      (announcement.Content.Length > 150 ? 
                                                       announcement.Content.Substring(0, 150) + "..." : 
                                                       announcement.Content))
                                                </div>

                                                <!-- Images Display -->
                                                @if (announcement.Photos?.Any() == true)
                                                {
                                                    <div class="mb-3">
                                                        <div class="row g-2">
                                                            @foreach (var photo in announcement.Photos)
                                                            {
                                                                <div class="col-6 col-sm-4 col-md-3">
                                                                    <div class="position-relative">
                                                                        <img src="@GetSafePhotoUrl(photo.Url)" alt="@(photo.Caption ?? "Announcement image")" class="img-fluid rounded" style="height: 100px; width: 100%; object-fit: cover;" />
                                                                        @if (!string.IsNullOrEmpty(photo.Caption))
                                                                        {
                                                                            <div class="small text-muted text-center mt-1">@photo.Caption</div>
                                                                        }
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                }

                                                <!-- Collapsible Details -->
                                                @if (IsAnnouncementExpanded(announcement.AnnouncementId))
                                                {
                                                    <div class="announcement-details border-top pt-3 mt-2">
                                                        <!-- Full Content -->
                                                        @if (!string.IsNullOrEmpty(announcement.Content))
                                                        {
                                                            <div class="mb-3">
                                                                <h6 class="fw-bold">Full Description:</h6>
                                                                <div class="text-secondary">@announcement.Content</div>
                                                            </div>
                                                        }

                                                        <!-- All Photos Gallery in Expanded View -->
                                                        @if (announcement.Photos?.Any() == true)
                                                        {
                                                            <div class="mb-3">
                                                                <h6 class="fw-bold">Photos (@announcement.Photos.Count)</h6>
                                                                <div class="row g-2">
                                                                    @foreach (var photo in announcement.Photos)
                                                                    {
                                                                        <div class="col-md-4 col-sm-6">
                                                                            <div class="position-relative">
                                                                                <img src="@GetSafePhotoUrl(photo.Url)" 
                                                                                     class="img-fluid rounded w-100" 
                                                                                     style="height: 200px; object-fit: cover; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer;"
                                                                                     alt="@(photo.Caption ?? "Announcement image")"
                                                                                     loading="lazy" />
                                                                                
                                                                                @if (!string.IsNullOrEmpty(photo.Caption))
                                                                                {
                                                                                    <div class="position-absolute bottom-0 start-0 end-0 p-2 text-white text-center small"
                                                                                         style="background: linear-gradient(transparent, rgba(0,0,0,0.8)); border-radius: 0 0 8px 8px;">
                                                                                        @photo.Caption
                                                                                    </div>
                                                                                }
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                </div>
                                                            </div>
                                                        }

                                                        <!-- Additional Details -->
                                                        <div class="row">
                                                            @if (!string.IsNullOrEmpty(announcement.OrganizationName))
                                                            {
                                                                <div class="col-md-6 mb-2">
                                                                    <small class="text-muted">Organization:</small>
                                                                    <div class="fw-semibold">@announcement.OrganizationName</div>
                                                                </div>
                                                            }
                                                            @if (announcement.ExpiryDate.HasValue)
                                                            {
                                                                <div class="col-md-6 mb-2">
                                                                    <small class="text-muted">Deadline:</small>
                                                                    <div class="fw-semibold">@announcement.ExpiryDate.Value.ToString("MMM dd, yyyy")</div>
                                                                </div>
                                                            }
                                                            <div class="col-md-6 mb-2">
                                                                <small class="text-muted">Visibility:</small>
                                                                <div class="fw-semibold">@(announcement.IsPublic ? "Public" : "Private")</div>
                                                            </div>
                                                            <div class="col-md-6 mb-2">
                                                                <small class="text-muted">Status:</small>
                                                                <div class="fw-semibold">@(announcement.IsActive ? "Active" : "Inactive")</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                
                                                <!-- Footer with views + management actions -->
                                                <div class="mt-2 d-flex justify-content-between align-items-center">
                                                    <small class="text-muted">
                                                        <i class="bi bi-eye"></i> @announcement.ViewCount views
                                                        • By @announcement.AuthorName
                                                    </small>
                                                    
                                                     <!-- Edit/Delete/Pin buttons for owner -->
                                                    @if (announcement.AuthorId == currentUserId)
                                                    {
                                                        <div class="modern-action-buttons">
                                                            <button class="modern-action-btn edit" 
                                                                    @onclick="() => EditAnnouncement(announcement)" 
                                                                    @onclick:stopPropagation="true" 
                                                                    title="Edit announcement">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                            <button class="modern-action-btn pin @(announcement.IsPinned ? "pinned" : "")" 
                                                                    @onclick="() => TogglePin(announcement.AnnouncementId)" 
                                                                    @onclick:stopPropagation="true" 
                                                                    title="@(announcement.IsPinned ? "Unpin announcement" : "Pin announcement")">
                                                                <i class="bi bi-pin@(announcement.IsPinned ? "-fill" : "")"></i>
                                                            </button>
                                                            <button class="modern-action-btn delete" 
                                                                    @onclick="() => DeleteAnnouncement(announcement.AnnouncementId)" 
                                                                    @onclick:stopPropagation="true" 
                                                                    title="Delete announcement">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- EMPTY STATE -->
                        <div class="empty-state">
                            <i class="bi bi-megaphone empty-icon"></i>
                            <h5>@GetEmptyStateTitle()</h5>
                            <p>@GetEmptyStateMessage()</p>
                            @if (!string.IsNullOrEmpty(searchTerm) || !string.IsNullOrEmpty(selectedCategory))
                            {
                                <button class="btn btn-custom-outline btn-sm me-2" @onclick="ClearFilters">
                                    Clear Filters
                                </button>
                            }
                            @if (activeTab == "mine" || activeTab == "all")
                            {
                                <button class="btn btn-custom-primary mt-2" @onclick="ShowCreateForm">
                                    <i class="bi bi-plus-circle"></i> Create Your First Announcement
                                </button>
                            }
                        </div>
                    }
                </div>

                <!-- STATISTICS SIDEBAR -->
                <div class="col-lg-3 mt-4 mt-lg-0">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <div class="fw-bold mb-3">Statistics</div>
                            <div class="list-group list-group-flush">

                                <!-- Totals by category -->
                                <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                    <span>Total Announcements</span>
                                    <span class="badge badge-normal">@(announcements?.Count ?? 0)</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                    <span>From Institutions</span>
                                    <span class="badge badge-institution">@institutionCount</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                    <span>From Benefactors</span>
                                    <span class="badge badge-benefactor">@benefactorCount</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                    <span>My Posts</span>
                                    <span class="badge badge-custom-gradient">@myPostsCount</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                                    <span>Pinned</span>
                                    <span class="badge badge-pinned">@pinnedCount</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CREATE/EDIT MODAL -->
@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" @onclick="CloseCalendarIfOpen">
        <div class="modal-dialog modal-xl modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content modern-modal">
                <!-- Modal header -->
                <div class="modal-header modern-modal-header" style="position: relative;">
                    <h5 class="modal-title">@(editingAnnouncement?.AnnouncementId != Guid.Empty ? "Edit" : "Create") Announcement</h5>
                    <button type="button" class="modern-modal-x" @onclick="HideModal" aria-label="Close" style="position: absolute; top: 18px; right: 24px; background: none; border: none; font-size: 2rem; color: #fff; z-index: 10; cursor: pointer;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body modern-modal-body">
                    <!-- EditForm for creating/updating announcements -->
                    <EditForm Model="editingAnnouncement" OnValidSubmit="SaveAnnouncement">
                        <DataAnnotationsValidator />
                        
                        <!-- Title -->
                        <div class="modern-form-group">
                            <label class="modern-form-label">Title</label>
                                <InputText @bind-Value="editingAnnouncement!.Title" class="force-premium-input modern-input" placeholder="Enter announcement title..." />
                            <ValidationMessage For="@(() => editingAnnouncement!.Title)" />
                        </div>

                        <!-- Organization -->
                        <div class="modern-form-group">
                            <label class="modern-form-label">Institution/Organization</label>
                                <InputText @bind-Value="editingAnnouncement.OrganizationName" class="force-premium-input modern-input" placeholder="e.g., ABC Foundation" />
                            <small class="text-muted">Name of your institution or organization</small>
                        </div>

                        <!-- Category & Priority (Side by Side) -->
                        <div class="row modern-form-group">
                            <div class="col-md-6">
                                <label class="modern-form-label">Category</label>
                                <InputSelect @bind-Value="editingAnnouncement.Category" class="force-premium-input modern-input">
                                    <option value="">Select Category</option>
                                    <option value="Requirements">Requirements</option>
                                    <option value="Results">Results</option>
                                    <option value="Events">Events</option>
                                    <option value="General">General</option>
                                </InputSelect>
                            </div>
                            <div class="col-md-6">
                                <label class="modern-form-label">Priority</label>
                                <InputSelect @bind-Value="editingAnnouncement.Priority" class="force-premium-input modern-input">
                                    <option value="@AnnouncementPriority.Low">Low</option>
                                    <option value="@AnnouncementPriority.Normal">Normal</option>
                                    <option value="@AnnouncementPriority.High">High</option>
                                    <option value="@AnnouncementPriority.Urgent">Urgent</option>
                                </InputSelect>
                            </div>
                        </div>

                        <!-- Tagline -->
                        <div class="modern-form-group">
                            <label class="modern-form-label">Tagline</label>
                            <InputText @bind-Value="editingAnnouncement.Summary" class="force-premium-input modern-input" placeholder="A catchy tagline for your announcement..." />
                            <small class="modern-form-text">A short, engaging phrase that captures the essence of your announcement</small>
                        </div>

                        <!-- Image Upload Section -->
                        <div class="mb-4">
                            <label class="form-label">Images (Optional)</label>
                            <div class="upload-area" style="border: 2px dashed #dee2e6; border-radius: 12px; padding: 2rem; text-align: center; background: #f8f9fa;">
                                <InputFile OnChange="OnImageSelected"
                                         multiple
                                         accept="image/*"
                                         class="d-none"
                                         id="imageUpload" />
                                <label for="imageUpload" class="upload-label" style="cursor: pointer; margin: 0;">
                                    <i class="bi bi-cloud-upload fs-1 text-primary mb-3 d-block"></i>
                                    <div>
                                        <strong>Click to upload images</strong> or drag and drop
                                        <div class="text-muted mt-1">PNG, JPG, GIF, WebP up to 10MB each (max 5 images)</div>
                                    </div>
                                </label>
                            </div>

                            @if (isUploadingImages)
                            {
                                <div class="upload-progress mt-3">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        <span>Uploading images...</span>
                                    </div>
                                    @foreach (var progress in uploadProgress)
                                    {
                                        <div class="progress mt-2" style="height: 4px;">
                                            <div class="progress-bar" role="progressbar" style="width: @(progress.Value)%"></div>
                                        </div>
                                        <small class="text-muted">@progress.Key - @progress.Value%</small>
                                    }
                                </div>
                            }

                            <!-- Selected Images Preview -->
                            @if (selectedImages.Any() || existingPhotos.Any())
                            {
                                <div class="image-previews mt-3">
                                    <div class="row g-2">
                                        <!-- Existing Photos -->
                                        @foreach (var photo in existingPhotos)
                                        {
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="position-relative">
                                                    <img src="@photo.Url" alt="Preview" class="img-fluid rounded" style="height: 100px; width: 100%; object-fit: cover;" />
                                                    <button type="button"
                                                            class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1"
                                                            style="width: 24px; height: 24px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content-center;"
                                                            @onclick="() => RemoveExistingPhoto(photo.PhotoId)"
                                                            @onclick:stopPropagation="true">
                                                        <i class="bi bi-x" style="font-size: 0.8rem;"></i>
                                                    </button>
                                                    @if (!string.IsNullOrEmpty(photo.Caption))
                                                    {
                                                        <div class="small text-muted text-center mt-1">@photo.Caption</div>
                                                    }
                                                </div>
                                            </div>
                                        }

                                        <!-- New Selected Images -->
                                        @foreach (var (image, index) in selectedImages.Select((img, i) => (img, i)))
                                        {
                                            <div class="col-6 col-sm-4 col-md-3">
                                                <div class="position-relative">
                                                    <div class="border rounded d-flex align-items-center justify-content-center bg-light" style="height: 100px; width: 100%;">
                                                        <div class="text-center">
                                                            <i class="bi bi-image fs-4 text-muted"></i>
                                                            <div class="small text-muted mt-1">@image.Name</div>
                                                        </div>
                                                    </div>
                                                    <button type="button"
                                                            class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1"
                                                            style="width: 24px; height: 24px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content-center;"
                                                            @onclick="() => RemoveImage(image)"
                                                            @onclick:stopPropagation="true">
                                                        <i class="bi bi-x" style="font-size: 0.8rem;"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Description -->
                        <div class="modern-form-group">
                            <label class="modern-form-label">Description</label>
                                <InputTextArea @bind-Value="editingAnnouncement.Content" class="force-premium-input modern-input" rows="6" placeholder="Enter detailed description..." />
                            <ValidationMessage For="@(() => editingAnnouncement.Content)" />
                        </div>

                        <!-- Deadline with Custom Calendar -->
                        <div class="modern-form-group">
                            <label class="modern-form-label">Deadline (Optional)</label>
                            <div class="custom-date-input-container">
                                <InputText @bind-Value="deadlineText" class="force-premium-input modern-input deadline-input" placeholder="mm/dd/yyyy" />
                                <button type="button" class="calendar-trigger-btn" @onclick="ToggleCalendar" @onclick:stopPropagation="true">
                                    <i class="bi bi-calendar3"></i>
                                </button>
                                
                                @if (showCalendarDropdown)
                                {
                                    <div class="custom-calendar-dropdown" @onclick:stopPropagation="true">
                                        <div class="calendar-header">
                                            <button type="button" class="calendar-nav-btn" @onclick="PreviousMonth">
                                                <i class="bi bi-chevron-left"></i>
                                            </button>
                                            <div class="calendar-controls">
                                                <select class="calendar-month-select" @onchange="OnMonthChanged" value="@calendarDisplayDate.Month">
                                                    @for (int month = 1; month <= 12; month++)
                                                    {
                                                        <option value="@month">@(new DateTime(2000, month, 1).ToString("MMM"))</option>
                                                    }
                                                </select>
                                                <select class="calendar-year-select" @onchange="OnYearChanged" value="@calendarDisplayDate.Year">
                                                    @for (int year = DateTime.Now.Year - 10; year <= DateTime.Now.Year + 10; year++)
                                                    {
                                                        <option value="@year">@year</option>
                                                    }
                                                </select>
                                            </div>
                                            <button type="button" class="calendar-nav-btn" @onclick="NextMonth">
                                                <i class="bi bi-chevron-right"></i>
                                            </button>
                                        </div>
                                        
                                        <div class="calendar-grid">
                                            <div class="calendar-weekdays">
                                                <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                                            </div>
                                            
                                            <div class="calendar-days">
                                                @foreach (var day in GetCalendarDays())
                                                {
                                                    <button type="button" 
                                                            class="calendar-day @(day.IsCurrentMonth ? "" : "other-month") @(day.IsToday ? "today" : "") @(day.IsSelected ? "selected" : "")"
                                                            @onclick="() => SelectDate(day.Date)"
                                                            disabled="@(!day.IsCurrentMonth)">
                                                        @day.Day
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                        
                                        <div class="calendar-footer">
                                            <button type="button" class="calendar-clear-btn" @onclick="ClearDate">Clear</button>
                                            <button type="button" class="calendar-today-btn" @onclick="SelectToday">Today</button>
                                        </div>
                                    </div>
                                }
                            </div>
                            <small class="modern-form-text">Enter deadline date (e.g., 12/31/2024) or click calendar to select</small>
                        </div>

                        <!-- Visibility -->
                        <div class="modern-form-group">
                            <label class="modern-form-label">Visibility</label>
                            <div class="modern-radio-group">
                                <InputRadioGroup @bind-Value="editingAnnouncement.IsPublic" Name="visibility">
                                    <div class="modern-radio-item @(editingAnnouncement.IsPublic == true ? "selected" : "")" @onclick="() => { editingAnnouncement.IsPublic = true; StateHasChanged(); }">
                                        <InputRadio Value="true" class="modern-radio-input" id="public-radio" />
                                        <label class="modern-radio-label" for="public-radio">
                                            <i class="bi bi-globe"></i>
                                            <div>
                                                <strong>Public</strong>
                                                <span>Visible to all students</span>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="modern-radio-item @(editingAnnouncement.IsPublic == false ? "selected" : "")" @onclick="() => { editingAnnouncement.IsPublic = false; StateHasChanged(); }">
                                        <InputRadio Value="false" class="modern-radio-input" id="private-radio" />
                                        <label class="modern-radio-label" for="private-radio">
                                            <i class="bi bi-lock"></i>
                                            <div>
                                                <strong>Private</strong>
                                                <span>Visible to specific audience only</span>
                                            </div>
                                        </label>
                                    </div>
                                </InputRadioGroup>
                            </div>
                        </div>

                        <!-- Pin option -->
                        <div class="modern-form-group">
                            <div class="modern-checkbox-item @(editingAnnouncement.IsPinned ? "selected" : "")" @onclick="() => { editingAnnouncement.IsPinned = !editingAnnouncement.IsPinned; StateHasChanged(); }">
                                <InputCheckbox @bind-Value="editingAnnouncement.IsPinned" class="modern-checkbox-input" id="pin-checkbox" />
                                <label class="modern-checkbox-label" for="pin-checkbox">
                                    <i class="bi bi-pin-fill"></i>
                                    <div>
                                        <strong>Pin this announcement</strong>
                                        <span>Appears at the top of the list</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Footer buttons -->
                        <div class="modern-modal-footer">
                            <button type="button" class="btn-modern-secondary" @onclick="HideModal">
                                <i class="bi bi-x-circle"></i>
                                Cancel
                            </button>
                            <button type="submit" class="btn-modern-primary" disabled="@(isLoadingModal || isUploadingImages || uploadProgress.Any())">
                                @if (isLoadingModal || isUploadingImages)
                                {
                                    <div class="modern-spinner"></div>
                                }
                                else
                                {
                                    <i class="bi bi-@(editingAnnouncement?.AnnouncementId != Guid.Empty ? "pencil" : "plus-circle")"></i>
                                }
                                @if (isUploadingImages)
                                {
                                    <span>Uploading Images...</span>
                                }
                                else
                                {
                                    <span>@(editingAnnouncement?.AnnouncementId != Guid.Empty ? "Update" : "Create")</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<!-- BACKEND LOGIC -->
<!-- Photo measurer script: sets CSS vars (--aspect, --bg) for single-photo containers. Added safely once here. -->
<script defer src="/js/photo-measurer.js"></script>

<!-- Photo viewer modal -->
@if (_photoViewerOpen)
{
    <div class="photo-viewer-backdrop @( _viewerClosing ? "closing" : "")" tabindex="0" @onkeydown="OnViewerKeyDown" @onclick="ClosePhotoViewerAsync" @ref="_viewerBackdropRef">
        <div class="photo-viewer-content" role="dialog" aria-modal="true" @onclick:stopPropagation="true">
            <button class="viewer-close" data-autofocus @onclick="ClosePhotoViewerAsync" aria-label="Close viewer">✕</button>

            <div class="viewer-index">@((_viewerIndex + 1)) / @(_viewerPhotos?.Count ?? 0)</div>

            <button class="viewer-nav left" @onclick="PrevPhoto" aria-label="Previous photo">‹</button>

            <div class="viewer-image-wrap">
                <div class="viewer-spinner" aria-hidden="true"></div>
                @if (_viewerPhotos != null && _viewerPhotos.Count > 0)
                {
                    var current = _viewerPhotos[_viewerIndex];
                    <img src="@GetSafePhotoUrl(current.Url)" alt="@(current.Caption ?? "Photo")" class="viewer-image" onload="(function(img){try{var el=img.closest('.photo-viewer-content'); if(el){el.classList.add('loaded'); el.style.setProperty('--img-natural-width', img.naturalWidth); el.style.setProperty('--img-natural-height', img.naturalHeight); el.style.setProperty('--img-aspect', (img.naturalWidth / img.naturalHeight));}}catch(e){} })(this)" onerror="(function(img){try{var el=img.closest('.photo-viewer-content'); if(el){el.classList.add('loaded');}}catch(e){} })(this)" />
                    <div class="viewer-caption">@current.Caption</div>
                }
            </div>

            <button class="viewer-nav right" @onclick="NextPhoto" aria-label="Next photo">›</button>
        </div>
    </div>
}

@code {
        // Photo viewer modal state
        private bool _photoViewerOpen = false;
        private bool _viewerClosing = false;
        private List<Models.Photo> _viewerPhotos = new List<Models.Photo>();
        private int _viewerIndex = 0;
        private ElementReference _viewerBackdropRef;
        private ElementReference _viewerContentRef;
        private bool _focusRequested = false;
        private IJSObjectReference? _focusTrapModule;
        private IJSObjectReference? _focusTrapHandle;
        private IJSObjectReference? _viewerSizerModule;

        // Keep a shim for existing sync callers
        private void OpenPhotoViewer(List<Models.Photo> photos, int startIndex)
        {
            _ = OpenPhotoViewerAsync(photos, startIndex);
        }

        private async Task OpenPhotoViewerAsync(List<Models.Photo> photos, int startIndex)
        {
            if (photos == null || photos.Count == 0) return;
            _viewerPhotos = photos.ToList();
            _viewerIndex = Math.Max(0, Math.Min(startIndex, _viewerPhotos.Count - 1));
            _photoViewerOpen = true;
            _focusRequested = true;
            StateHasChanged();

            // Allow render
            await Task.Yield();

            // Activate focus trap
            try
            {
                if (_focusTrapModule == null)
                {
                    _focusTrapModule = await JS.InvokeAsync<IJSObjectReference>("import", "/js/focusTrap.js");
                }
                if (_focusTrapModule != null)
                {
                    _focusTrapHandle = await _focusTrapModule.InvokeAsync<IJSObjectReference>("activate", _viewerContentRef);
                }
            }
            catch { /* best-effort */ }

            // Activate sizer
            try
            {
                if (_viewerSizerModule == null)
                {
                    _viewerSizerModule = await JS.InvokeAsync<IJSObjectReference>("import", "/js/viewerSizer.js");
                }
                if (_viewerSizerModule != null)
                {
                    await _viewerSizerModule.InvokeVoidAsync("attach", _viewerContentRef);
                }
            }
            catch { /* best-effort */ }
        }

        private void ClosePhotoViewer()
        {
            _ = ClosePhotoViewerAsync();
        }

        private async Task ClosePhotoViewerAsync()
        {
            if (!_photoViewerOpen) return;
            _viewerClosing = true;
            StateHasChanged();
            // short delay for closing animation
            await Task.Delay(180);

            try
            {
                if (_focusTrapHandle != null)
                {
                    await _focusTrapHandle.InvokeVoidAsync("deactivate");
                    await _focusTrapHandle.DisposeAsync();
                    _focusTrapHandle = null;
                }
                if (_focusTrapModule != null)
                {
                    await _focusTrapModule.DisposeAsync();
                    _focusTrapModule = null;
                }
            }
            catch { /* best-effort */ }

            try
            {
                if (_viewerSizerModule != null)
                {
                    await _viewerSizerModule.InvokeVoidAsync("detach", _viewerContentRef);
                    await _viewerSizerModule.DisposeAsync();
                    _viewerSizerModule = null;
                }
            }
            catch { }

            _photoViewerOpen = false;
            _viewerClosing = false;
            _viewerPhotos = new List<Models.Photo>();
            _viewerIndex = 0;
            StateHasChanged();
        }

        private void NextPhoto()
        {
            if (_viewerPhotos == null || _viewerPhotos.Count == 0) return;
            _viewerIndex = (_viewerIndex + 1) % _viewerPhotos.Count;
            StateHasChanged();
        }

        private void PrevPhoto()
        {
            if (_viewerPhotos == null || _viewerPhotos.Count == 0) return;
            _viewerIndex = (_viewerIndex - 1 + _viewerPhotos.Count) % _viewerPhotos.Count;
            StateHasChanged();
        }

        // Keyboard handling: attach to window via JS interop-less approach using onkeydown on body element in markup
        private void OnViewerKeyDown(KeyboardEventArgs e)
        {
            if (!_photoViewerOpen) return;
            if (e.Key == "ArrowRight") NextPhoto();
            else if (e.Key == "ArrowLeft") PrevPhoto();
            else if (e.Key == "Escape") ClosePhotoViewer();
        }

        protected override async Task OnAfterRenderAsync(bool firstRender)
        {
            if (_photoViewerOpen && _focusRequested)
            {
                try
                {
                    await _viewerBackdropRef.FocusAsync();
                }
                catch { /* best-effort */ }
                _focusRequested = false;
            }
            await base.OnAfterRenderAsync(firstRender);
        }

        // Main data and state variables
    private List<Announcement>? announcements;
    private List<Announcement>? filteredAnnouncements;
    private string searchTerm = "";
    private string activeTab = "all";
    private string selectedCategory = "";
    private bool isLoading = true;
    private bool showModal = false;
    private bool isLoadingModal = false;
    private HashSet<Guid> expandedAnnouncements = new HashSet<Guid>();
    
    // Statistics counters
    private int institutionCount = 0;
    private int benefactorCount = 0;
    private int myPostsCount = 0;
    private int pinnedCount = 0;
    
    // Image upload properties
    private List<IBrowserFile> selectedImages = new();
    // keep an explicit order so we preserve the user upload sequence
    private List<(int order, string fileName, string contentType, byte[] data)> processedImages = new();
    private List<Photo> existingPhotos = new();
    private Dictionary<string, int> uploadProgress = new();
    private bool isUploadingImages = false;
    private List<Guid> photosToRemove = new();
    private string deadlineText = "";
    // index of the dragged item during client-side reorder
    private int? dragSourceIndex = null;
    
     // Model for editing
    private Announcement editingAnnouncement = new() 
    { 
        Title = "",
        Content = "",
        AuthorId = "",
        AuthorName = "",
        AuthorType = UserRole.Benefactor
    };
    
    private string currentUserId = "";
    private string currentUserName = "";

    // Load current user + announcements on init
    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUser();
        await LoadAnnouncements();
    }

    // Load user details from authentication
    private async Task LoadCurrentUser()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                var user = await UserManager.GetUserAsync(authState.User);
                if (user != null)
                {
                    currentUserId = user.Id;
                    currentUserName = user.Email ?? "Benefactor Admin";
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading current user: {ex.Message}");
            // Continue with default values if user loading fails
            currentUserId = "";
            currentUserName = "Benefactor Admin";
        }
    }

    // Fetch announcements from service
    private async Task LoadAnnouncements()
    {
        isLoading = true;
        try
        {
            // Load ALL announcements with photos (for shared viewing)
            announcements = await AnnouncementService.GetAllAnnouncementsWithPhotosAsync();
            UpdateStatistics();
            FilterAnnouncements();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading announcements: {ex.Message}");
            announcements = new List<Announcement>();
        }
        finally
        {
            isLoading = false;
            // Delay StateHasChanged to allow CSS to be fully applied
            await Task.Delay(100);
            StateHasChanged();
        }
    }

    // Update statistics counters
    private void UpdateStatistics()
    {
        if (announcements == null) return;
        
        institutionCount = announcements.Count(a => a.AuthorType == UserRole.Institution);
        benefactorCount = announcements.Count(a => a.AuthorType == UserRole.Benefactor);
        myPostsCount = announcements.Count(a => a.AuthorId == currentUserId);
        pinnedCount = announcements.Count(a => a.IsPinned);
    }

    // Change active tab
    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        FilterAnnouncements();
    }

// FILTER MANAGEMENT

    // Trigger filter on search
    private void OnSearchChanged(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        FilterAnnouncements();
    }

    // Apply filtering logic
    private void FilterAnnouncements()
    {
        if (announcements == null) return;

        var filtered = announcements.AsEnumerable();

        // Filter by tab
        filtered = activeTab switch
        {
            "institution" => filtered.Where(a => a.AuthorType == UserRole.Institution),
            "benefactor" => filtered.Where(a => a.AuthorType == UserRole.Benefactor),
            "mine" => filtered.Where(a => a.AuthorId == currentUserId),
            _ => filtered // "all"
        };

        // Filter by category
        if (!string.IsNullOrEmpty(selectedCategory))
        {
            filtered = filtered.Where(a => a.Category?.Contains(selectedCategory) == true);
        }

        // Filter by search term
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filtered = filtered.Where(a => 
                a.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                a.Content.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (a.AuthorName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        filteredAnnouncements = filtered.ToList();
        StateHasChanged();
    }

    // Reset filters and reload announcements
    private void ClearFilters()
    {
        searchTerm = "";
        selectedCategory = "";
        FilterAnnouncements();
    }

// CREATE ANNOUNCEMENT FORM
    // Initialize a new announcement draft for creation
    private void ShowCreateForm()
    {
        editingAnnouncement = new Announcement
        {
            Title = "",
            Content = "",
            AuthorId = currentUserId,
            AuthorName = currentUserName,
            AuthorType = UserRole.Benefactor,
            Priority = AnnouncementPriority.Normal,
            IsPublic = true,
            IsActive = true
        };
        deadlineText = "";
        selectedImages.Clear();
        processedImages.Clear();
        existingPhotos.Clear();
        photosToRemove.Clear();
        showModal = true;
    }

// EDIT ANNOUNCEMENT FORM
    // Load an existing announcement into edit form
    private async void EditAnnouncement(Announcement announcement)
    {
        editingAnnouncement = new Announcement
        {
            AnnouncementId = announcement.AnnouncementId,
            Title = announcement.Title,
            Content = announcement.Content,
            Summary = announcement.Summary,
            Category = announcement.Category,
            Priority = announcement.Priority,
            IsPublic = announcement.IsPublic,
            IsPinned = announcement.IsPinned,
            IsActive = announcement.IsActive,
            PublishDate = announcement.PublishDate,
            ExpiryDate = announcement.ExpiryDate,
            AuthorId = announcement.AuthorId,
            AuthorName = announcement.AuthorName,
            AuthorType = announcement.AuthorType,
            OrganizationName = announcement.OrganizationName
        };
        
        // Convert DateTime to text for deadline field
        deadlineText = announcement.ExpiryDate?.ToString("MM/dd/yyyy") ?? "";
        
        // Clear image selections
        selectedImages.Clear();
        processedImages.Clear();
        photosToRemove.Clear();
        
        // Load existing photos for editing
        try
        {
            existingPhotos = await AnnouncementService.GetAnnouncementPhotosAsync(announcement.AnnouncementId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading existing photos: {ex.Message}");
            existingPhotos = new List<Photo>();
        }
        
        showModal = true;
        StateHasChanged();
    }

// SAVE ANNOUNCEMENT (CREATE OR UPDATE)
    private async Task SaveAnnouncement()
    {
        isLoadingModal = true;
        try
        {
            // Parse deadline text to DateTime if provided
            if (!string.IsNullOrWhiteSpace(deadlineText))
            {
                if (DateTime.TryParse(deadlineText, out var parsedDate))
                {
                    editingAnnouncement.ExpiryDate = parsedDate;
                }
                else
                {
                    editingAnnouncement.ExpiryDate = null; // Invalid date format
                }
            }
            else
            {
                editingAnnouncement.ExpiryDate = null;
            }

            // Upload new images if any
            var uploadedImageUrls = await UploadSelectedImages();
            Console.WriteLine($"📸 SaveAnnouncement: Received {uploadedImageUrls.Count} uploaded URLs");

            Announcement savedAnnouncement;
            if (editingAnnouncement.AnnouncementId != Guid.Empty)
            {
                // Update existing announcement
                savedAnnouncement = await AnnouncementService.UpdateAnnouncementAsync(editingAnnouncement.AnnouncementId, editingAnnouncement) ?? editingAnnouncement;
            }
            else
            {
                // Create new announcement
                savedAnnouncement = await AnnouncementService.CreateAnnouncementAsync(editingAnnouncement);
            }

            // Add new photos to the announcement
            if (uploadedImageUrls.Any())
            {
                Console.WriteLine($"📸 Adding {uploadedImageUrls.Count} photos to announcement {savedAnnouncement.AnnouncementId}");
                foreach (var url in uploadedImageUrls)
                {
                    Console.WriteLine($"📸 Photo URL: {url}");
                }
                await AnnouncementService.AddPhotosToAnnouncementAsync(savedAnnouncement.AnnouncementId, uploadedImageUrls);
                Console.WriteLine($"✅ Photos added successfully to database");
            }

            // Remove deleted existing photos (photos that were removed during editing)
            if (photosToRemove.Any())
            {
                foreach (var photoId in photosToRemove)
                {
                    await AnnouncementService.RemovePhotoFromAnnouncementAsync(photoId);
                }
            }
            
            // Wait a bit to ensure database changes are committed
            await Task.Delay(200);
            
            await LoadAnnouncements();
            HideModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving announcement: {ex.Message}");
        }
        finally
        {
            isLoadingModal = false;
        }
    }

    // IMAGE UPLOAD METHODS
    private async Task OnImageSelected(InputFileChangeEventArgs e)
    {
        var files = e.GetMultipleFiles(); // Get selected files

        // baseIndex ensures files from earlier selections keep lower order values
        int baseIndex = processedImages.Count;
        int fileIndex = 0;

        foreach (var file in files)
        {
            // Validate file type and size
            if (IsValidImageFile(file))
            {
                try
                {
                    // Immediately process the file to avoid Blazor InputFile limitations
                    using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
                    var bytes = new byte[stream.Length];
                    var totalBytesRead = 0;

                    // Read the entire stream into the byte array
                    while (totalBytesRead < bytes.Length)
                    {
                        var bytesRead = await stream.ReadAsync(bytes, totalBytesRead, bytes.Length - totalBytesRead);
                        if (bytesRead == 0)
                            break; // End of stream
                        totalBytesRead += bytesRead;
                    }

                    Console.WriteLine($"✅ Successfully processed {file.Name}: {totalBytesRead} bytes");
                    processedImages.Add((baseIndex + fileIndex, file.Name, file.ContentType, bytes));
                    fileIndex++;
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"❌ Error processing {file.Name}: {ex.Message}");
                }
            }
        }
        StateHasChanged();
    }

    private bool IsValidImageFile(IBrowserFile file)
    {
        // Check file type
        var allowedTypes = new[] { "image/jpeg", "image/jpg", "image/png", "image/gif", "image/webp" };
        if (!allowedTypes.Contains(file.ContentType.ToLower()))
        {
            return false;
        }

        // Check file size (max 10MB)
        if (file.Size > 10 * 1024 * 1024)
        {
            return false;
        }

        return true;
    }

    // UPLOAD SELECTED IMAGES TO BLOB STORAGE
    private async Task<List<string>> UploadSelectedImages()
    {
        var uploaded = new List<(int order, string url)>();

        if (!processedImages.Any())
        {
            return new List<string>();
        }

        foreach (var (order, fileName, contentType, data) in processedImages)
        {
            try
            {
                Console.WriteLine($"📤 Uploading {fileName}: {data.Length} bytes, content type: {contentType}");

                // Validate the byte array is not empty or corrupted
                if (data == null || data.Length == 0)
                {
                    Console.WriteLine($"❌ Empty or null data for {fileName}");
                    continue;
                }

                using var stream = new MemoryStream(data);
                var uniqueFileName = Guid.NewGuid().ToString() + Path.GetExtension(fileName);

                Console.WriteLine($"📁 Generated unique filename: {uniqueFileName}");

                var imageUrl = await BlobStorageService.UploadPhotoAsync(stream, uniqueFileName, contentType);
                if (!string.IsNullOrEmpty(imageUrl))
                {
                    Console.WriteLine($"✅ Successfully uploaded {fileName} -> {imageUrl}");
                    uploaded.Add((order, imageUrl));
                }
                else
                {
                    Console.WriteLine($"❌ Failed to upload {fileName} - BlobStorageService returned empty URL");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Error uploading image {fileName}: {ex.Message}");
            }
        }

        // Return URLs sorted by the original order value
        return uploaded.OrderBy(x => x.order).Select(x => x.url).ToList();
    }

    private async Task UploadImages(Guid announcementId)
    {
        if (!processedImages.Any()) return;

        isUploadingImages = true;
        uploadProgress.Clear();
        var uploadedUrls = new List<string>();

        try
        {
            foreach (var (order, fileName, contentType, data) in processedImages)
            {
                uploadProgress[fileName] = 0;
                StateHasChanged();

                // Generate unique filename
                var fileExtension = Path.GetExtension(fileName);
                var uniqueFileName = $"{Guid.NewGuid()}{fileExtension}";
                
                // Simulate progress updates
                var progressTask = Task.Run(async () =>
                {
                    for (int i = 0; i <= 90; i += 10)
                    {
                        uploadProgress[fileName] = i;
                        await InvokeAsync(StateHasChanged);
                        await Task.Delay(100);
                    }
                });

                // Actual upload
                using var stream = new MemoryStream(data);
                var photoUrl = await BlobStorageService.UploadPhotoAsync(stream, uniqueFileName, contentType);
                Console.WriteLine($"📸 Uploaded photo: {uniqueFileName} -> URL: {photoUrl}");
                // preserve original order by pairing it with returned URL
                uploadedUrls.Add(photoUrl);

                // Complete progress
                uploadProgress[fileName] = 100;
                StateHasChanged();
            }

            // Add photos to announcement in database
            if (uploadedUrls.Any())
            {
                await AnnouncementService.AddPhotosToAnnouncementAsync(announcementId, uploadedUrls);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error uploading images: {ex.Message}");
        }
        finally
        {
            isUploadingImages = false;
            selectedImages.Clear();
            processedImages.Clear();
            uploadProgress.Clear();
            StateHasChanged();
        }
    }

    private async Task HandleImageUpdates(Guid announcementId)
    {
        try
        {
            // Remove deleted photos
            foreach (var photoId in photosToRemove)
            {
                await AnnouncementService.RemovePhotoFromAnnouncementAsync(photoId);
            }

            // Upload new photos
            await UploadImages(announcementId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error handling image updates: {ex.Message}");
        }
        finally
        {
            photosToRemove.Clear();
        }
    }

    // HELPER METHODS FOR PHOTO DISPLAY
    private string GetSafePhotoUrl(string photoUrl)
    {
        try
        {
            // If it's already a safe URL (like base64 data), return as is
            if (string.IsNullOrEmpty(photoUrl) || photoUrl.StartsWith("data:"))
            {
                return photoUrl;
            }
            
            // If it's already a relative URL (controller path), return as is
            if (photoUrl.StartsWith("/api/photo/stream/"))
            {
                return photoUrl;
            }
            
            // Extract filename from Azure blob URL or path
            string fileName;
            if (Uri.TryCreate(photoUrl, UriKind.Absolute, out var uri))
            {
                // It's an absolute URL (like Azure blob URL)
                fileName = Path.GetFileName(uri.LocalPath);
            }
            else
            {
                // It's likely just a filename or relative path
                fileName = Path.GetFileName(photoUrl);
            }
            
            // Always use controller URL for stability - avoid SAS URL generation during renders
            var controllerUrl = $"/api/photo/stream/{Uri.EscapeDataString(fileName)}";
            return controllerUrl;
        }
        catch (Exception)
        {
            // Fallback to original URL if parsing fails
            return photoUrl;
        }
    }

    private void RemoveImage(IBrowserFile file)
    {
        selectedImages.Remove(file);
        StateHasChanged();
    }

    private void RemoveProcessedImage(int index)
    {
        if (index >= 0 && index < processedImages.Count)
        {
            processedImages.RemoveAt(index);
            ReindexProcessedImages();
            StateHasChanged();
        }
    }

    // Drag handling for reordering selected images
    private void StartDrag(int index)
    {
        dragSourceIndex = index;
    }

    private void DropDrag(int targetIndex)
    {
        if (dragSourceIndex == null) return;
        var source = dragSourceIndex.Value;
        var dest = targetIndex;
        if (source == dest) { dragSourceIndex = null; return; }

        // Move item from source to dest
        var item = processedImages[source];
        processedImages.RemoveAt(source);
        if (dest > processedImages.Count) dest = processedImages.Count;
        processedImages.Insert(dest, item);

        // Reindex orders to keep them sequential and deterministic
        ReindexProcessedImages();
        dragSourceIndex = null;
        StateHasChanged();
    }

    private void ReindexProcessedImages()
    {
        for (int i = 0; i < processedImages.Count; i++)
        {
            var t = processedImages[i];
            processedImages[i] = (i, t.fileName, t.contentType, t.data);
        }
    }

    private void RemoveExistingPhoto(Guid photoId)
    {
        photosToRemove.Add(photoId);
        var photo = existingPhotos.FirstOrDefault(p => p.PhotoId == photoId);
        if (photo != null)
        {
            existingPhotos.Remove(photo);
        }
        StateHasChanged();
    }

    // TOGGLE PIN ON ANNOUNCEMENT
    private async Task TogglePin(Guid announcementId)
    {
        try
        {
            await AnnouncementService.TogglePinAsync(announcementId, currentUserId);
            await LoadAnnouncements();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error toggling pin: {ex.Message}");
        }
    }

    // DELETE ANNOUNCEMENT
    private async Task DeleteAnnouncement(Guid announcementId)
    {
        try
        {
            if (await AnnouncementService.DeleteAnnouncementAsync(announcementId, currentUserId))
            {
                await LoadAnnouncements();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting announcement: {ex.Message}");
        }
    }

    // INCREMENT VIEW COUNT
    private async Task IncrementView(Guid announcementId)
    {
        try
        {
            await AnnouncementService.IncrementViewCountAsync(announcementId);
            // Update local view count without reloading everything
            var announcement = announcements?.FirstOrDefault(a => a.AnnouncementId == announcementId);
            if (announcement != null)
            {
                announcement.ViewCount++;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error incrementing view count: {ex.Message}");
        }
    }

// MODAL HANDLING
    // Close modal and reset editing announcement
    private void HideModal()
    {
        showModal = false;
        editingAnnouncement = new() 
        { 
            Title = "",
            Content = "",
            AuthorId = "",
            AuthorName = "",
            AuthorType = UserRole.Benefactor
        };
        
        // Clear image-related data
        selectedImages.Clear();
        processedImages.Clear();
        existingPhotos.Clear();
        uploadProgress.Clear();
        photosToRemove.Clear();
        isUploadingImages = false;
    }

// ANNOUNCEMENT EXPANSION (SHOW MORE/LESS)
    // Check if announcement is expanded
    private bool IsAnnouncementExpanded(Guid announcementId)
    {
    return expandedAnnouncements.Contains(announcementId);
    }

    // Expand or collapse announcement details
    private void ToggleAnnouncementExpansion(Guid announcementId)
    {
        if (expandedAnnouncements.Contains(announcementId))
        {
            expandedAnnouncements.Remove(announcementId);
        }
        else
        {
            expandedAnnouncements.Add(announcementId);
        }
        StateHasChanged();
    }

// UI HELPERS
    // Provide tab-specific description
    private string GetTabDescription()
    {
        return activeTab switch
        {
            "all" => "All Announcements",
            "institution" => "Institution Announcements",
            "benefactor" => "Benefactor Announcements",
            "mine" => "Your Announcements",
            _ => "Announcements"
        };
    }

    // Provide empty state title based on tab
    private string GetEmptyStateTitle()
    {
        return activeTab switch
        {
            "all" => "No announcements found",
            "institution" => "No institution announcements",
            "benefactor" => "No benefactor announcements", 
            "mine" => "You haven't created any announcements yet",
            _ => "No announcements found"
        };
    }

    private string GetEmptyStateMessage()
    {
        // Suggest adjustments if filters/search applied
        if (!string.IsNullOrEmpty(searchTerm) || !string.IsNullOrEmpty(selectedCategory))
        {
            return "Try adjusting your search terms or filters.";
        }
        
        // Provide tab-specific empty state message
        return activeTab switch
        {
            "all" => "There are no announcements to display at this time.",
            "institution" => "No institutions have posted announcements yet.",
            "benefactor" => "No benefactors have posted announcements yet.",
            "mine" => "Click 'Create Announcement' to share information with students.",
            _ => "No announcements available."
        };
    }

    // Return count of announcements based on tab
    private int GetTabCount()
    {
        return activeTab switch
        {
            "all" => announcements?.Count ?? 0,
            "institution" => institutionCount,
            "benefactor" => benefactorCount,
            "mine" => myPostsCount,
            _ => 0
        };
    }

    // Return badge style based on author type
    private string GetAuthorBadgeClass(UserRole authorType)
    {
        return authorType switch
        {
            UserRole.Institution => "badge-institution",
            UserRole.Benefactor => "badge-benefactor",
            _ => "badge-normal"
        };
    }

    private string GetCategoryBadgeClass(string category)
    {
        return category switch
        {
            "Events" => "badge-events",
            "Requirements" => "badge-requirements",
            "Results" => "badge-results",
            "General" => "badge-general",
            _ => "badge-normal"
        };
    }

    private string GetPriorityBadgeClass(AnnouncementPriority priority)
    {
        return priority switch
        {
            AnnouncementPriority.High => "badge-high",
            AnnouncementPriority.Normal => "badge-normal",
            AnnouncementPriority.Low => "badge-low",
            AnnouncementPriority.Urgent => "badge-urgent",
            _ => "badge-normal"
        };
    }

    // Return icon class based on author type
    private string GetAuthorIcon(UserRole authorType)
    {
        return authorType switch
        {
            UserRole.Institution => "bi bi-building",
            UserRole.Benefactor => "bi bi-hand-thumbs-up",
            _ => "bi bi-person"
        };
    }

    // Return color based on announcement priority
    private string GetPriorityColor(AnnouncementPriority priority)
    {
        return priority switch
        {
            AnnouncementPriority.Low => "secondary",
            AnnouncementPriority.Normal => "primary",
            AnnouncementPriority.High => "warning",
            AnnouncementPriority.Urgent => "danger",
            _ => "primary"
        };
    }

// CUSTOM CALENDAR FUNCTIONALITY
    private bool showCalendarDropdown = false;
    private DateTime calendarDisplayDate = DateTime.Now;

    // Calendar day model for grid display
    public class CalendarDay
    {
        public DateTime Date { get; set; }
        public int Day { get; set; }
        public bool IsCurrentMonth { get; set; }
        public bool IsToday { get; set; }
        public bool IsSelected { get; set; }
    }

    // Toggle calendar dropdown visibility
    private void ToggleCalendar()
    {
        showCalendarDropdown = !showCalendarDropdown;
        if (showCalendarDropdown)
        {
            // Set calendar display date based on current deadline text
            if (DateTime.TryParse(deadlineText, out DateTime parsedDate))
            {
                calendarDisplayDate = parsedDate;
            }
            else
            {
                calendarDisplayDate = DateTime.Now;
            }
        }
    }

    // Navigate to previous month
    private void PreviousMonth()
    {
        calendarDisplayDate = calendarDisplayDate.AddMonths(-1);
    }

    // Navigate to next month
    private void NextMonth()
    {
        calendarDisplayDate = calendarDisplayDate.AddMonths(1);
    }

    // Generate calendar days for current month view
    private List<CalendarDay> GetCalendarDays()
    {
        var days = new List<CalendarDay>();
        var firstDayOfMonth = new DateTime(calendarDisplayDate.Year, calendarDisplayDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
        
        DateTime? selectedDate = null;
        if (DateTime.TryParse(deadlineText, out DateTime parsedDate))
        {
            selectedDate = parsedDate.Date;
        }

        for (int i = 0; i < 42; i++) // 6 weeks * 7 days
        {
            var date = startDate.AddDays(i);
            days.Add(new CalendarDay
            {
                Date = date,
                Day = date.Day,
                IsCurrentMonth = date.Month == calendarDisplayDate.Month,
                IsToday = date.Date == DateTime.Today,
                IsSelected = selectedDate.HasValue && date.Date == selectedDate.Value
            });
        }

        return days;
    }

    // Select a date from calendar
    private void SelectDate(DateTime date)
    {
        deadlineText = date.ToString("MM/dd/yyyy");
        showCalendarDropdown = false;
        StateHasChanged();
    }

    // Clear the deadline date
    private void ClearDate()
    {
        deadlineText = "";
        showCalendarDropdown = false;
        StateHasChanged();
    }

    // Select today's date
    private void SelectToday()
    {
        deadlineText = DateTime.Today.ToString("MM/dd/yyyy");
        showCalendarDropdown = false;
        StateHasChanged();
    }

    // Close calendar dropdown when clicking outside
    private void CloseCalendarIfOpen()
    {
        if (showCalendarDropdown)
        {
            showCalendarDropdown = false;
            StateHasChanged();
        }
    }

    // Handle month selection change
    private void OnMonthChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int month))
        {
            calendarDisplayDate = new DateTime(calendarDisplayDate.Year, month, 1);
            StateHasChanged();
        }
    }

    // Handle year selection change
    private void OnYearChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int year))
        {
            var daysInMonth = DateTime.DaysInMonth(year, calendarDisplayDate.Month);
            var day = Math.Min(calendarDisplayDate.Day, daysInMonth);
            calendarDisplayDate = new DateTime(year, calendarDisplayDate.Month, day);
            StateHasChanged();
        }
    }
}