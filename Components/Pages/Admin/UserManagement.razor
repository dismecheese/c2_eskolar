@page "/admin/users"
@page "/dashboard/superadmin/users"
@attribute [Authorize(Roles = "SuperAdmin")]
@layout Layout.SuperAdminDashLayout
@implements IDisposable
@implements IAsyncDisposable

@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject c2_eskolar.Services.InstitutionProfileService InstitutionProfileService
@inject UserManager<IdentityUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@using c2_eskolar.Data
@using c2_eskolar.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer

<PageTitle>User Management - eSkolar SuperAdmin</PageTitle>

<div class="dashboard-center-container">
    <!-- Top Bar -->
    <div class="dashboard-topbar">
        <span class="dashboard-date">@DateTime.Now.ToString("dd MMM yyyy, ddd")</span>
    </div>

    <!-- Page Header -->
    <div class="page-header-section">
        <div class="page-header-content">
            <div class="page-title-area">
                <h1 class="page-title">
                    <i class="bi bi-people me-3"></i>
                    User Management
                </h1>
                <p class="page-subtitle">Manage system users, roles, and permissions</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-primary" @onclick="ShowCreateUserModal">
                    <i class="bi bi-plus-circle me-2"></i>
                    Add New User
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid-users">
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon students">
                    <i class="bi bi-mortarboard"></i>
                </div>
            </div>
            <div class="stat-value">@studentCount</div>
            <div class="stat-label">Students</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon institutions">
                    <i class="bi bi-building"></i>
                </div>
            </div>
            <div class="stat-value">@institutionCount</div>
            <div class="stat-label">Institutions</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon benefactors">
                    <i class="bi bi-heart"></i>
                </div>
            </div>
            <div class="stat-value">@benefactorCount</div>
            <div class="stat-label">Benefactors</div>
        </div>

                <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon users">
                    <i class="bi bi-people"></i>
                </div>
            </div>
            <div class="stat-value">@totalUsers</div>
            <div class="stat-label">Total Users</div>
        </div>

                <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon requests">
                    <i class="bi bi-inbox"></i>
                </div>
            </div>
            <div class="stat-value">@totalRequests</div>
            <div class="stat-label">Total Requests</div>
        </div>

                <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon archive">
                    <i class="bi bi-archive"></i>
                </div>
            </div>
            <div class="stat-value">@totalArchived</div>
            <div class="stat-label">Total Archived</div>
        </div>

                <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon unverified" style="background: #ff6b6b;">
                    <i class="bi bi-person-x"></i>
                </div>
            </div>
            <div class="stat-value">@unverifiedCount</div>
            <div class="stat-label">Unverified</div>
        </div>

    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
        <button class="filter-tab @(activeFilter == "Student" ? "active" : "")" @onclick="@(() => SetFilter("Student"))">
            <i class="bi bi-mortarboard me-2"></i>Students
        </button>
        <button class="filter-tab @(activeFilter == "Institution" ? "active" : "")" @onclick="@(() => SetFilter("Institution"))">
            <i class="bi bi-building me-2"></i>Institutions
        </button>
        <button class="filter-tab @(activeFilter == "Benefactor" ? "active" : "")" @onclick="@(() => SetFilter("Benefactor"))">
            <i class="bi bi-heart me-2"></i>Benefactors
        </button>
        <button class="filter-tab @(activeFilter == "Requests" ? "active" : "")" @onclick="@(() => SetFilter("Requests"))">
            <i class="bi bi-inbox me-2"></i>Requests
        </button>
        <button class="filter-tab @(activeFilter == "Archive" ? "active" : "")" @onclick="@(() => SetFilter("Archive"))">
            <i class="bi bi-archive me-2"></i>Archive
        </button>
        <button class="filter-tab @(activeFilter == "Unverified" ? "active" : "")" @onclick="@(() => SetFilter("Unverified"))">
            <i class="bi bi-person-x me-2"></i>Unverified
        </button>
    </div>

    <!-- Users Table -->
    <div class="users-table-container">
        @if (showDeleteModal)
        {
            <div class="sv-modal sv-modal-backdrop sv-modal-fixed">
                <div class="sv-modal-content">
                    <div class="sv-modal-header">
                        <h2>Confirm User Deletion</h2>
                    </div>
                    <div class="sv-modal-body">
                        <p class="sv-modal-justify">
                            Are you sure you want to archive <b>@userNameToDelete</b>?<br />
                            This action will move the account to the Archive tab. You can restore it later if needed.
                        </p>
                    </div>
                    <div class="sv-modal-footer" style="display:flex;gap:16px;justify-content:flex-end;">
                        <button class="sv-btn sv-btn-secondary" @onclick="CancelDeleteUser">Cancel</button>
                        <button class="sv-btn sv-btn-primary" @onclick="ConfirmDeleteUser">Archive</button>
                    </div>
                </div>
            </div>
        }
        @if (showPermanentDeleteModal)
        {
            <div class="sv-modal sv-modal-backdrop sv-modal-fixed">
                <div class="sv-modal-content">
                    <div class="sv-modal-header">
                        <h2>Remove User</h2>
                    </div>
                    <div class="sv-modal-body">
                        <p class="sv-modal-justify">
                            Are you sure you want to <b> permanently remove</b> <b>@userNameToPermanentDelete</b>?<br />
                            This action cannot be undone. All data for this account will be removed from the system.
                        </p>
                    </div>
                    <div class="sv-modal-footer" style="display:flex;gap:16px;justify-content:flex-end;">
                        <button class="sv-btn sv-btn-secondary" @onclick="CancelPermanentDeleteUser">Cancel</button>
                        <button class="sv-btn sv-btn-primary" @onclick="ConfirmPermanentDeleteUser">Remove</button>
                    </div>
                </div>
            </div>
        }
        @if (showRestoreModal)
        {
            <div class="sv-modal sv-modal-backdrop sv-modal-fixed">
                <div class="sv-modal-content">
                    <div class="sv-modal-header">
                        <h2>Restore User</h2>
                    </div>
                    <div class="sv-modal-body">
                        <p class="sv-modal-justify">
                            Are you sure you want to restore <b>@userNameToRestore</b>?<br />
                            This action will reactivate the account and make it visible in the appropriate user tab.
                        </p>
                    </div>
                    <div class="sv-modal-footer" style="display:flex;gap:16px;justify-content:flex-end;">
                        <button class="sv-btn sv-btn-secondary" @onclick="CancelRestoreUser">Cancel</button>
                        <button class="sv-btn sv-btn-primary" @onclick="ConfirmRestoreUser">Restore</button>
                    </div>
                </div>
            </div>
        }
        @if (showBulkDeleteConfirmModal)
        {
            <div class="sv-modal sv-modal-backdrop sv-modal-fixed">
                <div class="sv-modal-content">
                    <div class="sv-modal-header">
                        <h2>Bulk Delete Confirmation</h2>
                    </div>
                    <div class="sv-modal-body">
                        <p class="sv-modal-justify">
                            Are you sure you want to <b>permanently delete @selectedUserIds.Count selected user(s)</b>?<br />
                            @if (activeFilter == "Archive")
                            {
                                <span>This action cannot be undone. All data for these accounts will be permanently removed from the system.</span>
                            }
                            else if (activeFilter == "Unverified")
                            {
                                <span>This will permanently delete these unverified accounts from the system.</span>
                            }
                        </p>
                    </div>
                    <div class="sv-modal-footer" style="display:flex;gap:16px;justify-content:flex-end;">
                        <button class="sv-btn sv-btn-secondary" @onclick="CancelBulkDelete">Cancel</button>
                        <button class="sv-btn sv-btn-primary" @onclick="ConfirmBulkDelete">Delete All</button>
                    </div>
                </div>
            </div>
        }
        @if (showBulkArchiveConfirmModal)
        {
            <div class="sv-modal sv-modal-backdrop sv-modal-fixed">
                <div class="sv-modal-content">
                    <div class="sv-modal-header">
                        <h2>Bulk Archive Confirmation</h2>
                    </div>
                    <div class="sv-modal-body">
                        <p class="sv-modal-justify">
                            Are you sure you want to <b>archive @selectedUserIds.Count selected user(s)</b>?<br />
                            <span>These users will be moved to the Archive tab and can be restored later if needed.</span>
                        </p>
                    </div>
                    <div class="sv-modal-footer" style="display:flex;gap:16px;justify-content:flex-end;">
                        <button class="sv-btn sv-btn-secondary" @onclick="CancelBulkArchive">Cancel</button>
                        <button class="sv-btn sv-btn-primary" @onclick="ConfirmBulkArchive">Archive All</button>
                    </div>
                </div>
            </div>
        }
        @if (showBulkAcceptConfirmModal)
        {
            <div class="sv-modal sv-modal-backdrop sv-modal-fixed">
                <div class="sv-modal-content">
                    <div class="sv-modal-header">
                        <h2>Bulk Accept Confirmation</h2>
                    </div>
                    <div class="sv-modal-body">
                        <p class="sv-modal-justify">
                            Are you sure you want to <b>accept @selectedUserIds.Count selected request(s)</b>?<br />
                            <span>This will verify and activate these accounts.</span>
                        </p>
                    </div>
                    <div class="sv-modal-footer" style="display:flex;gap:16px;justify-content:flex-end;">
                        <button class="sv-btn sv-btn-secondary" @onclick="CancelBulkAccept">Cancel</button>
                        <button class="sv-btn sv-btn-primary" @onclick="ConfirmBulkAccept">Accept All</button>
                    </div>
                </div>
            </div>
        }
        @if (showBulkRejectConfirmModal)
        {
            <div class="sv-modal sv-modal-backdrop sv-modal-fixed">
                <div class="sv-modal-content">
                    <div class="sv-modal-header">
                        <h2>Bulk Reject Confirmation</h2>
                    </div>
                    <div class="sv-modal-body">
                        <p class="sv-modal-justify">
                            Are you sure you want to <b>reject @selectedUserIds.Count selected request(s)</b>?<br />
                            <span>These accounts will be archived.</span>
                        </p>
                    </div>
                    <div class="sv-modal-footer" style="display:flex;gap:16px;justify-content:flex-end;">
                        <button class="sv-btn sv-btn-secondary" @onclick="CancelBulkReject">Cancel</button>
                        <button class="sv-btn sv-btn-primary" @onclick="ConfirmBulkReject">Reject All</button>
                    </div>
                </div>
            </div>
        }
        
        <div class="table-header">
            <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                <div style="position: relative; flex: 1; max-width: 400px;">
                    <i class="bi bi-search" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #64748b; z-index: 1;"></i>
                    <input class="university-input" type="text" placeholder="Search users..." 
                        style="padding-left: 45px; padding-right: 38px; width: 100%;" 
                        @bind="searchQuery" @bind:event="oninput" />
                    @if (!string.IsNullOrEmpty(searchQuery))
                    {
                        <button type="button" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #64748b; font-size: 1.2rem; cursor: pointer;" @onclick="ClearSearch">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    }
                </div>
                <div style="display: flex; align-items: center; gap: 1rem; margin-left: auto;">
                    @if (activeFilter == "Requests")
                    {
                        <select class="form-select" style="width: 160px; min-width: 120px;" @onchange="OnRequestTypeDropdownChanged" value="@requestTypeDropdownValue">
                            <option value="All">All Requests</option>
                            <option value="Institution">Institutions</option>
                            <option value="Student">Students</option>
                            <option value="Benefactor">Benefactors</option>
                        </select>
                    }
                    <div class="table-actions" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-outline-primary btn-sm" @onclick="RefreshUsers">
                            <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                        </button>
                        @if (activeFilter == "Student" || activeFilter == "Institution" || activeFilter == "Benefactor")
                        {
                            <button class="btn btn-outline-warning btn-sm" @onclick="ShowBulkArchiveModal" title="Bulk Archive">
                                <i class="bi bi-archive"></i>
                            </button>
                        }
                        @if (activeFilter == "Requests")
                        {
                            <button class="btn btn-outline-success btn-sm" @onclick="ShowBulkAcceptModal" title="Bulk Accept">
                                <i class="bi bi-check"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" @onclick="ShowBulkRejectModal" title="Bulk Reject">
                                <i class="bi bi-x"></i>
                            </button>
                        }
                        @if (activeFilter == "Archive" || activeFilter == "Unverified")
                        {
                            <button class="btn btn-outline-danger btn-sm" @onclick="ShowBulkDeleteModal" title="Bulk Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>

        @if (isLoading)
        {
            <div class="loading-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading users...</p>
            </div>
        }
        else if (activeFilter == "Requests")
        {
            if (!showInstitutionRequestsTable)
            {
                showInstitutionRequestsTable = true;
                _ = LoadPendingInstitutions();
            }
            if (isLoadingRequests)
            {
                <div class="loading-container">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading requests...</p>
                </div>
            }
            else if (filteredRequests != null && filteredRequests.Any())
            {
                <div class="table-responsive">
                    <table class="table users-table" style="table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" @onchange="() => ToggleSelectAllRequests()" 
                                           checked="@(selectedUserIds.Count > 0 && filteredRequests.All(r => selectedUserIds.Contains(r.Id ?? "")))" />
                                </th>
                                <th style="width: 200px; white-space: nowrap;">Name</th>
                                <th style="width: 220px; white-space: nowrap;">Affiliation</th>
                                <th style="width: 140px; white-space: nowrap;">Registered</th>
                                <th style="width: 140px; white-space: nowrap; padding-right: 2.5rem;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var inst in filteredRequests)
                            {
                                var requestId = inst.Id ?? "";
                                <tr class="selectable-row @(selectedUserIds.Contains(requestId) ? "selected" : "")" 
                                    @onclick="@(() => ToggleUserSelection(requestId))"
                                    style="cursor: pointer;">
                                    <td @onclick:stopPropagation="true">
                                        <input type="checkbox" 
                                               checked="@selectedUserIds.Contains(requestId)"
                                               @onchange="@(() => ToggleUserSelection(requestId))" />
                                    </td>
                                    <td>
                                        <div class="user-info">
                                            <div class="user-details">
                                                <div class="user-name">@(inst.Name ?? "No Name")</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>@inst.InstitutionName</td>
                                    <td>@inst.SubmittedAt.ToString("MMM dd, yyyy")</td>
                                    <td @onclick:stopPropagation="true">
                                        @if (!string.IsNullOrEmpty(inst.Id))
                                        {
                                            <div class="action-buttons" style="padding-right: 2.5rem;">
                                                <button class="btn btn-accept-light btn-sm me-2" @onclick="async () => await AcceptInstitution(inst.Id!)">Accept</button>
                                                <button class="btn btn-reject-light btn-sm" @onclick="async () => await RejectInstitution(inst.Id!)">Reject</button>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">No actions available</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="bi bi-inbox" style="font-size: 2rem; color: #ccc;"></i>
                    <h6>@(string.IsNullOrEmpty(searchQuery) ? "No pending requests found." : $"No requests found matching \"{searchQuery}\".")</h6>
                </div>
            }
        }
        else if (activeFilter == "Archive")
        {
            // Force recalculation by using render key
            var _ = archiveRenderKey; // Reference the key to ensure re-evaluation
            
            var archivedUsers = allUsers.Where(u =>
                (studentProfilesByUserId.TryGetValue(u.Id, out var student) && student.AccountStatus == "Archived") ||
                (institutionProfilesByUserId.TryGetValue(u.Id, out var institution) && institution.AccountStatus == "Archived") ||
                (benefactorProfilesByUserId.TryGetValue(u.Id, out var benefactor) && benefactor.AccountStatus == "Archived")
            ).ToList();
            
            Console.WriteLine($"[DEBUG] Archive tab rendering - Found {archivedUsers.Count} archived users (render key: {archiveRenderKey})");
            
            if (archivedUsers.Any())
            {
                <div class="table-responsive">
                    <table class="table users-table" style="table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" 
                                           @onchange="() => ToggleSelectAll(archivedUsers)" 
                                           checked="@(selectedUserIds.Count > 0 && archivedUsers.All(u => selectedUserIds.Contains(u.Id)))"
                                           style="cursor: pointer;" />
                                </th>
                                <th style="width: 240px; white-space: nowrap;">Name</th>
                                <th style="width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Email</th>
                                <th style="width: 90px; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var archivedUser in archivedUsers.Take(pageSize))
                            {
                                string archivedFullName = "No Name";
                                string archivedAffiliation = "Unknown";
                                if (studentProfilesByUserId.TryGetValue(archivedUser.Id, out var studentProfile))
                                {
                                    archivedFullName = $"{studentProfile.FirstName} {(string.IsNullOrEmpty(studentProfile.MiddleName) ? "" : studentProfile.MiddleName + " ")}{studentProfile.LastName}";
                                    archivedAffiliation = !string.IsNullOrEmpty(studentProfile.UniversityName) ? studentProfile.UniversityName : "Unknown Institution";
                                }
                                else if (institutionProfilesByUserId.TryGetValue(archivedUser.Id, out var institutionProfile))
                                {
                                    archivedFullName = $"{institutionProfile.AdminFirstName} {(string.IsNullOrEmpty(institutionProfile.AdminMiddleName) ? "" : institutionProfile.AdminMiddleName + " ")}{institutionProfile.AdminLastName}";
                                    archivedAffiliation = !string.IsNullOrEmpty(institutionProfile.InstitutionName) ? institutionProfile.InstitutionName : "Unknown Institution";
                                }
                                else if (benefactorProfilesByUserId.TryGetValue(archivedUser.Id, out var benefactorProfile))
                                {
                                    archivedFullName = $"{benefactorProfile.AdminFirstName} {(string.IsNullOrEmpty(benefactorProfile.AdminMiddleName) ? "" : benefactorProfile.AdminMiddleName + " ")}{benefactorProfile.AdminLastName}";
                                    archivedAffiliation = !string.IsNullOrEmpty(benefactorProfile.OrganizationName) ? benefactorProfile.OrganizationName : "Unknown Organization";
                                }
                                <tr class="selectable-row @(selectedUserIds.Contains(archivedUser.Id) ? "selected" : "")"
                                    @onclick="@(() => ToggleUserSelection(archivedUser.Id))"
                                    style="cursor: pointer;">
                                    <td @onclick:stopPropagation="true">
                                        <input type="checkbox" 
                                               @onchange="() => ToggleUserSelection(archivedUser.Id)" 
                                               checked="@selectedUserIds.Contains(archivedUser.Id)"
                                               style="cursor: pointer;" />
                                    </td>
                                    <td>
                                        <div class="user-info">
                                            <div class="user-details">
                                                <div class="user-name">@archivedFullName</div>
                                                <div class="user-institution">@archivedAffiliation</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@archivedUser.Email</td>
                                    <td @onclick:stopPropagation="true">
                                        <div class="action-buttons">
                                            <button class="btn btn-accept-light btn-sm me-2" @onclick="() => PromptRestoreUser(archivedUser.Id)" title="Restore User">Restore</button>
                                            <button class="btn btn-reject-light btn-sm" @onclick="() => PromptPermanentDeleteUser(archivedUser.Id)" title="Permanently Delete User">Remove</button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                @if (archivedUsers.Count > pageSize)
                {
                    <div class="pagination-container">
                        <button class="btn btn-outline-primary" @onclick="LoadMoreUsers">
                            Load More Users (@(archivedUsers.Count - pageSize) remaining)
                        </button>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <i class="bi bi-people" style="font-size: 4rem; color: #ccc;"></i>
                    <h4>No Users Found</h4>
                    <p>@(string.IsNullOrEmpty(searchQuery) ? "No users match the current filter." : $"No users found matching \"{searchQuery}\".")</p>
                </div>
            }
        }
        else if (activeFilter == "Unverified")
        {
            // Debug logging for unverified users calculation
            Console.WriteLine($"[DEBUG] Calculating unverified users. Total users: {allUsers.Count}");
            Console.WriteLine($"[DEBUG] Student profiles: {studentProfilesByUserId.Count}");
            Console.WriteLine($"[DEBUG] Institution profiles: {institutionProfilesByUserId.Count}");
            Console.WriteLine($"[DEBUG] Benefactor profiles: {benefactorProfilesByUserId.Count}");
            
            // Get users who have roles but no profiles (unverified users)
            var unverifiedUsers = allUsers.Where(u =>
            {
                // Check if user has no profile
                bool hasNoProfile = !studentProfilesByUserId.ContainsKey(u.Id) &&
                                   !institutionProfilesByUserId.ContainsKey(u.Id) &&
                                   !benefactorProfilesByUserId.ContainsKey(u.Id);
                
                // Exclude SuperAdmin users
                if (userRoles.TryGetValue(u.Id, out var role) && role == "SuperAdmin")
                    return false;
                
                // Debug log each user evaluation
                if (hasNoProfile)
                {
                    Console.WriteLine($"[DEBUG] Unverified user found: {u.Email} (ID: {u.Id})");
                }
                
                return hasNoProfile;
            });

            // Apply search filter if provided
            if (!string.IsNullOrEmpty(searchQuery))
            {
                unverifiedUsers = unverifiedUsers.Where(u => 
                    u.Email?.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) == true);
            }

            var unverifiedUsersList = unverifiedUsers.ToList();

            if (unverifiedUsersList.Any())
            {
                <div class="table-responsive">
                    <table class="table users-table" style="table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" 
                                           @onchange="() => ToggleSelectAll(unverifiedUsersList)" 
                                           checked="@(selectedUserIds.Count > 0 && unverifiedUsersList.All(u => selectedUserIds.Contains(u.Id)))"
                                           style="cursor: pointer;" />
                                </th>
                                <th style="width: 180px; white-space: nowrap;">Email</th>
                                <th style="width: 100px; white-space: nowrap;">Intended Role</th>
                                <th style="width: 130px; white-space: nowrap;">Registration Date</th>
                                <th style="width: 90px; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var unverifiedUser in unverifiedUsersList.Take(pageSize))
                            {
                                string intendedRole = "Unknown";
                                if (userRoles.TryGetValue(unverifiedUser.Id, out var userRole))
                                {
                                    intendedRole = userRole;
                                }

                                // For now, we'll use a placeholder for registration date since IdentityUser doesn't have it built-in
                                string registrationDate = "Unknown";
                                
                                <tr class="selectable-row @(selectedUserIds.Contains(unverifiedUser.Id) ? "selected" : "")"
                                    @onclick="@(() => ToggleUserSelection(unverifiedUser.Id))"
                                    style="cursor: pointer;">
                                    <td @onclick:stopPropagation="true">
                                        <input type="checkbox" 
                                               @onchange="() => ToggleUserSelection(unverifiedUser.Id)" 
                                               checked="@selectedUserIds.Contains(unverifiedUser.Id)"
                                               style="cursor: pointer;" />
                                    </td>
                                    <td style="max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        @unverifiedUser.Email
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">@intendedRole</span>
                                    </td>
                                    <td style="font-size: 0.9rem; color: #666;">
                                        @registrationDate
                                    </td>
                                    <td @onclick:stopPropagation="true">
                                        <div class="action-buttons">
                                            <button class="btn btn-danger btn-sm" @onclick="() => PromptDeleteUnverifiedUser(unverifiedUser.Id)" title="Delete Account">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                @if (unverifiedUsersList.Count > pageSize)
                {
                    <div class="pagination-container">
                        <button class="btn btn-outline-primary" @onclick="LoadMoreUsers">
                            Load More Users (@(unverifiedUsersList.Count - pageSize) remaining)
                        </button>
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <i class="bi bi-person-x" style="font-size: 4rem; color: #ccc;"></i>
                    <h4>No Unverified Users Found</h4>
                    <p>@(string.IsNullOrEmpty(searchQuery) ? "All registered users have submitted verification forms." : $"No unverified users found matching \"{searchQuery}\".")</p>
                </div>
            }
        }
        else
        {
            <div class="table-responsive">
                <table class="table users-table" style="table-layout: fixed;">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" @onchange="() => ToggleSelectAll(filteredUsers.Take(pageSize).ToList())" 
                                       checked="@(selectedUserIds.Count > 0 && filteredUsers.Take(pageSize).All(u => selectedUserIds.Contains(u.Id)))" />
                            </th>
                            <th style="width: 280px; white-space: nowrap;">Name</th>
                            <th style="width: 240px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Email</th>
                            <th style="width: 32px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in filteredUsers.Take(pageSize))
                        {
                            string fullName = "No Name";
                            string affiliation = "Unknown";
                            if (studentProfilesByUserId.TryGetValue(user.Id, out var student))
                            {
                                fullName = $"{student.FirstName} {(string.IsNullOrEmpty(student.MiddleName) ? "" : student.MiddleName + " ")}{student.LastName}";
                                affiliation = !string.IsNullOrEmpty(student.UniversityName) ? student.UniversityName : "Unknown Institution";
                            }
                            else if (institutionProfilesByUserId.TryGetValue(user.Id, out var institution))
                            {
                                fullName = $"{institution.AdminFirstName} {(string.IsNullOrEmpty(institution.AdminMiddleName) ? "" : institution.AdminMiddleName + " ")}{institution.AdminLastName}";
                                affiliation = !string.IsNullOrEmpty(institution.InstitutionName) ? institution.InstitutionName : "Unknown Institution";
                            }
                            else if (benefactorProfilesByUserId.TryGetValue(user.Id, out var benefactor))
                            {
                                fullName = $"{benefactor.AdminFirstName} {(string.IsNullOrEmpty(benefactor.AdminMiddleName) ? "" : benefactor.AdminMiddleName + " ")}{benefactor.AdminLastName}";
                                affiliation = !string.IsNullOrEmpty(benefactor.OrganizationName) ? benefactor.OrganizationName : "Unknown Organization";
                            }
                            <tr class="selectable-row @(selectedUserIds.Contains(user.Id) ? "selected" : "")"
                                @onclick="@(() => ToggleUserSelection(user.Id))"
                                style="cursor: pointer;">
                                <td @onclick:stopPropagation="true">
                                    <input type="checkbox" @onchange="() => ToggleUserSelection(user.Id)" 
                                           checked="@selectedUserIds.Contains(user.Id)" />
                                </td>
                                <td>
                                    <div class="user-info">
                                        <div class="user-details">
                                            <div class="user-name">@fullName</div>
                                            <div class="user-institution">@affiliation</div>
                                        </div>
                                    </div>
                                </td>
                                <td style="max-width: 240px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@user.Email</td>
                                <td @onclick:stopPropagation="true">
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-outline-warning" @onclick="() => PromptDeleteUser(user.Id)" title="Archive User">
                                            <i class="bi bi-archive"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            @if (filteredUsers.Count() > pageSize)
            {
                <div class="pagination-container">
                    <button class="btn btn-outline-primary" @onclick="LoadMoreUsers">
                        Load More Users (@(filteredUsers.Count() - pageSize) remaining)
                    </button>
                </div>
            }
        }
    </div>
</div>


@code {
    private string? currentUserName;
    private string? currentUserEmail;
    private List<IdentityUser> allUsers = new();
    private IEnumerable<IdentityUser> filteredUsers = new List<IdentityUser>();
    private Dictionary<string, string> userRoles = new();
    private Dictionary<string, string> userAccountStatuses = new();
    // Profile caches for instant lookup
    private Dictionary<string, StudentProfile> studentProfilesByUserId = new();
    private Dictionary<string, InstitutionProfile> institutionProfilesByUserId = new();
    private Dictionary<string, BenefactorProfile> benefactorProfilesByUserId = new();
    
    private int totalUsers = 0;
    private int studentCount = 0;
    private int institutionCount = 0;
    private int benefactorCount = 0;
    private int superAdminCount = 0;
    private int totalRequests = 0;
    private int totalArchived = 0;
    private int unverifiedCount = 0;
    
    private string activeFilter = "Student";
    // Only for requests tab
    private string requestTypeDropdownValue = "All";
    
    // Bulk selection state
    private HashSet<string> selectedUserIds = new();
    private bool showBulkDeleteConfirmModal = false;
    private bool showBulkArchiveConfirmModal = false;
    private bool showBulkAcceptConfirmModal = false;
    private bool showBulkRejectConfirmModal = false;
    
    // Render key to force re-evaluation of Archive tab
    private int archiveRenderKey = 0;
    
    // Only for requests tab
    private void OnRequestTypeDropdownChanged(ChangeEventArgs e)
    {
        var selected = e.Value?.ToString() ?? "All";
        requestTypeDropdownValue = selected;
        ApplyFilter();
    }
    
    private void ToggleUserSelection(string userId)
    {
        if (selectedUserIds.Contains(userId))
        {
            selectedUserIds.Remove(userId);
        }
        else
        {
            selectedUserIds.Add(userId);
        }
        StateHasChanged();
    }
    
    private void ToggleSelectAll(List<IdentityUser> users)
    {
        if (selectedUserIds.Count == users.Count && users.All(u => selectedUserIds.Contains(u.Id)))
        {
            selectedUserIds.Clear();
        }
        else
        {
            selectedUserIds.Clear();
            foreach (var user in users)
            {
                selectedUserIds.Add(user.Id);
            }
        }
        StateHasChanged();
    }
    
    private void ToggleSelectAllRequests()
    {
        var requestIds = filteredRequests.Where(r => !string.IsNullOrEmpty(r.Id)).Select(r => r.Id!).ToList();
        
        if (selectedUserIds.Count > 0 && requestIds.All(id => selectedUserIds.Contains(id)))
        {
            // Deselect all
            foreach (var id in requestIds)
            {
                selectedUserIds.Remove(id);
            }
        }
        else
        {
            // Select all
            foreach (var id in requestIds)
            {
                selectedUserIds.Add(id);
            }
        }
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            _cts.Cancel();
            if (_loadTask != null)
            {
                try { await _loadTask; } catch (OperationCanceledException) { }
                catch (Exception ex) { Console.WriteLine($"Exception while awaiting load task during DisposeAsync: {ex.Message}"); }
            }
        }
        finally
        {
            _cts.Dispose();
        }
    }
    private string searchQuery
    {
        get => _searchQuery;
        set
        {
            if (_searchQuery != value)
            {
                _searchQuery = value;
                ApplyFilter();
                StateHasChanged();
            }
        }
    }
    private string _searchQuery = "";
    private int pageSize = 25;
    private bool isLoading = true;
    
    // Thread-safety for loading data
    private readonly SemaphoreSlim loadingSemaphore = new SemaphoreSlim(1, 1);

    // Cancellation & in-flight task tracking for graceful teardown
    private readonly CancellationTokenSource _cts = new();
    private Task? _loadTask;

    protected override async Task OnInitializedAsync()
    {
        if (loadingSemaphore.CurrentCount == 0) return;

        bool entered = false;
        try
        {
            await loadingSemaphore.WaitAsync(_cts.Token);
            entered = true;

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                currentUserName = user.Identity.Name;
                currentUserEmail = user.FindFirst("email")?.Value;
            }

            _loadTask = LoadUsersData(_cts.Token);
            await _loadTask;
        }
        catch (OperationCanceledException)
        {
            return;
        }
        catch (ObjectDisposedException)
        {
            return;
        }
        finally
        {
            if (entered)
            {
                try { loadingSemaphore.Release(); } catch (ObjectDisposedException) { }
            }
        }
    }

    private async Task LoadUsersData(CancellationToken ct = default)
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            Console.WriteLine("[DEBUG] LoadUsersData: Starting to load users data...");
            using var context = DbContextFactory.CreateDbContext();
            // Load all users
            allUsers = await UserManager.Users.ToListAsync(ct);
            totalUsers = allUsers.Count;
            Console.WriteLine($"[DEBUG] LoadUsersData: Loaded {totalUsers} users from UserManager");
            // Bulk load all profiles and cache by UserId
            studentProfilesByUserId = (await context.StudentProfiles.ToListAsync(ct))
                .ToDictionary(sp => sp.UserId ?? "", sp => sp);
            institutionProfilesByUserId = (await context.InstitutionProfiles.ToListAsync(ct))
                .ToDictionary(ip => ip.UserId ?? "", ip => ip);
            benefactorProfilesByUserId = (await context.BenefactorProfiles.ToListAsync(ct))
                .ToDictionary(bp => bp.UserId ?? "", bp => bp);
            // Load role counts and user roles
            await LoadUserRoles();
            // Load verification statuses
            await LoadUserVerificationStatuses(ct);
            // Calculate totalArchived
            totalArchived = allUsers.Count(u =>
                (studentProfilesByUserId.TryGetValue(u.Id, out var student) && student.AccountStatus == "Archived") ||
                (institutionProfilesByUserId.TryGetValue(u.Id, out var institution) && institution.AccountStatus == "Archived") ||
                (benefactorProfilesByUserId.TryGetValue(u.Id, out var benefactor) && benefactor.AccountStatus == "Archived")
            );
            // Calculate unverified count (users with roles but no profiles, excluding SuperAdmin)
            unverifiedCount = allUsers.Count(u =>
                !studentProfilesByUserId.ContainsKey(u.Id) &&
                !institutionProfilesByUserId.ContainsKey(u.Id) &&
                !benefactorProfilesByUserId.ContainsKey(u.Id) &&
                (!userRoles.TryGetValue(u.Id, out var role) || role != "SuperAdmin")
            );
            // Apply current filter
            ApplyFilter();
            Console.WriteLine($"LoadUsersData: Loaded {totalUsers} users successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading users data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task LoadUserRoles()
    {
        try
        {
            userRoles.Clear();
            studentCount = 0;
            institutionCount = 0;
            benefactorCount = 0;
            superAdminCount = 0;
            
            foreach (var user in allUsers)
            {
                var roles = await UserManager.GetRolesAsync(user);
                var role = roles.FirstOrDefault() ?? "Unknown";
                userRoles[user.Id] = role;
                
                // Count by role
                switch (role)
                {
                    case "Student":
                        studentCount++;
                        break;
                    case "Institution":
                        institutionCount++;
                        break;
                    case "Benefactor":
                        benefactorCount++;
                        break;
                    case "SuperAdmin":
                        superAdminCount++;
                        break;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user roles: {ex.Message}");
        }
    }
    
    private string GetUserRole(string userId)
    {
        return userRoles.TryGetValue(userId, out var role) ? role : "Unknown";
    }
    
    private async Task LoadUserVerificationStatuses(CancellationToken ct = default)
    {
        try
        {
            userAccountStatuses.Clear();
            using var context = DbContextFactory.CreateDbContext();
            
            // Load all account statuses in bulk
            var studentStatuses = await context.StudentProfiles
                .Select(sp => new { sp.UserId, sp.AccountStatus })
                .ToListAsync(ct);
                
            var institutionStatuses = await context.InstitutionProfiles
                .Select(ip => new { ip.UserId, ip.AccountStatus })
                .ToListAsync(ct);
                
            var benefactorStatuses = await context.BenefactorProfiles
                .Select(bp => new { bp.UserId, bp.AccountStatus })
                .ToListAsync(ct);
            
            // Populate the dictionary
            foreach (var status in studentStatuses)
                userAccountStatuses[status.UserId] = status.AccountStatus ?? "Unverified";
                
            foreach (var status in institutionStatuses)
                userAccountStatuses[status.UserId] = status.AccountStatus ?? "Unverified";
                
            foreach (var status in benefactorStatuses)
                userAccountStatuses[status.UserId] = status.AccountStatus ?? "Unverified";
            
            // Set SuperAdmins as verified
            foreach (var user in allUsers)
            {
                var role = GetUserRole(user.Id);
                if (role == "SuperAdmin")
                {
                    userAccountStatuses[user.Id] = "Verified";
                }
                else if (!userAccountStatuses.ContainsKey(user.Id))
                {
                    // Fall back to email confirmation for users without profiles
                    userAccountStatuses[user.Id] = user.EmailConfirmed ? "Verified" : "Unverified";
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user account statuses: {ex.Message}");
        }
    }
    
    private string GetUserVerificationStatus(string userId)
    {
        return userAccountStatuses.TryGetValue(userId, out var status) ? status : "Unverified";
    }
    
    private void SetFilter(string filter)
    {
        activeFilter = filter;
        selectedUserIds.Clear(); // Clear selection when changing tabs
        ApplyFilter();
    }
    
    private void ApplyFilter()
    {
        try
        {
            Console.WriteLine($"ApplyFilter called - Search query: '{searchQuery}', Active filter: '{activeFilter}', Total users: {allUsers.Count}");

            // Handle Requests tab filtering separately
            if (activeFilter == "Requests")
            {
                var reqs = pendingInstitutions.AsEnumerable();

                if (requestTypeDropdownValue != "All")
                {
                    reqs = reqs.Where(r => string.Equals(r.InstitutionType, requestTypeDropdownValue, StringComparison.OrdinalIgnoreCase));
                    Console.WriteLine($"After request type filter: {reqs.Count()} requests");
                }

                if (!string.IsNullOrEmpty(searchQuery))
                {
                    var q = searchQuery.ToLower();
                    reqs = reqs.Where(r =>
                        (r.Name?.ToLower().Contains(q) ?? false) ||
                        (r.InstitutionName?.ToLower().Contains(q) ?? false) ||
                        (r.Email?.ToLower().Contains(q) ?? false) ||
                        (r.Id?.ToLower().Contains(q) ?? false));
                    Console.WriteLine($"After request search filter: {reqs.Count()} requests");
                }

                filteredRequests = reqs.OrderBy(r => r.SubmittedAt);
                Console.WriteLine($"Final filtered requests count: {filteredRequests.Count()}");
                StateHasChanged();
                return;
            }

            // Filter regular users
            var filtered = allUsers.AsEnumerable();

            // Apply role filter - now all filters are specific role filters
            filtered = filtered.Where(u => GetUserRole(u.Id) == activeFilter);
            Console.WriteLine($"After role filter: {filtered.Count()} users");

            // For Students tab, only show verified students
            if (activeFilter == "Student")
            {
                using var context = DbContextFactory.CreateDbContext();
                var verifiedStudentIds = context.StudentProfiles
                    .Where(sp => sp.AccountStatus == "Verified")
                    .Select(sp => sp.UserId)
                    .ToHashSet();
                filtered = filtered.Where(u => verifiedStudentIds.Contains(u.Id));
                Console.WriteLine($"After verified filter: {filtered.Count()} users");
            }
            // For Institutions tab, only show verified institutions
            if (activeFilter == "Institution")
            {
                using var context = DbContextFactory.CreateDbContext();
                var verifiedInstitutionIds = context.InstitutionProfiles
                    .Where(ip => ip.AccountStatus == "Verified")
                    .Select(ip => ip.UserId)
                    .ToHashSet();
                filtered = filtered.Where(u => verifiedInstitutionIds.Contains(u.Id));
                Console.WriteLine($"After verified institution filter: {filtered.Count()} users");
            }
            // For Benefactor tab, only show verified benefactors
            if (activeFilter == "Benefactor")
            {
                using var context = DbContextFactory.CreateDbContext();
                var verifiedBenefactorIds = context.BenefactorProfiles
                    .Where(bp => bp.AccountStatus == "Verified")
                    .Select(bp => bp.UserId)
                    .ToHashSet();
                filtered = filtered.Where(u => verifiedBenefactorIds.Contains(u.Id));
                Console.WriteLine($"After verified benefactor filter: {filtered.Count()} users");
            }

            // Apply search filter
            if (!string.IsNullOrEmpty(searchQuery))
            {
                var query = searchQuery.ToLower();
                filtered = filtered.Where(u =>
                    (u.UserName?.ToLower().Contains(query) ?? false) ||
                    (u.Email?.ToLower().Contains(query) ?? false) ||
                    (u.Id?.ToLower().Contains(query) ?? false));
                Console.WriteLine($"After search filter: {filtered.Count()} users");
            }

            filteredUsers = filtered.OrderBy(u => u.UserName);
            Console.WriteLine($"Final filtered users count: {filteredUsers.Count()}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in ApplyFilter: {ex.Message}");
        }
    }
    
    // FilterUsers method removed; filtering now handled by searchQuery setter


    
    private void ClearSearch()
    {
        searchQuery = "";
        ApplyFilter();
    }
    
    private async Task RefreshUsers()
    {
        Console.WriteLine("[DEBUG] RefreshUsers: Starting refresh...");
        await LoadUsersData();
        Console.WriteLine("[DEBUG] RefreshUsers: LoadUsersData completed");
    await LoadUserVerificationStatuses(_cts.Token);
        Console.WriteLine("[DEBUG] RefreshUsers: LoadUserVerificationStatuses completed");
    }
    
    private void LoadMoreUsers()
    {
        pageSize += 25;
        StateHasChanged();
    }
    
    // Placeholder methods for user actions
    private void ShowCreateUserModal()
    {
        // TODO: Implement create user modal
        Console.WriteLine("Create user modal - To be implemented");
    }
    
    private void ShowBulkDeleteModal()
    {
        if (selectedUserIds.Count == 0)
        {
            Console.WriteLine("No users selected for bulk delete");
            return;
        }
        showBulkDeleteConfirmModal = true;
        StateHasChanged();
    }
    
    private void CancelBulkDelete()
    {
        showBulkDeleteConfirmModal = false;
        StateHasChanged();
    }
    
    private void ShowBulkArchiveModal()
    {
        if (selectedUserIds.Count == 0)
        {
            Console.WriteLine("No users selected for bulk archive");
            return;
        }
        showBulkArchiveConfirmModal = true;
        StateHasChanged();
    }
    
    private void CancelBulkArchive()
    {
        showBulkArchiveConfirmModal = false;
        StateHasChanged();
    }
    
    private void ShowBulkAcceptModal()
    {
        if (selectedUserIds.Count == 0)
        {
            Console.WriteLine("No requests selected for bulk accept");
            return;
        }
        showBulkAcceptConfirmModal = true;
        StateHasChanged();
    }
    
    private void CancelBulkAccept()
    {
        showBulkAcceptConfirmModal = false;
        StateHasChanged();
    }
    
    private void ShowBulkRejectModal()
    {
        if (selectedUserIds.Count == 0)
        {
            Console.WriteLine("No requests selected for bulk reject");
            return;
        }
        showBulkRejectConfirmModal = true;
        StateHasChanged();
    }
    
    private void CancelBulkReject()
    {
        showBulkRejectConfirmModal = false;
        StateHasChanged();
    }
    
    private async Task ConfirmBulkAccept()
    {
        if (selectedUserIds.Count == 0) return;
        
        Console.WriteLine($"[DEBUG] Starting bulk accept of {selectedUserIds.Count} requests");
        
        try
        {
            foreach (var userId in selectedUserIds.ToList())
            {
                Console.WriteLine($"[DEBUG] Accepting request: {userId}");
                await AcceptInstitution(userId);
            }
            
            Console.WriteLine($"[DEBUG] Bulk accept completed. Updating UI...");
            
            // Refresh pending list and counts
            await RefreshPendingAndUsers();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[DEBUG] Error during bulk accept: {ex.Message}");
            Console.WriteLine($"[DEBUG] Stack trace: {ex.StackTrace}");
        }
        finally
        {
            showBulkAcceptConfirmModal = false;
            selectedUserIds.Clear();
            StateHasChanged();
        }
    }
    
    private async Task ConfirmBulkReject()
    {
        if (selectedUserIds.Count == 0) return;
        
        Console.WriteLine($"[DEBUG] Starting bulk reject of {selectedUserIds.Count} requests");
        
        try
        {
            foreach (var userId in selectedUserIds.ToList())
            {
                Console.WriteLine($"[DEBUG] Rejecting request: {userId}");
                await RejectInstitution(userId);
            }
            
            Console.WriteLine($"[DEBUG] Bulk reject completed. Updating UI...");
            
            // Refresh pending list and counts
            await RefreshPendingAndUsers();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[DEBUG] Error during bulk reject: {ex.Message}");
            Console.WriteLine($"[DEBUG] Stack trace: {ex.StackTrace}");
        }
        finally
        {
            showBulkRejectConfirmModal = false;
            selectedUserIds.Clear();
            StateHasChanged();
        }
    }
    
    private async Task ConfirmBulkArchive()
    {
        if (selectedUserIds.Count == 0) return;
        
        Console.WriteLine($"[DEBUG] Starting bulk archive of {selectedUserIds.Count} users");
        
        try
        {
            await using var context = DbContextFactory.CreateDbContext();
            
            foreach (var userId in selectedUserIds.ToList())
            {
                Console.WriteLine($"[DEBUG] Archiving user: {userId}");
                
                // Archive profile
                var student = await context.StudentProfiles.FirstOrDefaultAsync(sp => sp.UserId == userId);
                if (student != null)
                {
                    student.AccountStatus = "Archived";
                    context.StudentProfiles.Update(student);
                    await context.SaveChangesAsync();
                    
                    // Update local cache
                    if (studentProfilesByUserId.ContainsKey(userId))
                    {
                        studentProfilesByUserId[userId].AccountStatus = "Archived";
                    }
                    userAccountStatuses[userId] = "Archived";
                    Console.WriteLine($"[DEBUG] Student {userId} marked as Archived.");
                }
                else
                {
                    var institution = await context.InstitutionProfiles.FirstOrDefaultAsync(ip => ip.UserId == userId);
                    if (institution != null)
                    {
                        institution.AccountStatus = "Archived";
                        context.InstitutionProfiles.Update(institution);
                        await context.SaveChangesAsync();
                        
                        // Update local cache
                        if (institutionProfilesByUserId.ContainsKey(userId))
                        {
                            institutionProfilesByUserId[userId].AccountStatus = "Archived";
                        }
                        userAccountStatuses[userId] = "Archived";
                        Console.WriteLine($"[DEBUG] Institution {userId} marked as Archived.");
                    }
                    else
                    {
                        var benefactor = await context.BenefactorProfiles.FirstOrDefaultAsync(bp => bp.UserId == userId);
                        if (benefactor != null)
                        {
                            benefactor.AccountStatus = "Archived";
                            context.BenefactorProfiles.Update(benefactor);
                            await context.SaveChangesAsync();
                            
                            // Update local cache
                            if (benefactorProfilesByUserId.ContainsKey(userId))
                            {
                                benefactorProfilesByUserId[userId].AccountStatus = "Archived";
                            }
                            userAccountStatuses[userId] = "Archived";
                            Console.WriteLine($"[DEBUG] Benefactor {userId} marked as Archived.");
                        }
                        else
                        {
                            Console.WriteLine($"[DEBUG] No profile found for user {userId}.");
                        }
                    }
                }
            }
            
            Console.WriteLine($"[DEBUG] Bulk archive completed. Updating UI...");
            
            // Recalculate counts
            RecalculateCounts();
            
            // Increment render key to force Archive tab to recalculate
            archiveRenderKey++;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[DEBUG] Error during bulk archive: {ex.Message}");
            Console.WriteLine($"[DEBUG] Stack trace: {ex.StackTrace}");
        }
        finally
        {
            showBulkArchiveConfirmModal = false;
            selectedUserIds.Clear();
            ApplyFilter(); // Reapply filter to update UI without full reload
            StateHasChanged();
        }
    }
    
    private async Task ConfirmBulkDelete()
    {
        if (selectedUserIds.Count == 0)
        {
            Console.WriteLine("[DEBUG] ConfirmBulkDelete called but no users selected");
            return;
        }
        
        Console.WriteLine($"[DEBUG] Starting bulk deletion of {selectedUserIds.Count} users from Archive tab");
        Console.WriteLine($"[DEBUG] Selected user IDs: {string.Join(", ", selectedUserIds)}");
        Console.WriteLine($"[DEBUG] Total users before deletion: {allUsers.Count}");
        
        try
        {
            await using var context = DbContextFactory.CreateDbContext();
            
            foreach (var userId in selectedUserIds.ToList())
            {
                Console.WriteLine($"[DEBUG] Permanently deleting user: {userId}");
                
                // Remove profile from local cache and database
                var student = await context.StudentProfiles.FirstOrDefaultAsync(sp => sp.UserId == userId);
                if (student != null)
                {
                    context.StudentProfiles.Remove(student);
                    await context.SaveChangesAsync();
                    studentProfilesByUserId.Remove(userId);
                    Console.WriteLine($"[DEBUG] Student profile {userId} permanently deleted.");
                }
                else
                {
                    var institution = await context.InstitutionProfiles.FirstOrDefaultAsync(ip => ip.UserId == userId);
                    if (institution != null)
                    {
                        context.InstitutionProfiles.Remove(institution);
                        await context.SaveChangesAsync();
                        institutionProfilesByUserId.Remove(userId);
                        Console.WriteLine($"[DEBUG] Institution profile {userId} permanently deleted.");
                    }
                    else
                    {
                        var benefactor = await context.BenefactorProfiles.FirstOrDefaultAsync(bp => bp.UserId == userId);
                        if (benefactor != null)
                        {
                            context.BenefactorProfiles.Remove(benefactor);
                            await context.SaveChangesAsync();
                            benefactorProfilesByUserId.Remove(userId);
                            Console.WriteLine($"[DEBUG] Benefactor profile {userId} permanently deleted.");
                        }
                        else
                        {
                            Console.WriteLine($"[DEBUG] No profile found for user {userId}.");
                        }
                    }
                }
                
                // Remove IdentityUser from database and local cache
                var identityUser = await UserManager.FindByIdAsync(userId);
                if (identityUser != null)
                {
                    var deleteResult = await UserManager.DeleteAsync(identityUser);
                    Console.WriteLine($"[DEBUG] IdentityUser {userId} deletion result: {deleteResult.Succeeded}");
                    if (!deleteResult.Succeeded)
                    {
                        Console.WriteLine($"[DEBUG] Delete errors: {string.Join(", ", deleteResult.Errors.Select(e => e.Description))}");
                    }
                    else
                    {
                        // Remove from local allUsers list
                        allUsers.RemoveAll(u => u.Id == userId);
                        userRoles.Remove(userId);
                        userAccountStatuses.Remove(userId);
                    }
                }
                else
                {
                    Console.WriteLine($"[DEBUG] IdentityUser {userId} not found for deletion.");
                }
            }
            
            Console.WriteLine($"[DEBUG] Bulk deletion completed. Total users after deletion: {allUsers.Count}");
            Console.WriteLine($"[DEBUG] Updating UI...");
            
            // Recalculate counts
            totalUsers = allUsers.Count;
            RecalculateCounts();
            
            Console.WriteLine($"[DEBUG] New counts - Total: {totalUsers}, Archived: {totalArchived}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[DEBUG] Error during bulk deletion: {ex.Message}");
            Console.WriteLine($"[DEBUG] Stack trace: {ex.StackTrace}");
        }
        finally
        {
            Console.WriteLine($"[DEBUG] Closing modal and clearing selection");
            showBulkDeleteConfirmModal = false;
            selectedUserIds.Clear();
            
            // Increment render key to force Archive tab to recalculate
            archiveRenderKey++;
            
            // Force UI update on the correct synchronization context
            await InvokeAsync(StateHasChanged);
            Console.WriteLine($"[DEBUG] UI should now be updated (render key: {archiveRenderKey})");
        }
    }
    
    private void ViewUser(string userId)
    {
        // TODO: Navigate to user view page
        Console.WriteLine($"View user: {userId}");
    }
    
    private void EditUser(string userId)
    {
        // TODO: Navigate to user edit page
        Console.WriteLine($"Edit user: {userId}");
    }
    
    // --- DELETE CONFIRMATION MODAL STATE ---
    private bool showDeleteModal = false;
    private string? userIdToDelete;
    private string? userNameToDelete;

    // --- PERMANENT DELETE MODAL STATE ---
    private bool showPermanentDeleteModal = false;
    private string? userIdToPermanentDelete;
    private string? userNameToPermanentDelete;

    // --- RESTORE MODAL STATE ---
    private bool showRestoreModal = false;
    private string? userIdToRestore;
    private string? userNameToRestore;

    private void PromptPermanentDeleteUser(string userId)
    {
        userIdToPermanentDelete = userId;
        var user = allUsers.FirstOrDefault(u => u.Id == userId);
        userNameToPermanentDelete = user?.UserName ?? "Unknown User";
        showPermanentDeleteModal = true;
        StateHasChanged();
    }

    private async Task ConfirmPermanentDeleteUser()
    {
        if (string.IsNullOrEmpty(userIdToPermanentDelete)) return;
        
        Console.WriteLine($"[DEBUG] Starting permanent deletion of user: {userIdToPermanentDelete}");
        
        try
        {
            await using var context = DbContextFactory.CreateDbContext();
            
            // Check if user exists before deletion
            var identityUserBeforeDeletion = await UserManager.FindByIdAsync(userIdToPermanentDelete);
            Console.WriteLine($"[DEBUG] User exists before deletion: {identityUserBeforeDeletion != null} (Email: {identityUserBeforeDeletion?.Email})");
            
            // Remove profile from database and local cache
            var student = await context.StudentProfiles.FirstOrDefaultAsync(sp => sp.UserId == userIdToPermanentDelete);
            if (student != null)
            {
                context.StudentProfiles.Remove(student);
                await context.SaveChangesAsync();
                studentProfilesByUserId.Remove(userIdToPermanentDelete);
                Console.WriteLine($"[DEBUG] Student profile {userIdToPermanentDelete} permanently deleted.");
            }
            else
            {
                var institution = await context.InstitutionProfiles.FirstOrDefaultAsync(ip => ip.UserId == userIdToPermanentDelete);
                if (institution != null)
                {
                    context.InstitutionProfiles.Remove(institution);
                    await context.SaveChangesAsync();
                    institutionProfilesByUserId.Remove(userIdToPermanentDelete);
                    Console.WriteLine($"[DEBUG] Institution profile {userIdToPermanentDelete} permanently deleted.");
                }
                else
                {
                    var benefactor = await context.BenefactorProfiles.FirstOrDefaultAsync(bp => bp.UserId == userIdToPermanentDelete);
                    if (benefactor != null)
                    {
                        context.BenefactorProfiles.Remove(benefactor);
                        await context.SaveChangesAsync();
                        benefactorProfilesByUserId.Remove(userIdToPermanentDelete);
                        Console.WriteLine($"[DEBUG] Benefactor profile {userIdToPermanentDelete} permanently deleted.");
                    }
                    else
                    {
                        Console.WriteLine($"[DEBUG] No profile found for user {userIdToPermanentDelete}.");
                    }
                }
            }
            
            // Remove IdentityUser from database and local cache
            var identityUser = await UserManager.FindByIdAsync(userIdToPermanentDelete);
            if (identityUser != null)
            {
                var deleteResult = await UserManager.DeleteAsync(identityUser);
                Console.WriteLine($"[DEBUG] IdentityUser {userIdToPermanentDelete} deletion result: {deleteResult.Succeeded}");
                if (!deleteResult.Succeeded)
                {
                    Console.WriteLine($"[DEBUG] Delete errors: {string.Join(", ", deleteResult.Errors.Select(e => e.Description))}");
                }
                else
                {
                    // Remove from local caches
                    allUsers.RemoveAll(u => u.Id == userIdToPermanentDelete);
                    userRoles.Remove(userIdToPermanentDelete);
                    userAccountStatuses.Remove(userIdToPermanentDelete);
                }
            }
            else
            {
                Console.WriteLine($"[DEBUG] IdentityUser {userIdToPermanentDelete} not found for deletion.");
            }
            
            // Recalculate counts
            totalUsers = allUsers.Count;
            RecalculateCounts();
            
            // Increment render key to force Archive tab to recalculate
            archiveRenderKey++;
            
            Console.WriteLine($"[DEBUG] User permanently deleted. Updating UI...");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[DEBUG] Error permanently deleting user: {ex.Message}");
            Console.WriteLine($"[DEBUG] Stack trace: {ex.StackTrace}");
        }
        
        showPermanentDeleteModal = false;
        ApplyFilter(); // Reapply filter to update UI without full reload
        StateHasChanged();
    }

    private void CancelPermanentDeleteUser()
    {
        showPermanentDeleteModal = false;
        userIdToPermanentDelete = null;
        userNameToPermanentDelete = null;
        StateHasChanged();
    }

    private void PromptRestoreUser(string userId)
    {
        userIdToRestore = userId;
        var user = allUsers.FirstOrDefault(u => u.Id == userId);
        userNameToRestore = user?.UserName ?? "Unknown User";
        showRestoreModal = true;
        StateHasChanged();
    }

    private async Task ConfirmRestoreUser()
    {
        if (string.IsNullOrEmpty(userIdToRestore)) return;
        try
        {
            await using var context = DbContextFactory.CreateDbContext();
            // Try to find the profile type for this user and restore it
            var student = await context.StudentProfiles.FirstOrDefaultAsync(sp => sp.UserId == userIdToRestore);
            if (student != null)
            {
                student.AccountStatus = "Pending";
                student.IsVerified = false;
                context.StudentProfiles.Update(student);
                await context.SaveChangesAsync();
                
                // Update local cache immediately
                if (studentProfilesByUserId.ContainsKey(userIdToRestore))
                {
                    studentProfilesByUserId[userIdToRestore].AccountStatus = "Pending";
                    studentProfilesByUserId[userIdToRestore].IsVerified = false;
                }
                Console.WriteLine($"Student {userIdToRestore} restored to Pending status for review.");
            }
            else
            {
                var institution = await context.InstitutionProfiles.FirstOrDefaultAsync(ip => ip.UserId == userIdToRestore);
                if (institution != null)
                {
                    institution.AccountStatus = "Pending";
                    institution.IsVerified = false;
                    context.InstitutionProfiles.Update(institution);
                    await context.SaveChangesAsync();
                    
                    // Update local cache immediately
                    if (institutionProfilesByUserId.ContainsKey(userIdToRestore))
                    {
                        institutionProfilesByUserId[userIdToRestore].AccountStatus = "Pending";
                        institutionProfilesByUserId[userIdToRestore].IsVerified = false;
                    }
                    Console.WriteLine($"Institution {userIdToRestore} restored to Pending status for review.");
                }
                else
                {
                    var benefactor = await context.BenefactorProfiles.FirstOrDefaultAsync(bp => bp.UserId == userIdToRestore);
                    if (benefactor != null)
                    {
                        benefactor.AccountStatus = "Pending";
                        benefactor.IsVerified = false;
                        context.BenefactorProfiles.Update(benefactor);
                        await context.SaveChangesAsync();
                        
                        // Update local cache immediately
                        if (benefactorProfilesByUserId.ContainsKey(userIdToRestore))
                        {
                            benefactorProfilesByUserId[userIdToRestore].AccountStatus = "Pending";
                            benefactorProfilesByUserId[userIdToRestore].IsVerified = false;
                        }
                        Console.WriteLine($"Benefactor {userIdToRestore} restored to Pending status for review.");
                    }
                    else
                    {
                        Console.WriteLine($"No profile found for user {userIdToRestore}.");
                    }
                }
            }
            
            // Increment render key to force Archive tab to recalculate
            archiveRenderKey++;
            
            // Apply filter to update the UI immediately without full refresh
            ApplyFilter();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error restoring user: {ex.Message}");
        }
        showRestoreModal = false;
        StateHasChanged();
    }

    private void CancelRestoreUser()
    {
        showRestoreModal = false;
        userIdToRestore = null;
        userNameToRestore = null;
        StateHasChanged();
    }

    private void PromptDeleteUser(string userId)
    {
        userIdToDelete = userId;
        var user = allUsers.FirstOrDefault(u => u.Id == userId);
        userNameToDelete = user?.UserName ?? "Unknown User";
        showDeleteModal = true;
        StateHasChanged();
    }

    private async Task ConfirmDeleteUser()
    {
        if (string.IsNullOrEmpty(userIdToDelete)) return;
        try
        {
            await using var context = DbContextFactory.CreateDbContext();
            // Try to find the profile type for this user
            var student = await context.StudentProfiles.FirstOrDefaultAsync(sp => sp.UserId == userIdToDelete);
            if (student != null)
            {
                student.AccountStatus = "Archived";
                context.StudentProfiles.Update(student);
                await context.SaveChangesAsync();
                
                // Update local cache immediately
                if (studentProfilesByUserId.ContainsKey(userIdToDelete))
                {
                    studentProfilesByUserId[userIdToDelete].AccountStatus = "Archived";
                }
                Console.WriteLine($"Student {userIdToDelete} marked as Archived.");
            }
            else
            {
                var institution = await context.InstitutionProfiles.FirstOrDefaultAsync(ip => ip.UserId == userIdToDelete);
                if (institution != null)
                {
                    institution.AccountStatus = "Archived";
                    context.InstitutionProfiles.Update(institution);
                    await context.SaveChangesAsync();
                    
                    // Update local cache immediately
                    if (institutionProfilesByUserId.ContainsKey(userIdToDelete))
                    {
                        institutionProfilesByUserId[userIdToDelete].AccountStatus = "Archived";
                    }
                    Console.WriteLine($"Institution {userIdToDelete} marked as Archived.");
                }
                else
                {
                    var benefactor = await context.BenefactorProfiles.FirstOrDefaultAsync(bp => bp.UserId == userIdToDelete);
                    if (benefactor != null)
                    {
                        benefactor.AccountStatus = "Archived";
                        context.BenefactorProfiles.Update(benefactor);
                        await context.SaveChangesAsync();
                        
                        // Update local cache immediately
                        if (benefactorProfilesByUserId.ContainsKey(userIdToDelete))
                        {
                            benefactorProfilesByUserId[userIdToDelete].AccountStatus = "Archived";
                        }
                        Console.WriteLine($"Benefactor {userIdToDelete} marked as Archived. AccountStatus: {benefactor.AccountStatus}");
                    }
                    else
                    {
                        Console.WriteLine($"No profile found for user {userIdToDelete}.");
                    }
                }
            }
            
            // Increment render key to force Archive tab to recalculate
            archiveRenderKey++;
            
            // Apply filter to update the UI immediately without full refresh
            ApplyFilter();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error marking user as deleted: {ex.Message}");
        }
        showDeleteModal = false;
        StateHasChanged();
    }

    private void CancelDeleteUser()
    {
        showDeleteModal = false;
        userIdToDelete = null;
        userNameToDelete = null;
        StateHasChanged();
    }

    // Handle deletion of unverified users (these can be permanently deleted since they have no profiles)
    private void PromptDeleteUnverifiedUser(string userId)
    {
        userIdToPermanentDelete = userId;
        var user = allUsers.FirstOrDefault(u => u.Id == userId);
        userNameToPermanentDelete = user?.Email ?? "Unknown User";
        showPermanentDeleteModal = true;
        StateHasChanged();
    }
    
    public void Dispose()
    {
        // Avoid disposing the semaphore here to prevent disposal races with
        // any in-flight async operations that may still be releasing it.
        // SemaphoreSlim is a managed resource and can be left for the GC.
    }
    // Institution Requests Table State
    private bool showInstitutionRequestsTable = false;
    private bool isLoadingRequests = false;
    private List<InstitutionRequest> pendingInstitutions = new();
    private IEnumerable<InstitutionRequest> filteredRequests = new List<InstitutionRequest>();


    // Removed ToggleInstitutionRequests, replaced by Requests tab logic

    private async Task LoadPendingInstitutions()
    {
        isLoadingRequests = true;
        StateHasChanged();
        
        // Fetch pending institutions from backend
        pendingInstitutions = await FetchPendingInstitutionsAsync();
        // Update totalRequests after fetching
        totalRequests = pendingInstitutions.Count;
        
        // Apply current filter after loading
        ApplyFilter();
        
        isLoadingRequests = false;
        StateHasChanged();
    }

    private async Task<List<InstitutionRequest>> FetchPendingInstitutionsAsync()
    {
        var requests = new List<InstitutionRequest>();
        try
        {
            await using var context = DbContextFactory.CreateDbContext();
            // Pending Institutions
            var pendingProfiles = context.InstitutionProfiles
                .Where(ip => ip.AccountStatus == "Pending")
                .ToList();
            foreach (var profile in pendingProfiles)
            {
                requests.Add(new InstitutionRequest
                {
                    Id = profile.UserId,
                    Name = profile.AdminFirstName + " " + (string.IsNullOrEmpty(profile.AdminMiddleName) ? "" : profile.AdminMiddleName + " ") + profile.AdminLastName,
                    InstitutionName = profile.InstitutionName,
                    Email = profile.ContactEmail,
                    SubmittedAt = profile.CreatedAt,
                    InstitutionType = "Institution"
                });
            }

            // Pending Students
            var pendingStudents = context.StudentProfiles
                .Where(sp => sp.AccountStatus == "Pending")
                .ToList();
            foreach (var student in pendingStudents)
            {
                requests.Add(new InstitutionRequest
                {
                    Id = student.UserId,
                    Name = student.FirstName + " " + (string.IsNullOrEmpty(student.MiddleName) ? "" : student.MiddleName + " ") + student.LastName,
                    InstitutionName = student.UniversityName ?? "Unknown University",
                    Email = student.Email,
                    SubmittedAt = student.CreatedAt,
                    InstitutionType = "Student"
                });
            }

            // Pending Benefactors
            var pendingBenefactors = context.BenefactorProfiles
                .Where(bp => bp.AccountStatus == "Pending")
                .ToList();
            foreach (var benefactor in pendingBenefactors)
            {
                requests.Add(new InstitutionRequest
                {
                    Id = benefactor.UserId,
                    Name = benefactor.AdminFirstName + " " + (string.IsNullOrEmpty(benefactor.AdminMiddleName) ? "" : benefactor.AdminMiddleName + " ") + benefactor.AdminLastName,
                    InstitutionName = benefactor.OrganizationName ?? "Unknown Organization",
                    Email = benefactor.ContactEmail,
                    SubmittedAt = benefactor.CreatedAt,
                    InstitutionType = "Benefactor"
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching pending institutions: {ex.Message}");
        }
        return requests;
    }

    private async Task AcceptInstitution(string institutionId)
    {
        if (string.IsNullOrEmpty(institutionId)) return;

        Console.WriteLine($"AcceptInstitution: attempting to accept request {institutionId}");

        try
        {
            await using var context = DbContextFactory.CreateDbContext();

            // Find the request type from the local pending list
            var req = pendingInstitutions.FirstOrDefault(i => i.Id == institutionId);
            if (req == null)
            {
                Console.WriteLine($"AcceptInstitution: request {institutionId} not found in pending list");
                return;
            }

            if (req.InstitutionType == "Student")
            {
                var student = await context.StudentProfiles.FirstOrDefaultAsync(sp => sp.UserId == institutionId);
                if (student != null)
                {
                    student.AccountStatus = "Verified";
                    student.IsVerified = true;
                    context.StudentProfiles.Update(student);
                    await context.SaveChangesAsync();
                    
                    // Update local cache immediately
                    if (studentProfilesByUserId.ContainsKey(institutionId))
                    {
                        studentProfilesByUserId[institutionId].AccountStatus = "Verified";
                        studentProfilesByUserId[institutionId].IsVerified = true;
                    }
                    userAccountStatuses[institutionId] = "Verified";
                    
                    Console.WriteLine($"AcceptInstitution: student {institutionId} marked Verified in DB");
                    // Ensure the AspNet Identity user has the Student role so the Students tab filter includes them
                    try
                    {
                        var identityUser = await UserManager.FindByIdAsync(institutionId);
                        if (identityUser != null)
                        {
                            var roles = await UserManager.GetRolesAsync(identityUser);
                            if (!roles.Contains("Student"))
                            {
                                var addRoleResult = await UserManager.AddToRoleAsync(identityUser, "Student");
                                if (addRoleResult.Succeeded)
                                {
                                    Console.WriteLine($"AcceptInstitution: added 'Student' role to user {institutionId}");
                                }
                                else
                                {
                                    Console.WriteLine($"AcceptInstitution: failed to add 'Student' role to user {institutionId}: {string.Join(',', addRoleResult.Errors.Select(e => e.Description))}");
                                }
                            }
                        }
                        else
                        {
                            Console.WriteLine($"AcceptInstitution: Identity user {institutionId} not found to add role");
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"AcceptInstitution: error ensuring Student role for {institutionId}: {ex.Message}");
                    }
                }
                else
                {
                    Console.WriteLine($"AcceptInstitution: student record for {institutionId} not found in DB");
                }
            }
            else if (req.InstitutionType == "Institution")
            {
                var institution = await context.InstitutionProfiles.FirstOrDefaultAsync(ip => ip.UserId == institutionId);
                if (institution != null)
                {
                    institution.AccountStatus = "Verified";
                    institution.IsVerified = true;
                    context.InstitutionProfiles.Update(institution);
                    await context.SaveChangesAsync();
                    
                    // Update local cache immediately
                    if (institutionProfilesByUserId.ContainsKey(institutionId))
                    {
                        institutionProfilesByUserId[institutionId].AccountStatus = "Verified";
                        institutionProfilesByUserId[institutionId].IsVerified = true;
                    }
                    userAccountStatuses[institutionId] = "Verified";
                    
                    Console.WriteLine($"AcceptInstitution: institution {institutionId} marked Verified in DB");
                    // Ensure the AspNet Identity user has the Institution role
                    try
                    {
                        var identityUser = await UserManager.FindByIdAsync(institutionId);
                        if (identityUser != null)
                        {
                            var roles = await UserManager.GetRolesAsync(identityUser);
                            if (!roles.Contains("Institution"))
                            {
                                var addRoleResult = await UserManager.AddToRoleAsync(identityUser, "Institution");
                                if (addRoleResult.Succeeded)
                                {
                                    Console.WriteLine($"AcceptInstitution: added 'Institution' role to user {institutionId}");
                                }
                                else
                                {
                                    Console.WriteLine($"AcceptInstitution: failed to add 'Institution' role to user {institutionId}: {string.Join(',', addRoleResult.Errors.Select(e => e.Description))}");
                                }
                            }
                        }
                        else
                        {
                            Console.WriteLine($"AcceptInstitution: Identity user {institutionId} not found to add role");
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"AcceptInstitution: error ensuring Institution role for {institutionId}: {ex.Message}");
                    }
                }
                else
                {
                    Console.WriteLine($"AcceptInstitution: institution record for {institutionId} not found in DB");
                }
            }
            else if (req.InstitutionType == "Benefactor")
            {
                var benefactor = await context.BenefactorProfiles.FirstOrDefaultAsync(bp => bp.UserId == institutionId);
                if (benefactor != null)
                {
                    benefactor.AccountStatus = "Verified";
                    benefactor.IsVerified = true;
                    context.BenefactorProfiles.Update(benefactor);
                    await context.SaveChangesAsync();
                    
                    // Update local cache immediately
                    if (benefactorProfilesByUserId.ContainsKey(institutionId))
                    {
                        benefactorProfilesByUserId[institutionId].AccountStatus = "Verified";
                        benefactorProfilesByUserId[institutionId].IsVerified = true;
                    }
                    userAccountStatuses[institutionId] = "Verified";
                    
                    Console.WriteLine($"AcceptInstitution: benefactor {institutionId} marked Verified in DB");
                    // Ensure the AspNet Identity user has the Benefactor role
                    try
                    {
                        var identityUser = await UserManager.FindByIdAsync(institutionId);
                        if (identityUser != null)
                        {
                            var roles = await UserManager.GetRolesAsync(identityUser);
                            if (!roles.Contains("Benefactor"))
                            {
                                var addRoleResult = await UserManager.AddToRoleAsync(identityUser, "Benefactor");
                                if (addRoleResult.Succeeded)
                                {
                                    Console.WriteLine($"AcceptInstitution: added 'Benefactor' role to user {institutionId}");
                                }
                                else
                                {
                                    Console.WriteLine($"AcceptInstitution: failed to add 'Benefactor' role to user {institutionId}: {string.Join(',', addRoleResult.Errors.Select(e => e.Description))}");
                                }
                            }
                        }
                        else
                        {
                            Console.WriteLine($"AcceptInstitution: Identity user {institutionId} not found to add role");
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"AcceptInstitution: error ensuring Benefactor role for {institutionId}: {ex.Message}");
                    }
                }
                else
                {
                    Console.WriteLine($"AcceptInstitution: benefactor record for {institutionId} not found in DB");
                }
            }
            else
            {
                Console.WriteLine($"AcceptInstitution: request {institutionId} is of type {req.InstitutionType}; no DB action implemented yet");
            }

            // Remove from pending list and refresh both pending and users
            pendingInstitutions.RemoveAll(i => i.Id == institutionId);
            await RefreshPendingAndUsers();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error accepting institution/student: {ex.Message}");
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task RefreshPendingAndUsers()
    {
        // Lightweight refresh - only update pending list and recalculate without full reload
        pendingInstitutions = await FetchPendingInstitutionsAsync();
        totalRequests = pendingInstitutions.Count;
        
        // Recalculate counts without reloading everything
        RecalculateCounts();
        
        // Reapply filter to update UI
        ApplyFilter();
    }
    
    private void RecalculateCounts()
    {
        // Recalculate totalArchived
        totalArchived = allUsers.Count(u =>
            (studentProfilesByUserId.TryGetValue(u.Id, out var student) && student.AccountStatus == "Archived") ||
            (institutionProfilesByUserId.TryGetValue(u.Id, out var institution) && institution.AccountStatus == "Archived") ||
            (benefactorProfilesByUserId.TryGetValue(u.Id, out var benefactor) && benefactor.AccountStatus == "Archived")
        );
        
        // Recalculate unverified count
        unverifiedCount = allUsers.Count(u =>
            !studentProfilesByUserId.ContainsKey(u.Id) &&
            !institutionProfilesByUserId.ContainsKey(u.Id) &&
            !benefactorProfilesByUserId.ContainsKey(u.Id) &&
            (!userRoles.TryGetValue(u.Id, out var role) || role != "SuperAdmin")
        );
    }

    private async Task RejectInstitution(string institutionId)
    {
        if (string.IsNullOrEmpty(institutionId)) return;

        Console.WriteLine($"RejectInstitution: attempting to reject request {institutionId}");

        try
        {
            await using var context = DbContextFactory.CreateDbContext();

            // Find the request type from the local pending list
            var req = pendingInstitutions.FirstOrDefault(i => i.Id == institutionId);
            if (req == null)
            {
                Console.WriteLine($"RejectInstitution: request {institutionId} not found in pending list");
                return;
            }

            if (req.InstitutionType == "Student")
            {
                var student = await context.StudentProfiles.FirstOrDefaultAsync(sp => sp.UserId == institutionId);
                if (student != null)
                {
                    student.AccountStatus = "Archived";
                    student.IsVerified = false;
                    context.StudentProfiles.Update(student);
                    await context.SaveChangesAsync();
                    
                    // Update local cache immediately
                    if (studentProfilesByUserId.ContainsKey(institutionId))
                    {
                        studentProfilesByUserId[institutionId].AccountStatus = "Archived";
                        studentProfilesByUserId[institutionId].IsVerified = false;
                    }
                    userAccountStatuses[institutionId] = "Archived";
                    
                    Console.WriteLine($"RejectInstitution: student {institutionId} marked as Archived");
                }
            }
            else if (req.InstitutionType == "Institution")
            {
                var institution = await context.InstitutionProfiles.FirstOrDefaultAsync(ip => ip.UserId == institutionId);
                if (institution != null)
                {
                    institution.AccountStatus = "Archived";
                    institution.IsVerified = false;
                    context.InstitutionProfiles.Update(institution);
                    await context.SaveChangesAsync();
                    
                    // Update local cache immediately
                    if (institutionProfilesByUserId.ContainsKey(institutionId))
                    {
                        institutionProfilesByUserId[institutionId].AccountStatus = "Archived";
                        institutionProfilesByUserId[institutionId].IsVerified = false;
                    }
                    userAccountStatuses[institutionId] = "Archived";
                    
                    Console.WriteLine($"RejectInstitution: institution {institutionId} marked as Archived");
                }
            }
            else if (req.InstitutionType == "Benefactor")
            {
                var benefactor = await context.BenefactorProfiles.FirstOrDefaultAsync(bp => bp.UserId == institutionId);
                if (benefactor != null)
                {
                    benefactor.AccountStatus = "Archived";
                    benefactor.IsVerified = false;
                    context.BenefactorProfiles.Update(benefactor);
                    await context.SaveChangesAsync();
                    
                    // Update local cache immediately
                    if (benefactorProfilesByUserId.ContainsKey(institutionId))
                    {
                        benefactorProfilesByUserId[institutionId].AccountStatus = "Archived";
                        benefactorProfilesByUserId[institutionId].IsVerified = false;
                    }
                    userAccountStatuses[institutionId] = "Archived";
                    
                    Console.WriteLine($"RejectInstitution: benefactor {institutionId} marked as Archived");
                }
            }

            // Remove from pending list and refresh
            pendingInstitutions.RemoveAll(i => i.Id == institutionId);
            await RefreshPendingAndUsers();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rejecting user: {ex.Message}");
        }
        finally
        {
            StateHasChanged();
        }
    }

    public class InstitutionRequest
    {
    public string? Id { get; set; }
    public string? Name { get; set; }
    public string? InstitutionName { get; set; }
    public string? Email { get; set; }
    public DateTime SubmittedAt { get; set; }
    public string InstitutionType { get; set; } = "Institution"; // Default, override for other types
    }
}