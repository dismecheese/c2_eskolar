@page "/admin/users"
@page "/dashboard/superadmin/users"
@attribute [Authorize(Roles = "SuperAdmin")]
@layout Layout.SuperAdminDashLayout
@implements IDisposable

@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject c2_eskolar.Services.InstitutionProfileService InstitutionProfileService
@inject UserManager<IdentityUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@using c2_eskolar.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer

<PageTitle>User Management - eSkolar SuperAdmin</PageTitle>

<div class="dashboard-center-container">
    <!-- Top Bar -->
        <div class="dashboard-topbar">
            <span class="dashboard-date">@DateTime.Now.ToString("dd MMM yyyy, ddd")</span>
        </div>

    <!-- Page Header -->
    <div class="page-header-section">
        <div class="page-header-content">
            <div class="page-title-area">
                <h1 class="page-title">
                    <i class="bi bi-people me-3"></i>
                    User Management
                </h1>
                <p class="page-subtitle">Manage system users, roles, and permissions</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-primary" @onclick="ShowCreateUserModal">
                    <i class="bi bi-plus-circle me-2"></i>
                    Add New User
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid-users">
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon users">
                    <i class="bi bi-people"></i>
                </div>
            </div>
            <div class="stat-value">@totalUsers</div>
            <div class="stat-label">Total Users</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon students">
                    <i class="bi bi-mortarboard"></i>
                </div>
            </div>
            <div class="stat-value">@studentCount</div>
            <div class="stat-label">Students</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon institutions">
                    <i class="bi bi-building"></i>
                </div>
            </div>
            <div class="stat-value">@institutionCount</div>
            <div class="stat-label">Institutions</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <div class="stat-icon benefactors">
                    <i class="bi bi-heart"></i>
                </div>
            </div>
            <div class="stat-value">@benefactorCount</div>
            <div class="stat-label">Benefactors</div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
        <button class="filter-tab @(activeFilter == "All" ? "active" : "")" @onclick="@(() => SetFilter("All"))">
            <i class="bi bi-list me-2"></i>All Users
        </button>
        <button class="filter-tab @(activeFilter == "Student" ? "active" : "")" @onclick="@(() => SetFilter("Student"))">
            <i class="bi bi-mortarboard me-2"></i>Students
        </button>
        <button class="filter-tab @(activeFilter == "Institution" ? "active" : "")" @onclick="@(() => SetFilter("Institution"))">
            <i class="bi bi-building me-2"></i>Institutions
        </button>
        <button class="filter-tab @(activeFilter == "Benefactor" ? "active" : "")" @onclick="@(() => SetFilter("Benefactor"))">
            <i class="bi bi-heart me-2"></i>Benefactors
        </button>
        <button class="filter-tab @(activeFilter == "Requests" ? "active" : "")" @onclick="@(() => SetFilter("Requests"))">
            <i class="bi bi-inbox me-2"></i>Requests
        </button>
    </div>

    <!-- Users Table -->
    <div class="users-table-container">
        <div class="table-header">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
            <div style="position: relative; flex: 1; max-width: 400px;">
                <i class="bi bi-search" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #64748b; z-index: 1;"></i>
                <input class="university-input" type="text" placeholder="Search users..." 
                    style="padding-left: 45px; padding-right: 38px; width: 100%;" 
                    @bind="searchQuery" @bind:event="oninput" />
                @if (!string.IsNullOrEmpty(searchQuery))
                {
                    <button type="button" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #64748b; font-size: 1.2rem; cursor: pointer;" @onclick="ClearSearch">
                        <i class="bi bi-x-circle"></i>
                    </button>
                }
            </div>
            <div style="display: flex; align-items: center; gap: 1rem; margin-left: auto;">
                @if (activeFilter == "Requests")
                {
                    <select class="form-select" style="width: 160px; min-width: 120px;" @onchange="OnRequestTypeDropdownChanged" value="@requestTypeDropdownValue">
                        <option value="All">All Requests</option>
                        <option value="Institution">Institutions</option>
                        <option value="Student">Students</option>
                        <option value="Benefactor">Benefactors</option>
                    </select>
                }
                <div class="table-actions">
                    <button class="btn btn-outline-primary btn-sm" @onclick="RefreshUsers">
                        <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
        </div>

        @if (isLoading)
        {
            <div class="loading-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading users...</p>
            </div>
        }
        else if (activeFilter == "Requests")
        {
            if (!showInstitutionRequestsTable)
            {
                showInstitutionRequestsTable = true;
                LoadPendingInstitutions();
            }
            if (isLoadingRequests)
            {
                <div class="loading-container">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading requests...</p>
                </div>
            }
            else if (filteredRequests != null && filteredRequests.Any())
            {
                <div class="table-responsive">
                    <table class="table users-table" style="table-layout: fixed;">
                        <thead>
                            <tr>
                                        <th style="width: 200px; white-space: nowrap;">Name</th>
                                        <th style="width: 220px; white-space: nowrap;">Affiliation</th>
                                        <th style="width: 140px; white-space: nowrap;">Registered</th>
                                        <th style="width: 140px; white-space: nowrap;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var inst in filteredRequests)
                            {
                                <tr>
                                    <td>
                                        <div class="user-info">
                                            <div class="user-details">
                                                <div class="user-name">@(inst.Name ?? "No Name")</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>@inst.InstitutionName</td>
                                    <td>@inst.SubmittedAt.ToString("MMM dd, yyyy")</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(inst.Id))
                                        {
                                                                    <div class="action-buttons">
                                                                        <button class="btn btn-accept-light btn-sm me-2" @onclick="async () => await AcceptInstitution(inst.Id!)">Accept</button>
                                                                        <button class="btn btn-reject-light btn-sm" @onclick="async () => await RejectInstitution(inst.Id!)">Reject</button>
                                                                    </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">No actions available</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="bi bi-inbox" style="font-size: 2rem; color: #ccc;"></i>
                    <h6>@(string.IsNullOrEmpty(searchQuery) ? "No pending requests found." : $"No requests found matching \"{searchQuery}\".")</h6>
                </div>
            }
        }
        else if (filteredUsers.Any())
        {
            <div class="table-responsive">
                <table class="table users-table" style="table-layout: fixed;">
                    <thead>
                        <tr>
                            <th style="width: 200px; white-space: nowrap;">User</th>
                            <th style="width: 220px; white-space: nowrap;">Email</th>
                            <th style="width: 140px; white-space: nowrap;">Registration Date</th>
                            <th style="width: 100px; white-space: nowrap;">Status</th>
                            <th style="width: 140px; white-space: nowrap;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in filteredUsers.Take(pageSize))
                        {
                            <tr>
                                <td>
                                    <div class="user-info">
                                        <div class="user-avatar">
                                            <i class="bi bi-person-circle"></i>
                                        </div>
                                        <div class="user-details">
                                            <div class="user-name">@(user.UserName ?? "No Name")</div>
                                            <div class="user-id">ID: @user.Id.Substring(0, 8)...</div>
                                        </div>
                                    </div>
                                </td>
                                <td>@user.Email</td>
                                <td>@(user.LockoutEnd?.ToString("MMM dd, yyyy") ?? "Unknown")</td>
                                <td>
                                    <span class="status-badge @(GetUserVerificationStatus(user.Id) == "Verified" ? "status-active" : "status-pending")">
                                        @(GetUserVerificationStatus(user.Id) == "Verified" ? "Verified" : "Pending")
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewUser(user.Id)">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" @onclick="() => EditUser(user.Id)">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteUser(user.Id)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
            @if (filteredUsers.Count() > pageSize)
            {
                <div class="pagination-container">
                    <button class="btn btn-outline-primary" @onclick="LoadMoreUsers">
                        Load More Users (@(filteredUsers.Count() - pageSize) remaining)
                    </button>
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                <i class="bi bi-people" style="font-size: 4rem; color: #ccc;"></i>
                <h4>No Users Found</h4>
                <p>@(string.IsNullOrEmpty(searchQuery) ? "No users match the current filter." : $"No users found matching \"{searchQuery}\".")</p>
            </div>
        }
    </div>
</div>

<style>
    .dashboard-center-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header-section {
        background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
    }

    .page-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2d3748;
        margin: 0;
        display: flex;
        align-items: center;
    }

    .page-subtitle {
        color: #4a5568;
        font-size: 1.1rem;
        margin: 0.5rem 0 0 0;
    }

    .stats-grid-users {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #1560d4, #0d387e);
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .stat-card-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
        margin-right: 1rem;
    }

    .stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.students { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-icon.institutions { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-icon.benefactors { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2d3748;
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 1rem;
        font-weight: 600;
        color: #4a5568;
    }

    .filter-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .filter-tab {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        color: #4a5568;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
    }

    .filter-tab:hover {
        background: #e2e8f0;
        transform: translateY(-1px);
    }

    .filter-tab.active {
        background: linear-gradient(135deg, #1560d4, #0d387e);
        color: white;
        border-color: #1560d4;
    }

    .users-table-container {
        background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #e2e8f0;
        background: #f8fafc;
    }

    .table-header h3 {
        margin: 0;
        color: #2d3748;
        font-weight: 600;
    }

    .users-table {
        width: 100%;
        margin: 0;
    }

    .users-table th {
        background: #f8fafc;
        border: none;
        padding: 1rem 1.5rem;
        font-weight: 600;
        color: #4a5568;
        border-bottom: 1px solid #e2e8f0;
    }

    .users-table td {
        padding: 1rem 1.5rem;
        border: none;
        border-bottom: 1px solid #f1f5f9;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #1560d4, #0d387e);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
    }

    .user-name {
        font-weight: 600;
        color: #2d3748;
    }

    .user-id {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .role-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .role-student { background: #fef3c7; color: #d97706; }
    .role-institution { background: #dbeafe; color: #2563eb; }
    .role-benefactor { background: #dcfce7; color: #16a34a; }
    .role-superadmin { background: #fce7f3; color: #be185d; }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-active { background: #dcfce7; color: #16a34a; }
    .status-pending { background: #fef3c7; color: #d97706; }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-accept-light {
        background: #e6f4ea;
        color: #218838;
        border: 1px solid #b7e4c7;
        transition: background 0.2s;
    }
    .btn-accept-light:hover {
        background: #c7e9d7;
        color: #218838;
    }

    .btn-reject-light {
        background: #fdeaea;
        color: #c82333;
        border: 1px solid #f5c6cb;
        transition: background 0.2s;
    }
    .btn-reject-light:hover {
        background: #f8d7da;
        color: #c82333;
    }

    .loading-container, .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #6b7280;
    }

    .pagination-container {
        padding: 1.5rem 2rem;
        text-align: center;
        border-top: 1px solid #e2e8f0;
    }

    @@media (max-width: 768px) {
        .page-header-content {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .stats-grid-users {
            grid-template-columns: 1fr;
        }
        
        .filter-tabs {
            flex-direction: column;
        }
        
        .table-responsive {
            font-size: 0.875rem;
        }
    }
</style>

@code {
    private string? currentUserName;
    private string? currentUserEmail;
    private List<IdentityUser> allUsers = new();
    private IEnumerable<IdentityUser> filteredUsers = new List<IdentityUser>();
    private Dictionary<string, string> userRoles = new();
    private Dictionary<string, string> userVerificationStatuses = new();
    
    private int totalUsers = 0;
    private int studentCount = 0;
    private int institutionCount = 0;
    private int benefactorCount = 0;
    private int superAdminCount = 0;
    
    private string activeFilter = "All";
    // Only for requests tab
    private string requestTypeDropdownValue = "All";
    // Only for requests tab
    private void OnRequestTypeDropdownChanged(ChangeEventArgs e)
    {
        var selected = e.Value?.ToString() ?? "All";
        requestTypeDropdownValue = selected;
        ApplyFilter();
    }
    private string searchQuery
    {
        get => _searchQuery;
        set
        {
            if (_searchQuery != value)
            {
                _searchQuery = value;
                ApplyFilter();
                StateHasChanged();
            }
        }
    }
    private string _searchQuery = "";
    private int pageSize = 25;
    private bool isLoading = true;
    
    // Thread-safety for loading data
    private readonly SemaphoreSlim loadingSemaphore = new SemaphoreSlim(1, 1);

    protected override async Task OnInitializedAsync()
    {
        if (loadingSemaphore.CurrentCount == 0) return;
        
        await loadingSemaphore.WaitAsync();
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                currentUserName = user.Identity.Name;
                currentUserEmail = user.FindFirst("email")?.Value;
            }

            await LoadUsersData();
        }
        catch (ObjectDisposedException)
        {
            // Ignore if already disposed
            return;
        }
        finally
        {
            try
            {
                loadingSemaphore.Release();
            }
            catch (ObjectDisposedException)
            {
                // Ignore if already disposed
            }
        }
    }

    private async Task LoadUsersData()
    {
        try
        {
            isLoading = true;
            StateHasChanged();
            
            Console.WriteLine("LoadUsersData: Starting to load users data...");
            
            // Use separate context for each operation to avoid conflicts
            using var context = DbContextFactory.CreateDbContext();
            
            // Load all users using the UserManager
            allUsers = await UserManager.Users.ToListAsync();
            totalUsers = allUsers.Count;
            
            // Load role counts and user roles
            await LoadUserRoles();
            
            // Load verification statuses
            await LoadUserVerificationStatuses();
            
            // Apply current filter
            ApplyFilter();
            
            Console.WriteLine($"LoadUsersData: Loaded {totalUsers} users successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading users data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task LoadUserRoles()
    {
        try
        {
            userRoles.Clear();
            studentCount = 0;
            institutionCount = 0;
            benefactorCount = 0;
            superAdminCount = 0;
            
            foreach (var user in allUsers)
            {
                var roles = await UserManager.GetRolesAsync(user);
                var role = roles.FirstOrDefault() ?? "Unknown";
                userRoles[user.Id] = role;
                
                // Count by role
                switch (role)
                {
                    case "Student":
                        studentCount++;
                        break;
                    case "Institution":
                        institutionCount++;
                        break;
                    case "Benefactor":
                        benefactorCount++;
                        break;
                    case "SuperAdmin":
                        superAdminCount++;
                        break;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user roles: {ex.Message}");
        }
    }
    
    private string GetUserRole(string userId)
    {
        return userRoles.TryGetValue(userId, out var role) ? role : "Unknown";
    }
    
    private async Task LoadUserVerificationStatuses()
    {
        try
        {
            userVerificationStatuses.Clear();
            using var context = DbContextFactory.CreateDbContext();
            
            // Load all verification statuses in bulk
            var studentStatuses = await context.StudentProfiles
                .Select(sp => new { sp.UserId, sp.VerificationStatus })
                .ToListAsync();
                
            var institutionStatuses = await context.InstitutionProfiles
                .Select(ip => new { ip.UserId, ip.VerificationStatus })
                .ToListAsync();
                
            var benefactorStatuses = await context.BenefactorProfiles
                .Select(bp => new { bp.UserId, bp.VerificationStatus })
                .ToListAsync();
            
            // Populate the dictionary
            foreach (var status in studentStatuses)
                userVerificationStatuses[status.UserId] = status.VerificationStatus ?? "Pending";
                
            foreach (var status in institutionStatuses)
                userVerificationStatuses[status.UserId] = status.VerificationStatus ?? "Pending";
                
            foreach (var status in benefactorStatuses)
                userVerificationStatuses[status.UserId] = status.VerificationStatus ?? "Pending";
            
            // Set SuperAdmins as verified
            foreach (var user in allUsers)
            {
                var role = GetUserRole(user.Id);
                if (role == "SuperAdmin")
                {
                    userVerificationStatuses[user.Id] = "Verified";
                }
                else if (!userVerificationStatuses.ContainsKey(user.Id))
                {
                    // Fall back to email confirmation for users without profiles
                    userVerificationStatuses[user.Id] = user.EmailConfirmed ? "Verified" : "Pending";
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user verification statuses: {ex.Message}");
        }
    }
    
    private string GetUserVerificationStatus(string userId)
    {
        return userVerificationStatuses.TryGetValue(userId, out var status) ? status : "Pending";
    }
    
    private void SetFilter(string filter)
    {
        activeFilter = filter;
        ApplyFilter();
    }
    
    private void ApplyFilter()
    {
        try
        {
            Console.WriteLine($"ApplyFilter called - Search query: '{searchQuery}', Active filter: '{activeFilter}', Total users: {allUsers.Count}");

            // Handle Requests tab filtering separately
            if (activeFilter == "Requests")
            {
                var reqs = pendingInstitutions.AsEnumerable();

                if (requestTypeDropdownValue != "All")
                {
                    reqs = reqs.Where(r => string.Equals(r.InstitutionType, requestTypeDropdownValue, StringComparison.OrdinalIgnoreCase));
                    Console.WriteLine($"After request type filter: {reqs.Count()} requests");
                }

                if (!string.IsNullOrEmpty(searchQuery))
                {
                    var q = searchQuery.ToLower();
                    reqs = reqs.Where(r =>
                        (r.Name?.ToLower().Contains(q) ?? false) ||
                        (r.InstitutionName?.ToLower().Contains(q) ?? false) ||
                        (r.Email?.ToLower().Contains(q) ?? false) ||
                        (r.Id?.ToLower().Contains(q) ?? false));
                    Console.WriteLine($"After request search filter: {reqs.Count()} requests");
                }

                filteredRequests = reqs.OrderBy(r => r.SubmittedAt);
                Console.WriteLine($"Final filtered requests count: {filteredRequests.Count()}");
                StateHasChanged();
                return;
            }

            // Filter regular users
            var filtered = allUsers.AsEnumerable();

            // Apply role filter
            if (activeFilter != "All")
            {
                filtered = filtered.Where(u => GetUserRole(u.Id) == activeFilter);
                Console.WriteLine($"After role filter: {filtered.Count()} users");
            }

            // For Students tab, only show verified students
            if (activeFilter == "Student")
            {
                using var context = DbContextFactory.CreateDbContext();
                var verifiedStudentIds = context.StudentProfiles
                    .Where(sp => sp.VerificationStatus == "Verified")
                    .Select(sp => sp.UserId)
                    .ToHashSet();
                filtered = filtered.Where(u => verifiedStudentIds.Contains(u.Id));
                Console.WriteLine($"After verified filter: {filtered.Count()} users");
            }
            // For Institutions tab, only show verified institutions
            if (activeFilter == "Institution")
            {
                using var context = DbContextFactory.CreateDbContext();
                var verifiedInstitutionIds = context.InstitutionProfiles
                    .Where(ip => ip.VerificationStatus == "Verified")
                    .Select(ip => ip.UserId)
                    .ToHashSet();
                filtered = filtered.Where(u => verifiedInstitutionIds.Contains(u.Id));
                Console.WriteLine($"After verified institution filter: {filtered.Count()} users");
            }
            // For Benefactor tab, only show verified benefactors
            if (activeFilter == "Benefactor")
            {
                using var context = DbContextFactory.CreateDbContext();
                var verifiedBenefactorIds = context.BenefactorProfiles
                    .Where(bp => bp.VerificationStatus == "Verified")
                    .Select(bp => bp.UserId)
                    .ToHashSet();
                filtered = filtered.Where(u => verifiedBenefactorIds.Contains(u.Id));
                Console.WriteLine($"After verified benefactor filter: {filtered.Count()} users");
            }

            // Apply search filter
            if (!string.IsNullOrEmpty(searchQuery))
            {
                var query = searchQuery.ToLower();
                filtered = filtered.Where(u =>
                    (u.UserName?.ToLower().Contains(query) ?? false) ||
                    (u.Email?.ToLower().Contains(query) ?? false) ||
                    (u.Id?.ToLower().Contains(query) ?? false));
                Console.WriteLine($"After search filter: {filtered.Count()} users");
            }

            filteredUsers = filtered.OrderBy(u => u.UserName);
            Console.WriteLine($"Final filtered users count: {filteredUsers.Count()}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in ApplyFilter: {ex.Message}");
        }
    }
    
    // FilterUsers method removed; filtering now handled by searchQuery setter


    
    private void ClearSearch()
    {
        searchQuery = "";
        ApplyFilter();
    }
    
    private async Task RefreshUsers()
    {
        await LoadUsersData();
        await LoadUserVerificationStatuses();
    }
    
    private void LoadMoreUsers()
    {
        pageSize += 25;
        StateHasChanged();
    }
    
    // Placeholder methods for user actions
    private void ShowCreateUserModal()
    {
        // TODO: Implement create user modal
        Console.WriteLine("Create user modal - To be implemented");
    }
    
    private void ViewUser(string userId)
    {
        // TODO: Navigate to user view page
        Console.WriteLine($"View user: {userId}");
    }
    
    private void EditUser(string userId)
    {
        // TODO: Navigate to user edit page
        Console.WriteLine($"Edit user: {userId}");
    }
    
    private void DeleteUser(string userId)
    {
        // TODO: Implement delete user confirmation
        Console.WriteLine($"Delete user: {userId}");
    }
    
    public void Dispose()
    {
        loadingSemaphore?.Dispose();
    }
    // Institution Requests Table State
    private bool showInstitutionRequestsTable = false;
    private bool isLoadingRequests = false;
    private List<InstitutionRequest> pendingInstitutions = new();
    private IEnumerable<InstitutionRequest> filteredRequests = new List<InstitutionRequest>();


    // Removed ToggleInstitutionRequests, replaced by Requests tab logic

    private async void LoadPendingInstitutions()
    {
        isLoadingRequests = true;
        StateHasChanged();
        
        // Fetch pending institutions from backend
        pendingInstitutions = await FetchPendingInstitutionsAsync();
        
        // Apply current filter after loading
        ApplyFilter();
        
        isLoadingRequests = false;
        StateHasChanged();
    }

    private async Task<List<InstitutionRequest>> FetchPendingInstitutionsAsync()
    {
        var requests = new List<InstitutionRequest>();
        try
        {
            await using var context = DbContextFactory.CreateDbContext();
            // Pending Institutions
            var pendingProfiles = context.InstitutionProfiles
                .Where(ip => ip.VerificationStatus == "Pending")
                .ToList();
            foreach (var profile in pendingProfiles)
            {
                requests.Add(new InstitutionRequest
                {
                    Id = profile.UserId,
                    Name = profile.AdminFirstName + " " + (string.IsNullOrEmpty(profile.AdminMiddleName) ? "" : profile.AdminMiddleName + " ") + profile.AdminLastName,
                    InstitutionName = profile.InstitutionName,
                    Email = profile.ContactEmail,
                    SubmittedAt = profile.CreatedAt,
                    InstitutionType = "Institution"
                });
            }

            // Pending Students
            var pendingStudents = context.StudentProfiles
                .Where(sp => sp.VerificationStatus == "Pending")
                .ToList();
            foreach (var student in pendingStudents)
            {
                requests.Add(new InstitutionRequest
                {
                    Id = student.UserId,
                    Name = student.FirstName + " " + (string.IsNullOrEmpty(student.MiddleName) ? "" : student.MiddleName + " ") + student.LastName,
                    InstitutionName = student.UniversityName ?? "Unknown University",
                    Email = student.Email,
                    SubmittedAt = student.CreatedAt,
                    InstitutionType = "Student"
                });
            }

            // Pending Benefactors
            var pendingBenefactors = context.BenefactorProfiles
                .Where(bp => bp.VerificationStatus == "Pending")
                .ToList();
            foreach (var benefactor in pendingBenefactors)
            {
                requests.Add(new InstitutionRequest
                {
                    Id = benefactor.UserId,
                    Name = benefactor.AdminFirstName + " " + (string.IsNullOrEmpty(benefactor.AdminMiddleName) ? "" : benefactor.AdminMiddleName + " ") + benefactor.AdminLastName,
                    InstitutionName = benefactor.OrganizationName ?? "Unknown Organization",
                    Email = benefactor.ContactEmail,
                    SubmittedAt = benefactor.CreatedAt,
                    InstitutionType = "Benefactor"
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching pending institutions: {ex.Message}");
        }
        return requests;
    }

    private async Task AcceptInstitution(string institutionId)
    {
        if (string.IsNullOrEmpty(institutionId)) return;

        Console.WriteLine($"AcceptInstitution: attempting to accept request {institutionId}");

        try
        {
            await using var context = DbContextFactory.CreateDbContext();

            // Find the request type from the local pending list
            var req = pendingInstitutions.FirstOrDefault(i => i.Id == institutionId);
            if (req == null)
            {
                Console.WriteLine($"AcceptInstitution: request {institutionId} not found in pending list");
                return;
            }

            if (req.InstitutionType == "Student")
            {
                var student = await context.StudentProfiles.FirstOrDefaultAsync(sp => sp.UserId == institutionId);
                if (student != null)
                {
                    student.VerificationStatus = "Verified";
                    student.IsVerified = true;
                    context.StudentProfiles.Update(student);
                    await context.SaveChangesAsync();
                    Console.WriteLine($"AcceptInstitution: student {institutionId} marked Verified in DB");
                    // Ensure the AspNet Identity user has the Student role so the Students tab filter includes them
                    try
                    {
                        var identityUser = await UserManager.FindByIdAsync(institutionId);
                        if (identityUser != null)
                        {
                            var roles = await UserManager.GetRolesAsync(identityUser);
                            if (!roles.Contains("Student"))
                            {
                                var addRoleResult = await UserManager.AddToRoleAsync(identityUser, "Student");
                                if (addRoleResult.Succeeded)
                                {
                                    Console.WriteLine($"AcceptInstitution: added 'Student' role to user {institutionId}");
                                }
                                else
                                {
                                    Console.WriteLine($"AcceptInstitution: failed to add 'Student' role to user {institutionId}: {string.Join(',', addRoleResult.Errors.Select(e => e.Description))}");
                                }
                            }
                        }
                        else
                        {
                            Console.WriteLine($"AcceptInstitution: Identity user {institutionId} not found to add role");
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"AcceptInstitution: error ensuring Student role for {institutionId}: {ex.Message}");
                    }
                }
                else
                {
                    Console.WriteLine($"AcceptInstitution: student record for {institutionId} not found in DB");
                }
            }
            else if (req.InstitutionType == "Institution")
            {
                var institution = await context.InstitutionProfiles.FirstOrDefaultAsync(ip => ip.UserId == institutionId);
                if (institution != null)
                {
                    institution.VerificationStatus = "Verified";
                    institution.IsVerified = true;
                    context.InstitutionProfiles.Update(institution);
                    await context.SaveChangesAsync();
                    Console.WriteLine($"AcceptInstitution: institution {institutionId} marked Verified in DB");
                    // Ensure the AspNet Identity user has the Institution role
                    try
                    {
                        var identityUser = await UserManager.FindByIdAsync(institutionId);
                        if (identityUser != null)
                        {
                            var roles = await UserManager.GetRolesAsync(identityUser);
                            if (!roles.Contains("Institution"))
                            {
                                var addRoleResult = await UserManager.AddToRoleAsync(identityUser, "Institution");
                                if (addRoleResult.Succeeded)
                                {
                                    Console.WriteLine($"AcceptInstitution: added 'Institution' role to user {institutionId}");
                                }
                                else
                                {
                                    Console.WriteLine($"AcceptInstitution: failed to add 'Institution' role to user {institutionId}: {string.Join(',', addRoleResult.Errors.Select(e => e.Description))}");
                                }
                            }
                        }
                        else
                        {
                            Console.WriteLine($"AcceptInstitution: Identity user {institutionId} not found to add role");
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"AcceptInstitution: error ensuring Institution role for {institutionId}: {ex.Message}");
                    }
                }
                else
                {
                    Console.WriteLine($"AcceptInstitution: institution record for {institutionId} not found in DB");
                }
            }
            else if (req.InstitutionType == "Benefactor")
            {
                var benefactor = await context.BenefactorProfiles.FirstOrDefaultAsync(bp => bp.UserId == institutionId);
                if (benefactor != null)
                {
                    benefactor.VerificationStatus = "Verified";
                    benefactor.IsVerified = true;
                    context.BenefactorProfiles.Update(benefactor);
                    await context.SaveChangesAsync();
                    Console.WriteLine($"AcceptInstitution: benefactor {institutionId} marked Verified in DB");
                    // Ensure the AspNet Identity user has the Benefactor role
                    try
                    {
                        var identityUser = await UserManager.FindByIdAsync(institutionId);
                        if (identityUser != null)
                        {
                            var roles = await UserManager.GetRolesAsync(identityUser);
                            if (!roles.Contains("Benefactor"))
                            {
                                var addRoleResult = await UserManager.AddToRoleAsync(identityUser, "Benefactor");
                                if (addRoleResult.Succeeded)
                                {
                                    Console.WriteLine($"AcceptInstitution: added 'Benefactor' role to user {institutionId}");
                                }
                                else
                                {
                                    Console.WriteLine($"AcceptInstitution: failed to add 'Benefactor' role to user {institutionId}: {string.Join(',', addRoleResult.Errors.Select(e => e.Description))}");
                                }
                            }
                        }
                        else
                        {
                            Console.WriteLine($"AcceptInstitution: Identity user {institutionId} not found to add role");
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"AcceptInstitution: error ensuring Benefactor role for {institutionId}: {ex.Message}");
                    }
                }
                else
                {
                    Console.WriteLine($"AcceptInstitution: benefactor record for {institutionId} not found in DB");
                }
            }
            else
            {
                Console.WriteLine($"AcceptInstitution: request {institutionId} is of type {req.InstitutionType}; no DB action implemented yet");
            }

            // Remove from pending list and refresh both pending and users
            pendingInstitutions.RemoveAll(i => i.Id == institutionId);
            await RefreshPendingAndUsers();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error accepting institution/student: {ex.Message}");
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task RefreshPendingAndUsers()
    {
        // Reload pending requests and users to ensure UI consistency
        pendingInstitutions = await FetchPendingInstitutionsAsync();
        await LoadUsersData();
        await LoadUserVerificationStatuses();
    }

    private async Task RejectInstitution(string institutionId)
    {
        if (!string.IsNullOrEmpty(institutionId))
        {
            // TODO: Reject logic
            await Task.Delay(200);
            pendingInstitutions.RemoveAll(i => i.Id == institutionId);
            StateHasChanged();
        }
    }

    public class InstitutionRequest
    {
    public string? Id { get; set; }
    public string? Name { get; set; }
    public string? InstitutionName { get; set; }
    public string? Email { get; set; }
    public DateTime SubmittedAt { get; set; }
    public string InstitutionType { get; set; } = "Institution"; // Default, override for other types
    }
}