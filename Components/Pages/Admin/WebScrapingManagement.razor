@page "/admin/webscraping"
@attribute [Authorize(Roles = "SuperAdmin")]
@layout Layout.SuperAdminDashLayout
@inject c2_eskolar.Services.WebScraping.IWebScrapingService WebScrapingService
@inject c2_eskolar.Services.WebScraping.IEnhancedWebScrapingService EnhancedWebScrapingService
@inject IJSRuntime JSRuntime
@inject ILogger<WebScrapingManagement> Logger
@using c2_eskolar.Services.WebScraping
@using Microsoft.AspNetCore.Authorization

<div class="dashboard-center-container">
    <!-- Top Bar -->
    <div class="dashboard-topbar">
        <div style="position: relative; flex: 1; max-width: 500px;">
            <i class="bi bi-search" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #64748b; z-index: 1;"></i>
            <input class="university-input" type="text" placeholder="Search scraping operations..." 
                   style="padding-left: 45px; padding-right: 18px;" readonly />
        </div>
        <span class="dashboard-date">@DateTime.Now.ToString("dd MMM yyyy, ddd")</span>
    </div>

    <!-- Welcome Banner -->
    <div class="dashboard-banner-centered">
        <div class="banner-text">
            <h2>Web Scraping Management</h2>
            <p>Configure and monitor automated data collection operations</p>
        </div>
        <img src="images/eskolar_books.svg" alt="Books" class="banner-img" />
    </div>

    <!-- Alert Messages -->
    @if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }
    @if (!string.IsNullOrWhiteSpace(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-check-circle me-2"></i>@successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
    }

    <!-- Dashboard Tabs -->
    <div class="dashboard-tabs">
        <button class="dashboard-tab @(activeTab == 0 ? "active" : "")" @onclick="() => SetTab(0)">Scholarship Scraping</button>
        <button class="dashboard-tab @(activeTab == 1 ? "active" : "")" @onclick="() => SetTab(1)">AI-Enhanced Scraping</button>
        <button class="dashboard-tab @(activeTab == 2 ? "active" : "")" @onclick="() => SetTab(2)">Institution & Organization Verification</button>
    </div>

    @if (activeTab == 0)
    {
        <!-- Scholarship Scraping Tab -->
        <div class="scraping-section">
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="scraping-card">
                        <div class="scraping-card-header">
                            <div class="scraping-card-icon scholarship">
                                <i class="bi bi-mortarboard"></i>
                            </div>
                            <div>
                                <h5>Manual Scholarship Scraping</h5>
                                <p class="mb-0">Extract scholarship data from specific URLs</p>
                            </div>
                        </div>
                        <div class="scraping-card-body">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Target Website URL</label>
                                <input type="url" class="form-control scraping-input" @bind="scholarshipUrl" 
                                       placeholder="https://university.edu/scholarships" />
                            </div>
                            <div class="scraping-actions">
                                <button class="btn-scraping btn-primary" @onclick="ScrapeScholarships" disabled="@isLoading">
                                    @if (isLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="bi bi-download me-2"></i>Start Scraping
                                </button>
                                <div class="scraping-help">
                                    <i class="bi bi-info-circle me-1"></i>
                                    <small>Supports Philippine university and scholarship websites</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="scraping-stats">
                        <div class="stat-item">
                            <div class="stat-value">@scrapedScholarshipsCount</div>
                            <div class="stat-label">Scholarships Found</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">@lastScrapeTime</div>
                            <div class="stat-label">Last Scrape</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scraped Scholarships Table -->
            @if (scrapedScholarships.Any())
            {
                <div class="scraped-data-section mt-4">
                    <div class="scraped-data-header">
                        <h5><i class="bi bi-table me-2"></i>Scraped Scholarships Data</h5>
                        <div class="data-actions">
                            <button class="btn-scraping btn-outline-primary btn-sm" @onclick="() => ExportScholarshipData()">
                                <i class="bi bi-download me-1"></i>Export
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover scraped-data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Source</th>
                                    <th>Amount</th>
                                    <th>Deadline</th>
                                    <th>Scraped At</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var scholarship in scrapedScholarships)
                                {
                                    <tr>
                                        <td>@scholarship.Title</td>
                                        <td>@scholarship.Source</td>
                                        <td>@scholarship.Amount</td>
                                        <td>@scholarship.DeadlineDate</td>
                                        <td>@scholarship.ScrapedAt.ToString("MMM dd, yyyy HH:mm")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        </div>
    }
    else if (activeTab == 1)
    {
        <!-- AI-Enhanced Scraping Tab -->
        <div class="scraping-section">
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="scraping-card">
                        <div class="scraping-card-header">
                            <div class="scraping-card-icon scholarship">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div>
                                <h5>AI-Enhanced Scholarship Scraping</h5>
                                <p class="mb-0">Intelligent parsing with OpenAI GPT-4</p>
                            </div>
                        </div>
                        <div class="scraping-card-body">
                            <div class="mb-3">
                                <label class="form-label">Website URL</label>
                                <input type="url" class="form-control scraping-input" @bind="enhancedScholarshipUrl" placeholder="https://scholarships.example.com">
                            </div>
                            <div class="scraping-actions">
                                <button class="btn-scraping btn-primary" @onclick="ScrapeWithAI" disabled="@isLoading">
                                    @if (isLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="bi bi-brain me-2"></i>Scrape with AI
                                </button>
                                <button class="btn-scraping btn-success" @onclick="ExportEnhancedCsv" disabled="@(enhancedScholarships.Count == 0)">
                                    <i class="bi bi-file-earmark-csv me-2"></i>Export CSV
                                </button>
                            </div>
                            <div class="scraping-help mt-3">
                                <i class="bi bi-info-circle me-2"></i>
                                AI will automatically extract and structure scholarship data into database-ready format
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="scraping-stats">
                        <div class="stat-item">
                            <div class="stat-value">@enhancedScholarships.Count</div>
                            <div class="stat-label">AI Parsed Scholarships</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">@(enhancedScholarships.Count > 0 ? (enhancedScholarships.Average(s => s.ParsingConfidence) * 100).ToString("F1") + "%" : "0%")</div>
                            <div class="stat-label">Average Confidence</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">@lastEnhancedScrapeTime</div>
                            <div class="stat-label">Last AI Scrape</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Scraped Scholarships Table -->
            @if (enhancedScholarships.Any())
            {
                <div class="scraped-data-card mt-4">
                    <div class="scraped-data-header">
                        <div class="scraped-data-icon">
                            <i class="bi bi-table"></i>
                        </div>
                        <div>
                            <h5>AI-Parsed Scholarship Data</h5>
                            <p class="mb-0">@enhancedScholarships.Count scholarships ready for database import</p>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table scraped-data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Monetary Value</th>
                                    <th>Deadline</th>
                                    <th>GPA Requirement</th>
                                    <th>Confidence</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var scholarship in enhancedScholarships.Take(10))
                                {
                                    <tr>
                                        <td>
                                            <strong>@scholarship.Title</strong>
                                            @if (!string.IsNullOrEmpty(scholarship.RequiredCourse))
                                            {
                                                <br><small class="text-muted">Course: @scholarship.RequiredCourse</small>
                                            }
                                        </td>
                                        <td>
                                            @if (scholarship.MonetaryValue.HasValue)
                                            {
                                                <span class="badge bg-success">₱@scholarship.MonetaryValue.Value.ToString("N0")</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">N/A</span>
                                            }
                                        </td>
                                        <td>
                                            @if (scholarship.ApplicationDeadline.HasValue)
                                            {
                                                @scholarship.ApplicationDeadline.Value.ToString("MMM dd, yyyy")
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not specified</span>
                                            }
                                        </td>
                                        <td>
                                            @if (scholarship.MinimumGPA.HasValue)
                                            {
                                                @scholarship.MinimumGPA.Value.ToString("F2")
                                            }
                                            else
                                            {
                                                <span class="text-muted">N/A</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge @(scholarship.ParsingConfidence >= 0.7 ? "bg-success" : scholarship.ParsingConfidence >= 0.4 ? "bg-warning" : "bg-danger")">
                                                @((scholarship.ParsingConfidence * 100).ToString("F0"))%
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewScholarshipDetails(scholarship)">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        </div>
    }
    else if (activeTab == 2)
    {
        <!-- Institution & Organization Verification Tab -->
        <div class="scraping-section">
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="scraping-card">
                        <div class="scraping-card-header">
                            <div class="scraping-card-icon institution">
                                <i class="bi bi-building"></i>
                            </div>
                            <div>
                                <h5>Institution Verification</h5>
                                <p class="mb-0">Verify educational institutions</p>
                            </div>
                        </div>
                        <div class="scraping-card-body">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Institution Name</label>
                                <input type="text" class="form-control scraping-input" @bind="institutionName" 
                                       placeholder="University of the Philippines" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Website (Optional)</label>
                                <input type="url" class="form-control scraping-input" @bind="institutionWebsite" 
                                       placeholder="https://up.edu.ph" />
                            </div>
                            <button class="btn-scraping btn-info" @onclick="VerifyInstitution" disabled="@isLoading">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="bi bi-check2-circle me-2"></i>Verify Institution
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="scraping-card">
                        <div class="scraping-card-header">
                            <div class="scraping-card-icon organization">
                                <i class="bi bi-bank"></i>
                            </div>
                            <div>
                                <h5>Organization Verification</h5>
                                <p class="mb-0">Verify benefactor organizations</p>
                            </div>
                        </div>
                        <div class="scraping-card-body">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Organization Name</label>
                                <input type="text" class="form-control scraping-input" @bind="organizationName" 
                                       placeholder="Philippine Foundation" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Website</label>
                                <input type="url" class="form-control scraping-input" @bind="organizationWebsite" 
                                       placeholder="https://foundation.org.ph" />
                            </div>
                            <button class="btn-scraping btn-warning" @onclick="VerifyOrganization" disabled="@isLoading">
                                @if (isLoading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="bi bi-shield-check me-2"></i>Verify Organization
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Verified Institutions Table -->
            @if (verifiedInstitutionsList.Any())
            {
                <div class="scraped-data-section mt-4">
                    <div class="scraped-data-header">
                        <h5><i class="bi bi-building me-2"></i>Verified Institutions</h5>
                        <div class="data-actions">
                            <button class="btn-scraping btn-outline-primary btn-sm" @onclick="() => ExportInstitutionData()">
                                <i class="bi bi-download me-1"></i>Export
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover scraped-data-table">
                            <thead>
                                <tr>
                                    <th>Institution Name</th>
                                    <th>Website</th>
                                    <th>Status</th>
                                    <th>Verified At</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var institution in verifiedInstitutionsList)
                                {
                                    <tr>
                                        <td>@institution.Name</td>
                                        <td>@(string.IsNullOrEmpty(institution.Website) ? "N/A" : institution.Website)</td>
                                        <td>
                                            <span class="badge @(institution.IsVerified ? "bg-success" : "bg-danger")">
                                                @(institution.IsVerified ? "✓ Verified" : "✗ Not Verified")
                                            </span>
                                        </td>
                                        <td>@institution.VerifiedAt.ToString("MMM dd, yyyy HH:mm")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            
            <!-- Verified Organizations Table -->
            @if (verifiedOrganizationsList.Any())
            {
                <div class="scraped-data-section mt-4">
                    <div class="scraped-data-header">
                        <h5><i class="bi bi-bank me-2"></i>Verified Organizations</h5>
                        <div class="data-actions">
                            <button class="btn-scraping btn-outline-primary btn-sm" @onclick="() => ExportOrganizationData()">
                                <i class="bi bi-download me-1"></i>Export
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover scraped-data-table">
                            <thead>
                                <tr>
                                    <th>Organization Name</th>
                                    <th>Website</th>
                                    <th>Status</th>
                                    <th>Verified At</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var organization in verifiedOrganizationsList)
                                {
                                    <tr>
                                        <td>@organization.Name</td>
                                        <td>@organization.Website</td>
                                        <td>
                                            <span class="badge @(organization.IsVerified ? "bg-success" : "bg-danger")">
                                                @(organization.IsVerified ? "✓ Verified" : "✗ Not Verified")
                                            </span>
                                        </td>
                                        <td>@organization.VerifiedAt.ToString("MMM dd, yyyy HH:mm")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Scholarship Details Modal -->
    @if (selectedScholarship != null)
    {
        <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-mortarboard me-2"></i>
                            Scholarship Details
                        </h5>
                        <button type="button" class="btn-close" @onclick="CloseModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="scholarship-details">
                            <!-- Basic Information -->
                            <div class="detail-section">
                                <h6 class="detail-section-title">
                                    <i class="bi bi-info-circle me-2"></i>Basic Information
                                </h6>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <label>Title:</label>
                                        <span class="detail-value">@selectedScholarship.Title</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Source URL:</label>
                                        <span class="detail-value">
                                            <a href="@selectedScholarship.SourceUrl" target="_blank" class="text-decoration-none">
                                                @GetSourceHost(selectedScholarship.SourceUrl)
                                                <i class="bi bi-box-arrow-up-right ms-1"></i>
                                            </a>
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Scraped At:</label>
                                        <span class="detail-value">@selectedScholarship.ScrapedAt.ToString("MMM dd, yyyy HH:mm")</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>AI Confidence:</label>
                                        <span class="detail-value">
                                            <span class="badge @(selectedScholarship.ParsingConfidence >= 0.7 ? "bg-success" : selectedScholarship.ParsingConfidence >= 0.4 ? "bg-warning" : "bg-danger")">
                                                @((selectedScholarship.ParsingConfidence * 100).ToString("F1"))%
                                            </span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Financial Information -->
                            <div class="detail-section">
                                <h6 class="detail-section-title">
                                    <i class="bi bi-currency-dollar me-2"></i>Financial Information
                                </h6>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <label>Benefits:</label>
                                        <span class="detail-value">@(string.IsNullOrWhiteSpace(selectedScholarship.Benefits) ? "Not specified" : selectedScholarship.Benefits)</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Monetary Value:</label>
                                        <span class="detail-value">
                                            @if (selectedScholarship.MonetaryValue.HasValue)
                                            {
                                                <span class="text-success fw-bold">₱@selectedScholarship.MonetaryValue.Value.ToString("N0")</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not specified</span>
                                            }
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Available Slots:</label>
                                        <span class="detail-value">
                                            @(selectedScholarship.SlotsAvailable?.ToString() ?? "Not specified")
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Application Information -->
                            <div class="detail-section">
                                <h6 class="detail-section-title">
                                    <i class="bi bi-calendar-event me-2"></i>Application Information
                                </h6>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <label>Application Deadline:</label>
                                        <span class="detail-value">
                                            @if (selectedScholarship.ApplicationDeadline.HasValue)
                                            {
                                                <span class="text-warning fw-bold">@selectedScholarship.ApplicationDeadline.Value.ToString("MMMM dd, yyyy")</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not specified</span>
                                            }
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <label>External Application URL:</label>
                                        <span class="detail-value">
                                            @if (!string.IsNullOrWhiteSpace(selectedScholarship.ExternalApplicationUrl))
                                            {
                                                <a href="@selectedScholarship.ExternalApplicationUrl" target="_blank" class="text-decoration-none">
                                                    Apply Here <i class="bi bi-box-arrow-up-right ms-1"></i>
                                                </a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not available</span>
                                            }
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Eligibility Requirements -->
                            <div class="detail-section">
                                <h6 class="detail-section-title">
                                    <i class="bi bi-check-circle me-2"></i>Eligibility Requirements
                                </h6>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <label>Minimum GPA:</label>
                                        <span class="detail-value">
                                            @(selectedScholarship.MinimumGPA?.ToString("F2") ?? "Not specified")
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Required Course:</label>
                                        <span class="detail-value">
                                            @(string.IsNullOrWhiteSpace(selectedScholarship.RequiredCourse) ? "Any course" : selectedScholarship.RequiredCourse)
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Required Year Level:</label>
                                        <span class="detail-value">
                                            @if (selectedScholarship.RequiredYearLevel.HasValue)
                                            {
                                                @($"Year {selectedScholarship.RequiredYearLevel.Value}")
                                            }
                                            else
                                            {
                                                <span class="text-muted">Any year level</span>
                                            }
                                        </span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Required University:</label>
                                        <span class="detail-value">
                                            @(string.IsNullOrWhiteSpace(selectedScholarship.RequiredUniversity) ? "Any university" : selectedScholarship.RequiredUniversity)
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Full Description -->
                            @if (!string.IsNullOrWhiteSpace(selectedScholarship.Description))
                            {
                                <div class="detail-section">
                                    <h6 class="detail-section-title">
                                        <i class="bi bi-file-text me-2"></i>Description
                                    </h6>
                                    <div class="detail-description">
                                        @selectedScholarship.Description
                                    </div>
                                </div>
                            }

                            <!-- Requirements -->
                            @if (!string.IsNullOrWhiteSpace(selectedScholarship.Requirements))
                            {
                                <div class="detail-section">
                                    <h6 class="detail-section-title">
                                        <i class="bi bi-list-check me-2"></i>Requirements
                                    </h6>
                                    <div class="detail-description">
                                        @selectedScholarship.Requirements
                                    </div>
                                </div>
                            }

                            <!-- AI Parsing Notes -->
                            @if (selectedScholarship.ParsingNotes.Any())
                            {
                                <div class="detail-section">
                                    <h6 class="detail-section-title">
                                        <i class="bi bi-robot me-2"></i>AI Parsing Notes
                                    </h6>
                                    <div class="parsing-notes">
                                        @foreach (var note in selectedScholarship.ParsingNotes)
                                        {
                                            <span class="badge bg-info me-1">@note</span>
                                        }
                                    </div>
                                </div>
                            }

                            <!-- Raw Text (Collapsible) -->
                            <div class="detail-section">
                                <h6 class="detail-section-title">
                                    <button class="btn btn-link p-0 text-decoration-none" @onclick="ToggleRawText">
                                        <i class="bi bi-@(showRawText ? "chevron-down" : "chevron-right") me-2"></i>Raw Scraped Text
                                    </button>
                                </h6>
                                @if (showRawText)
                                {
                                    <div class="raw-text-container">
                                        <pre class="raw-text">@selectedScholarship.RawText</pre>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Close</button>
                        <button type="button" class="btn btn-primary" @onclick="ExportSingleScholarship">
                            <i class="bi bi-download me-2"></i>Export as CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

</div>

@code {
    private string scholarshipUrl = "";
    private string enhancedScholarshipUrl = "";
    private string institutionName = "";
    private string institutionWebsite = "";
    private string organizationName = "";
    private string organizationWebsite = "";
    private string errorMessage = "";
    private string successMessage = "";
    private bool isLoading = false;
    private int activeTab = 0;
    
    // Statistics
    private int scrapedScholarshipsCount = 0;
    private string lastScrapeTime = "Never";
    private string lastEnhancedScrapeTime = "Never";
    
    // Data Lists
    private List<ScrapedScholarship> scrapedScholarships = new();
    private List<EnhancedScrapedScholarship> enhancedScholarships = new();
    private List<VerifiedInstitution> verifiedInstitutionsList = new();
    private List<VerifiedOrganization> verifiedOrganizationsList = new();
    
    // Selected scholarship for details view
    private EnhancedScrapedScholarship? selectedScholarship = null;
    
    // Data Models
    public class ScrapedScholarship
    {
        public string Title { get; set; } = "";
        public string Source { get; set; } = "";
        public string Amount { get; set; } = "";
        public string DeadlineDate { get; set; } = "";
        public DateTime ScrapedAt { get; set; }
    }
    
    public class VerifiedInstitution
    {
        public string Name { get; set; } = "";
        public string? Website { get; set; }
        public bool IsVerified { get; set; }
        public DateTime VerifiedAt { get; set; }
    }
    
    public class VerifiedOrganization
    {
        public string Name { get; set; } = "";
        public string Website { get; set; } = "";
        public bool IsVerified { get; set; }
        public DateTime VerifiedAt { get; set; }
    }

    private void SetTab(int tab)
    {
        activeTab = tab;
    }

    private void ExportScholarshipData()
    {
        try
        {
            var json = System.Text.Json.JsonSerializer.Serialize(scrapedScholarships, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
            var fileName = $"scholarships-{DateTime.Now:yyyy-MM-dd-HH-mm}.json";
            var fileContent = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(json));
            JSRuntime.InvokeVoidAsync("downloadFile", fileName, fileContent);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to export scholarship data: {ex.Message}";
        }
    }
    
    private void ExportInstitutionData()
    {
        try
        {
            var json = System.Text.Json.JsonSerializer.Serialize(verifiedInstitutionsList, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
            var fileName = $"institutions-{DateTime.Now:yyyy-MM-dd-HH-mm}.json";
            var fileContent = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(json));
            JSRuntime.InvokeVoidAsync("downloadFile", fileName, fileContent);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to export institution data: {ex.Message}";
        }
    }
    
    private void ExportOrganizationData()
    {
        try
        {
            var json = System.Text.Json.JsonSerializer.Serialize(verifiedOrganizationsList, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
            var fileName = $"organizations-{DateTime.Now:yyyy-MM-dd-HH-mm}.json";
            var fileContent = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(json));
            JSRuntime.InvokeVoidAsync("downloadFile", fileName, fileContent);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to export organization data: {ex.Message}";
        }
    }

    private async Task ScrapeScholarships()
    {
        if (string.IsNullOrWhiteSpace(scholarshipUrl))
        {
            errorMessage = "Please enter a valid URL.";
            return;
        }

        isLoading = true;
        errorMessage = "";
        successMessage = "";
        
        try
        {
            var scholarships = await WebScrapingService.ScrapeScholarshipsAsync(scholarshipUrl);
            
            // Convert to our display model
            var newScholarships = scholarships.Select(s => new ScrapedScholarship
            {
                Title = s.Title ?? "Unknown Title",
                Source = new Uri(scholarshipUrl).Host,
                Amount = s.Amount ?? "Not specified",
                DeadlineDate = s.ApplicationDeadline ?? "Not specified",
                ScrapedAt = DateTime.Now
            }).ToList();
            
            scrapedScholarships.AddRange(newScholarships);
            scrapedScholarshipsCount = scholarships.Count;
            lastScrapeTime = DateTime.Now.ToString("MMM dd, HH:mm");
            successMessage = $"Successfully scraped {scholarships.Count} scholarships from {new Uri(scholarshipUrl).Host}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error scraping scholarships");
            errorMessage = $"Failed to scrape scholarships: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task VerifyInstitution()
    {
        if (string.IsNullOrWhiteSpace(institutionName))
        {
            errorMessage = "Please enter an institution name.";
            return;
        }

        isLoading = true;
        errorMessage = "";
        successMessage = "";
        
        try
        {
            var result = await WebScrapingService.VerifyInstitutionAsync(institutionName, institutionWebsite);
            
            verifiedInstitutionsList.Add(new VerifiedInstitution
            {
                Name = institutionName,
                Website = institutionWebsite,
                IsVerified = result.IsVerified,
                VerifiedAt = DateTime.Now
            });
            
            successMessage = $"Institution '{institutionName}' verification completed. Status: {(result.IsVerified ? "✓ Verified" : "✗ Not Verified")}";
            
            // Clear form
            institutionName = "";
            institutionWebsite = "";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error verifying institution");
            errorMessage = $"Failed to verify institution: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }



    private async Task VerifyOrganization()
    {
        if (string.IsNullOrWhiteSpace(organizationName) || string.IsNullOrWhiteSpace(organizationWebsite))
        {
            errorMessage = "Please enter both organization name and website.";
            return;
        }

        isLoading = true;
        errorMessage = "";
        successMessage = "";
        
        try
        {
            var isVerified = await WebScrapingService.VerifyOrganizationAsync(organizationName, organizationWebsite);
            
            verifiedOrganizationsList.Add(new VerifiedOrganization
            {
                Name = organizationName,
                Website = organizationWebsite,
                IsVerified = isVerified,
                VerifiedAt = DateTime.Now
            });
            
            successMessage = $"Organization '{organizationName}' verification completed. Status: {(isVerified ? "✓ Verified" : "✗ Not Verified")}";
            
            // Clear form
            organizationName = "";
            organizationWebsite = "";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error verifying organization");
            errorMessage = $"Failed to verify organization: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    // Enhanced AI Scraping Methods
    private async Task ScrapeWithAI()
    {
        if (string.IsNullOrWhiteSpace(enhancedScholarshipUrl))
        {
            errorMessage = "Please enter a valid URL for AI scraping.";
            return;
        }

        isLoading = true;
        errorMessage = "";
        successMessage = "";
        
        try
        {
            var newScholarships = await EnhancedWebScrapingService.ScrapeAndParseScholarshipsAsync(enhancedScholarshipUrl);
            
            enhancedScholarships.AddRange(newScholarships);
            lastEnhancedScrapeTime = DateTime.Now.ToString("MMM dd, HH:mm");
            successMessage = $"Successfully scraped and parsed {newScholarships.Count} scholarships with AI from {new Uri(enhancedScholarshipUrl).Host}";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in AI-enhanced scraping");
            errorMessage = $"Failed to scrape with AI: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ExportEnhancedCsv()
    {
        try
        {
            var csvContent = await EnhancedWebScrapingService.GenerateScholarshipCsvAsync(enhancedScholarships);
            var fileName = $"ai_scholarships_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            
            // Convert to base64 for download
            var csvBytes = System.Text.Encoding.UTF8.GetBytes(csvContent);
            var base64Content = Convert.ToBase64String(csvBytes);
            
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64Content);
            successMessage = $"Exported {enhancedScholarships.Count} scholarships to CSV file";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exporting enhanced CSV");
            errorMessage = $"Failed to export CSV: {ex.Message}";
        }
    }

    private void ViewScholarshipDetails(EnhancedScrapedScholarship scholarship)
    {
        selectedScholarship = scholarship;
        StateHasChanged();
    }

    // Modal support properties and methods
    private bool showRawText = false;

    private void CloseModal()
    {
        selectedScholarship = null;
        showRawText = false;
        StateHasChanged();
    }

    private void ToggleRawText()
    {
        showRawText = !showRawText;
        StateHasChanged();
    }

    private async Task ExportSingleScholarship()
    {
        if (selectedScholarship == null) return;

        try
        {
            var singleScholarshipList = new List<EnhancedScrapedScholarship> { selectedScholarship };
            var csvContent = await EnhancedWebScrapingService.GenerateScholarshipCsvAsync(singleScholarshipList);
            var fileName = $"scholarship_{selectedScholarship.Title.Replace(" ", "_").Replace("/", "_").Replace("\\", "_")}_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            
            // Convert to base64 for download
            var csvBytes = System.Text.Encoding.UTF8.GetBytes(csvContent);
            var base64Content = Convert.ToBase64String(csvBytes);
            
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64Content);
            successMessage = $"Exported scholarship '{selectedScholarship.Title}' to CSV file";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exporting single scholarship CSV");
            errorMessage = $"Failed to export scholarship CSV: {ex.Message}";
        }
    }

    private string GetSourceHost(string url)
    {
        try
        {
            return new Uri(url).Host;
        }
        catch
        {
            return url;
        }
    }
}

<script>
    window.downloadFile = function(filename, content) {
        const byteCharacters = atob(content);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        
        // Determine content type based on file extension
        let mimeType = 'application/octet-stream';
        if (filename.endsWith('.csv')) {
            mimeType = 'text/csv;charset=utf-8;';
        } else if (filename.endsWith('.json')) {
            mimeType = 'application/json';
        }
        
        const blob = new Blob([byteArray], { type: mimeType });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    };
</script>

<style>
    /* Web Scraping Management Styles */
    .scraping-section {
        margin-bottom: 32px;
    }

    .scraping-card {
        background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        height: 100%;
    }

    .scraping-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #1560d4, #0d387e);
    }

    .scraping-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .scraping-card-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }

    .scraping-card-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
        margin-right: 16px;
        flex-shrink: 0;
    }

    .scraping-card-icon.scholarship { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .scraping-card-icon.institution { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .scraping-card-icon.organization { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .scraping-card-icon.news { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

    .scraping-card-header h5 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2d3748;
        margin: 0 0 4px 0;
    }

    .scraping-card-header p {
        color: #4a5568;
        margin: 0;
        font-size: 0.9rem;
    }

    .scraping-card-body {
        flex: 1;
    }

    .scraping-input {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .scraping-input:focus {
        border-color: #1560d4;
        box-shadow: 0 0 0 3px rgba(21, 96, 212, 0.1);
        outline: none;
    }

    .scraping-actions {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }

    .btn-scraping {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        border: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        text-decoration: none;
    }

    .btn-scraping.btn-primary {
        background: linear-gradient(135deg, #1560d4, #0d387e);
        color: white;
    }

    .btn-scraping.btn-primary:hover {
        background: linear-gradient(135deg, #0d387e, #1560d4);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(21, 96, 212, 0.4);
    }

    .btn-scraping.btn-info {
        background: linear-gradient(135deg, #4299e1, #3182ce);
        color: white;
    }

    .btn-scraping.btn-info:hover {
        background: linear-gradient(135deg, #3182ce, #4299e1);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
    }

    .btn-scraping.btn-warning {
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: white;
    }

    .btn-scraping.btn-warning:hover {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }

    .btn-scraping.btn-success {
        background: linear-gradient(135deg, #48bb78, #38a169);
        color: white;
    }

    .btn-scraping.btn-success:hover {
        background: linear-gradient(135deg, #38a169, #48bb78);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
    }

    .btn-scraping.btn-outline-primary {
        background: transparent;
        border: 2px solid #1560d4;
        color: #1560d4;
    }

    .btn-scraping.btn-outline-primary:hover {
        background: #1560d4;
        color: white;
    }

    .btn-scraping.btn-outline-secondary {
        background: transparent;
        border: 2px solid #6b7280;
        color: #6b7280;
    }

    .btn-scraping.btn-outline-secondary:hover {
        background: #6b7280;
        color: white;
    }

    .scraping-help {
        display: flex;
        align-items: center;
        color: #4a5568;
        font-size: 0.85rem;
    }

    .scraping-stats {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .stat-item {
        background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid rgba(0,0,0,0.05);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #4a5568;
        font-weight: 500;
    }

    .scraped-data-card {
        background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
        position: relative;
        overflow: hidden;
    }

    .scraped-data-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #43e97b, #38f9d7);
    }

    .scraped-data-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }

    .scraped-data-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
        margin-right: 16px;
    }

    .scraped-data-header h5 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2d3748;
        margin: 0 0 4px 0;
    }

    .scraped-data-header p {
        color: #4a5568;
        margin: 0;
        font-size: 0.9rem;
    }

    .data-preview {
        background: #f7fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        margin-bottom: 16px;
        max-height: 400px;
        overflow-y: auto;
    }

    .data-content {
        padding: 16px;
        margin: 0;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85rem;
        line-height: 1.5;
        color: #2d3748;
        background: transparent;
        border: none;
    }

    .data-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #4a5568;
    }

    .empty-state-icon {
        font-size: 4rem;
        color: #cbd5e0;
        margin-bottom: 20px;
    }

    .empty-state h5 {
        color: #2d3748;
        margin-bottom: 12px;
        font-weight: 600;
    }

    .empty-state p {
        margin-bottom: 24px;
        font-size: 1rem;
    }
    
    .scraped-data-section {
        background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid rgba(0,0,0,0.05);
    }
    
    .scraped-data-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 16px;
        flex-wrap: wrap;
        gap: 12px;
    }
    
    .scraped-data-header h5 {
        color: #2d3748;
        font-weight: 600;
        margin: 0;
        flex: 1;
    }
    
    .scraped-data-table {
        margin-bottom: 0;
    }
    
    .scraped-data-table thead th {
        background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        border: none;
        color: #4a5568;
        font-weight: 600;
        padding: 12px;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .scraped-data-table tbody td {
        padding: 12px;
        vertical-align: middle;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .scraped-data-table tbody tr:hover {
        background-color: #f7fafc;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 0.85rem;
    }
    
    .badge {
        font-size: 0.8rem;
        padding: 4px 8px;
    }

    .dashboard-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 32px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .dashboard-tab {
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }

    .dashboard-tab:hover {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        color: white;
        text-decoration: none;
    }

    .dashboard-tab.active {
        background: linear-gradient(135deg, #1560d4, #0d387e);
        box-shadow: 0 4px 12px rgba(21, 96, 212, 0.4);
    }

    @@media (max-width: 768px) {
        .scraping-actions {
            flex-direction: column;
            align-items: stretch;
        }
        
        .btn-scraping {
            justify-content: center;
        }
        
        .dashboard-tabs {
            flex-direction: column;
            gap: 12px;
        }
        
        .dashboard-tab {
            width: 100%;
        }
        
        .data-actions {
            flex-direction: column;
        }
    }

    /* Modal Styles */
    .scholarship-details {
        margin: 0;
    }

    .detail-section {
        margin-bottom: 24px;
        border-radius: 8px;
        background: #f7fafc;
        padding: 16px;
        border: 1px solid #e2e8f0;
    }

    .detail-section-title {
        color: #2d3748;
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        font-size: 1rem;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .detail-item label {
        font-weight: 600;
        color: #4a5568;
        font-size: 0.85rem;
        margin-bottom: 0;
    }

    .detail-value {
        color: #2d3748;
        font-size: 0.95rem;
        word-wrap: break-word;
    }

    .detail-description {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 12px;
        color: #2d3748;
        font-size: 0.95rem;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .parsing-notes {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .raw-text-container {
        margin-top: 8px;
    }

    .raw-text {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 12px;
        font-size: 0.8rem;
        color: #4a5568;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .modal-dialog-scrollable {
        max-height: 90vh;
    }

    @@media (max-width: 576px) {
        .detail-grid {
            grid-template-columns: 1fr;
        }
        
        .modal-dialog {
            margin: 0.5rem;
        }
    }
</style>