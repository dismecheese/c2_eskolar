@inherits LayoutComponentBase
@implements IDisposable

@* Inject necessary services for dependency injection *@
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<IdentityUser> UserManager

@* Import namespaces to access Blazor and Identity components *@
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using c2_eskolar.Components.UI

@* Set the render mode to InteractiveServer, enabling server-side interactivity *@
@rendermode InteractiveServer

@code {
    // --- USER INFORMATION STATE ---
    
    // Stores the display name of the currently signed in user
    private string currentUserName = "Loading...";
    
    // Stores the email of the currently signed in user
    private string currentUserEmail = "";

    // Tracks the current month for the calendar component
    private DateTime currentMonth = new(DateTime.Now.Year, DateTime.Now.Month, 1);

    // --- LIFECYCLE METHODS ---

    // Called when the layout initializes
    protected override async Task OnInitializedAsync()
    {
        // Subscribe to the LocationChanged event to update UI on URL changes
        Navigation.LocationChanged += OnLocationChanged;
        // Asynchronously load the user's information
        await LoadCurrentUser();
    }

    // Loads the currently authenticated user's information
    private async Task LoadCurrentUser()
    {
        try
        {
            // Get the authentication state asynchronously
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                // Get the email from claims
                currentUserEmail = user.Identity.Name ?? "";
                
                // Get the IdentityUser to access more details
                var identityUser = await UserManager.FindByEmailAsync(currentUserEmail);
                
                if (identityUser != null)
                {
                    // Try to get display name from claims first, fallback to email
                    currentUserName = user.FindFirst("DisplayName")?.Value 
                                    ?? user.FindFirst("Name")?.Value 
                                    ?? identityUser.UserName 
                                    ?? currentUserEmail.Split('@')[0]; // Use email prefix as fallback
                }
                else
                {
                    // Fallback if the IdentityUser object is not found
                    currentUserName = currentUserEmail.Split('@')[0];
                }
            }
        }
        catch (Exception ex)
        {
            // Log any errors during user loading
            Console.WriteLine($"Error loading user: {ex.Message}");
            currentUserName = "User";
            currentUserEmail = "";
        }
        
        // Notify the component to re-render with the updated state
        StateHasChanged();
    }

    // Called whenever the route/URL changes (to highlight correct sidebar link)
    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        // Use InvokeAsync to ensure the StateHasChanged call happens on the UI thread
        InvokeAsync(StateHasChanged);
    }

    // Dispose pattern: unsubscribe from events to avoid memory leaks
    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    // --- SIDEBAR NAVIGATION ---

     // Determines the CSS class for a sidebar navigation link based on the current URL
    private string GetSidebarLinkClass(string href)
    {
        var currentPath = Navigation.ToBaseRelativePath(Navigation.Uri).Split('?')[0].TrimEnd('/');
        var linkPath = href.TrimStart('/').TrimEnd('/');
        
        // Debug logging for development purposes
        Console.WriteLine($"[DEBUG] Current path: '{currentPath}', Link path: '{linkPath}'");
        
        // Exact match: Add the 'active' class for an exact path match to highlight the current page
        if (currentPath == linkPath)
        {
            Console.WriteLine($"[DEBUG] MATCH! Applying active class to: {href}");
            return "nav-link d-flex align-items-center gap-2 sidebar-link active";
        }
            
        return "nav-link d-flex align-items-center gap-2 sidebar-link";
    }

    // Navigates to the benefactor's profile page
    private void NavigateToBenefactorProfile()
    {
        Navigation.NavigateTo("/dashboard/benefactor/profile");
    }

    private void CloseSidebar()
    {
        // Close the offcanvas sidebar programmatically
        StateHasChanged();
    }

    // --- CHATBOT STATE ---

    private bool ShowChatbot = false; // Whether chatbot window is visible
    
    private string UserInput = ""; // Current user message text
    
    private List<ChatMessage> Messages = new(); // Chat history

    // Opens the chatbot window and triggers a UI re-render
    private void OpenChatbot()
    {
        ShowChatbot = true;
        StateHasChanged();
    }

    // Closes the chatbot window and triggers a UI re-render
    private void CloseChatbot()
    {
        ShowChatbot = false;
        StateHasChanged();
    }

    // Handles sending a message to the chatbot.
    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(UserInput)) return;

        // Add user's message
        Messages.Add(new ChatMessage { Text = UserInput, IsUser = true });
        var userMessage = UserInput;
        UserInput = "";
        StateHasChanged();

        // TODO: UNCOMMENT WHEN BACKEND AI API IS READY
        /*
        try
        {
            var apiResponse = await CallAIBackend(userMessage);
            Messages.Add(new ChatMessage { Text = apiResponse, IsUser = false });
        }
        catch (Exception ex)
        {
            Messages.Add(new ChatMessage { Text = "Sorry, I'm having trouble connecting right now. Please try again later.", IsUser = false });
            // Log error: Console.WriteLine($"AI API Error: {ex.Message}");
        }
        */

        // --- FRONTEND-ONLY MOCK REPLY (REMOVE WHEN BACKEND IS READY) ---
        await Task.Delay(1000); // Simulate thinking time
        
        var userMessageLower = userMessage.ToLower();
        string response = userMessageLower switch
        {
            var msg when msg.Contains("scholarship") => "I can help you manage institutional scholarships! You can create new scholarships, review applications, or manage existing programs. What would you like to do?",
            var msg when msg.Contains("application") || msg.Contains("apply") => "You can review scholarship applications in your dashboard. Check pending applications, review submitted documents, and manage the selection process.",
            var msg when msg.Contains("help") || msg.Contains("how") => "I'm here to help with your institutional dashboard! I can assist with scholarship management, application reviews, announcements, and platform navigation.",
            var msg when msg.Contains("account") || msg.Contains("profile") => "You can update your institution profile by clicking the profile icon. Make sure your institution information is complete and verified.",
            var msg when msg.Contains("announcement") => "You can create and manage announcements from your dashboard. Keep students informed about new scholarships, deadlines, and important updates.",
            _ => "I understand you're asking about: \"" + userMessage + "\". I can help with scholarship management, application reviews, announcements, and institutional settings. Could you be more specific?"
        };
        
        Messages.Add(new ChatMessage { Text = response, IsUser = false });
        StateHasChanged();
    }

    // TODO: UNCOMMENT AND IMPLEMENT WHEN BACKEND AI API IS READY
    // Placeholder for calling a backend AI service.
    /*
    private async Task<string> CallAIBackend(string userMessage)
    {
        using var client = new HttpClient();
        var requestBody = new
        {
            message = userMessage,
            context = "eSkolar institutional dashboard assistant"
        };
        
        var json = System.Text.Json.JsonSerializer.Serialize(requestBody);
        var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
        
        // Replace with your actual AI API endpoint
        var response = await client.PostAsync("https://your-api-endpoint.com/ai/chat", content);
        response.EnsureSuccessStatusCode();
        
        var responseJson = await response.Content.ReadAsStringAsync();
        var apiResponse = System.Text.Json.JsonSerializer.Deserialize<dynamic>(responseJson);
        
        return apiResponse.response ?? "I'm having trouble processing your request right now.";
    }
    */

    // Handles 'Enter' key press in the chatbot input field to send a message
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }

    // Data model for a single chat message
    public class ChatMessage
    {
        public string Text { get; set; } = ""; // The text content of the message
        public bool IsUser { get; set; } // Flag to determine if the message is from the user or the bot
    }
}

<!-- MAIN LAYOUT UI STRUCTURE   -->

<div class="d-flex min-vh-100">

    <!-- Sidebar (left navigation panel) -->
    <nav class="sidebar d-flex flex-column justify-content-between"
         style="width: 260px; background: linear-gradient(180deg, #1560d4 0%, #0d387e 100%); padding: 2rem 1.5rem 1rem 1.5rem;">
        
        <div>
            <!-- Brand/Logo Section -->
            <div class="sidebar-brand-container text-center">
                <a class="eskolar-logo" href="/">
                    <img src="images/main/eSkolar-White.svg" alt="eSkolar Logo" class="eskolar-logo-img" />
                </a>
            </div>

            <!-- Sidebar Navigation Links -->
            <ul class="nav flex-column gap-1">
                <li class="nav-item">
                    <a href="/dashboard/benefactor" class="@GetSidebarLinkClass("/dashboard/benefactor")">
                        <i class="fa fa-home"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/dashboard/benefactor/scholarships" class="@GetSidebarLinkClass("/dashboard/benefactor/scholarships")">
                        <i class="fa fa-graduation-cap"></i> Scholarships
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/dashboard/benefactor/announcements" class="@GetSidebarLinkClass("/dashboard/benefactor/announcements")">
                        <i class="fa fa-bullhorn"></i> Announcements
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/dashboard/benefactor/partners" class="@GetSidebarLinkClass("/dashboard/benefactor/partners")">
                        <i class="fa fa-handshake"></i> Partners
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/dashboard/benefactor/bookmarks" class="@GetSidebarLinkClass("/dashboard/benefactor/bookmarks")">
                        <i class="fa fa-star"></i> Bookmarks
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/dashboard/benefactor/about" class="@GetSidebarLinkClass("/dashboard/benefactor/about")">
                        <i class="fa fa-info-circle"></i> About
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/dashboard/benefactor/settings" class="@GetSidebarLinkClass("/dashboard/benefactor/settings")">
                        <i class="fa fa-cog"></i> Settings
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/dashboard/benefactor/faqs" class="@GetSidebarLinkClass("/dashboard/benefactor/faqs")">
                        <i class="fa fa-question-circle"></i> FAQs
                    </a>
                </li>
            </ul>
        </div>

        <!-- "Need Help?" Button at Bottom of Sidebar -->
        <button class="help-box-bottom" type="button" @onclick="OpenChatbot">
            <div class="help-box-content">
                <img src="images/NeedHelp.svg" alt="Help" class="help-box-img" />
                <div class="help-box-text">
                    <div class="help-box-title">Need help?</div>
                    <div class="help-box-desc">Having trouble using eSkolar?<br />We're here to assist you!</div>
                </div>
            </div>
        </button>
    </nav>

    <!-- Profile Icon (Top Right Corner) -->
    <button class="dashboard-profile-absolute mt-5" type="button" data-bs-toggle="offcanvas" data-bs-target="#rightSidebar" aria-controls="rightSidebar">
        <svg width="32" height="32" fill="none" viewBox="0 0 24 24">
            <circle cx="12" cy="8" r="4" stroke="#222" stroke-width="2"/>
            <circle cx="12" cy="12" r="11" stroke="#222" stroke-width="2"/>
            <path d="M4 20c1.5-3 5.5-5 8-5s6.5 2 8 5" stroke="#222" stroke-width="2"/>
        </svg>
    </button>

    <!-- Right Sidebar (Bootstrap Offcanvas) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="rightSidebar" aria-labelledby="rightSidebarLabel" data-bs-backdrop="false">
    
        <!-- Header of Right Sidebar -->
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="rightSidebarLabel">Profile</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>

        <!-- Body of Right Sidebar -->
        <div class="offcanvas-body">

            <!-- Profile Section -->
            <div class="sidebar-profile">
                <svg width="32" height="32" fill="none" viewBox="0 0 24 24">
                    <circle cx="12" cy="8" r="4" stroke="#222" stroke-width="2"/>
                    <circle cx="12" cy="12" r="11" stroke="#222" stroke-width="2"/>
                    <path d="M4 20c1.5-3 5.5-5 8-5s6.5 2 8 5" stroke="#222" stroke-width="2"/>
                </svg>
                <div class="sidebar-profile-name">Marzella Capin</div>
                <div class="sidebar-profile-role">Student</div>
                <button class="sidebar-profile-btn" @onclick="NavigateToBenefactorProfile" data-bs-dismiss="offcanvas">Profile</button>
            </div>

            <!-- Calendar Component (Custom Blazor component) -->            
            <div class="sidebar-calendar">
                <DashboardCalendar CurrentMonth="@currentMonth" CurrentMonthChanged="@(m => currentMonth = m)" />
            </div>
    </div>

    <!-- Notifications Section -->
    <div class="sidebar-notifications">
        <div class="sidebar-notifications-header">
            Notifications <span style="float:right;cursor:pointer;">Clear</span>
        </div>
        <div class="sidebar-notification-list">
            @for (int i = 0; i < 3; i++)
            {
                <div class="sidebar-notification">
                    <div class="sidebar-notification-title">Notif Title</div>
                    <div class="sidebar-notification-desc">Short Description Short Description Short Description</div>
                </div>
            }
        </div>
    </div>
  </div>

    <!-- Main Content Area (Body placeholder for pages) -->
    <main class="main-content" style="flex:1; min-width:0; background: #f5f6fa;">
        @Body
    </main>
</div>

<!-- Floating Chatbot Window -->
@if (ShowChatbot)
{
    <div class="chatbot-float-window">
        <!-- Header -->
        <div class="chatbot-header">
            <span>eSkolar Assistant</span>
            <button class="btn-close" @onclick="CloseChatbot" aria-label="Close chatbot">×</button>
        </div>

        <!-- Messages -->
        <div class="chatbot-body">
            @if (!Messages.Any())
            {
                <!-- Initial greeting from chatbot -->
                <div class="chat-message bot">
                    <div class="message-avatar bot">AI</div>
                    <div class="message-bubble bot">
                        Hello! I'm your eSkolar assistant for institutions. How can I help you today? I can assist with scholarship management, application reviews, and platform navigation.
                    </div>
                </div>
            }
            @foreach (var msg in Messages)
            {
                <div class="chat-message @(msg.IsUser ? "user" : "bot")">
                    <div class="message-avatar @(msg.IsUser ? "user" : "bot")">
                        @(msg.IsUser ? "You" : "AI")
                    </div>
                    <div class="message-bubble @(msg.IsUser ? "user" : "bot")">
                        @msg.Text
                    </div>
                </div>
            }
        </div>

        <!-- Input field + send button -->
        <div class="chatbot-input">
            <input @bind="UserInput" @bind:event="oninput" @onkeydown="HandleKeyDown" 
                   placeholder="Type a message..." />
            <button class="chatbot-send-btn" @onclick="SendMessage">
                <i class="fa fa-paper-plane"></i>
            </button>
        </div>
    </div>
}

<!-- JavaScript helper to close Bootstrap offcanvas programmatically -->
<script>
document.addEventListener('click', function(event) {
    const offcanvas = document.getElementById('rightSidebar');
    if (offcanvas && offcanvas.classList.contains('show')) {
        // Ignore clicks inside the offcanvas or on the toggle button
        if (!offcanvas.contains(event.target) && !event.target.matches('[data-bs-toggle="offcanvas"]')) {
            const bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvas);
            if (bsOffcanvas) {
                bsOffcanvas.hide();
            }
        }
    }
});
</script>